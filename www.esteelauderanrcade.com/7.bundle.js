(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{220:function(e,t,s){"use strict";function n(e){return e}function i(e){return e*e}function a(e){return e*(2-e)}function r(e){return e<.5?2*e*e:(4-2*e)*e-1}function o(e){return e*e*e}function h(e){return--e*e*e+1}function l(e){return e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1}function c(e){return e*e*e*e}function u(e){return 1- --e*e*e*e}function d(e){return e<.5?8*e*e*e*e:1-8*--e*e*e*e}function p(e){return e*e*e*e*e}function m(e){return 1+--e*e*e*e*e}function g(e){return e<.5?16*e*e*e*e*e:1+16*--e*e*e*e*e}function v(e){return Math.pow(2,10*(e-1))}function f(e){return 1-Math.pow(2,-10*e)}function _(e){return(e*=2)<1?.5*Math.pow(2,10*(e-1)):.5*(2-Math.pow(2,-10*--e))}s.r(t),s.d(t,"easeLinear",(function(){return n})),s.d(t,"easeInQuad",(function(){return i})),s.d(t,"easeOutQuad",(function(){return a})),s.d(t,"easeInOutQuad",(function(){return r})),s.d(t,"easeInCubic",(function(){return o})),s.d(t,"easeOutCubic",(function(){return h})),s.d(t,"easeInOutCubic",(function(){return l})),s.d(t,"easeInQuart",(function(){return c})),s.d(t,"easeOutQuart",(function(){return u})),s.d(t,"easeInOutQuart",(function(){return d})),s.d(t,"easeInQuint",(function(){return p})),s.d(t,"easeOutQuint",(function(){return m})),s.d(t,"easeInOutQuint",(function(){return g})),s.d(t,"easeInExpo",(function(){return v})),s.d(t,"easeOutExpo",(function(){return f})),s.d(t,"easeInOutExpo",(function(){return _}))},221:function(e,t,s){"use strict";var n=s(220);var i=new class{constructor(){this._realTime=0,this._globalTime=0,this._running=!1,this._tweens=[],this._tweensByTarget=new Map,this._tweensById=new Map,this.timescale=1,this.frame=()=>{const e=performance.now()/1e3;let t=e-this._realTime;this._realTime=e,t>1&&(t=1/60),this._globalTime+=t*this.timescale;const s=this._globalTime;for(const e of this._tweens)e._step(s,t);this._running&&requestAnimationFrame(this.frame)}}get globalTime(){return this._globalTime}registerTween(e){var t;this.getOrCreateTweensForTarget(e.target).push(e),null!==e.id&&(null===(t=this._tweensById.get(e.id))||void 0===t||t.stop(),this._tweensById.set(e.id,e)),1===this._tweens.push(e)&&this.start()}unregisterTween(e){var t=this.getTweensForTarget(e.target);void 0!==t&&(t.splice(t.indexOf(e),1),0===t.length&&this._tweensByTarget.delete(e.target)),null!==e.id&&this._tweensById.delete(e.id);const s=this._tweens.indexOf(e);this._tweens.splice(s,1),0===this._tweens.length&&this.stop()}getTweensForTarget(e){return this._tweensByTarget.get(e)}getTweenForId(e){return this._tweensById.get(e)}getOrCreateTweensForTarget(e){if(!this._tweensByTarget.has(e)){const t=[];return this._tweensByTarget.set(e,t),t}return this._tweensByTarget.get(e)}start(){this._running||(this._running=!0,this._realTime=performance.now()/1e3,requestAnimationFrame(this.frame))}stop(){this._running=!1}};class a{constructor(e,t,s){this.target=e,this.property=t,this.initialValue=e[t],this.deltaValue=s-this.initialValue}apply(e){this.target[this.property]=this.initialValue+this.deltaValue*e}}class r{constructor(e,t,s){this.target=e,this.property=t,this.initialValue=[],this.deltaValue=[];for(let e=0;e<this.initialValue.length;e++)this.deltaValue[e]=s[e]-this.initialValue[e]}apply(e){var t=this.target[this.property];for(let s=0;s<this.initialValue.length;s++)t[s]=this.initialValue[s]+this.deltaValue[s]*e}}class o{constructor(){this._listeners=[]}on(e){-1===this._listeners.indexOf(e)&&this._listeners.push(e)}off(e){const t=this._listeners.indexOf(e);t>-1&&this._listeners.splice(t,1)}release(){this._listeners=[]}emit(e){for(const t of this._listeners)t(e)}}class h{constructor(e){this._easeFunc=n.easeLinear,this._delay=0,this._isRunning=!1,this._onCompleteSignal=new o,this._config=e,this._startTime=i.globalTime,this._interpolators=function(e,t){const s=[];for(const n in t){const i=t[n];let o;o="number"==typeof i?new a(e,n,i):new r(e,n,i),s.push(o)}return s}(e.target,e.properties),this._duration=e.duration,this._delay=e.delayValue,this._easeFunc=e.easeFunc,this.resume()}get target(){return this._config.target}get id(){return this._config.idValue}stop(){this._isRunning&&(this._isRunning=!1,i.unregisterTween(this),this._onCompleteSignal.release())}onComplete(e){this._onCompleteSignal.on(e)}_step(e,t){const s=(e-this._startTime-this._delay)/this._duration;if(s<0)return;const n=Math.min(1,s),i=this._easeFunc(n);for(const e of this._interpolators)e.apply(i);s>=1&&this._complete()}resume(){this._isRunning||(this._isRunning=!0,i.registerTween(this))}_complete(){this._onCompleteSignal.emit(),this.stop()}}class l{constructor(e,t,s=.4){if(this._delay=0,this._easeFunc=n.easeLinear,this._id=null,s<1e-6||isNaN(s))throw new Error("duration must be positive");this._duration=s,this._target=e,this._properties=t}get target(){return this._target}get properties(){return this._properties}get duration(){return this._duration}get delayValue(){return this._delay}get easeFunc(){return this._easeFunc}get idValue(){return this._id}start(){return new h(this)}ease(e){return this._easeFunc=e||this._easeFunc||n.easeLinear,this}delay(e){return this._delay=Math.max(0,e),this}id(e){this._id=e}}const c={Ease:n,to:function(e,t,s){return new l(e,t,s)},stopByTarget:function(e){var t=i.getTweensForTarget(e);if(void 0!==t)for(const e of t)e.stop()},stopById:function(e){var t;null===(t=i.getTweenForId(e))||void 0===t||t.stop()},set timescale(e){i.timescale=e},get timescale(){return i.timescale}};t.a=c},224:function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(1);const i=n.vec3.create(),a=n.mat4.create(),r=(n.mat3.create(),n.mat4.create());class o{constructor(){this._invalid=!0,this.pos=n.vec3.create(),this.dir=n.vec3.create()}unproject(e,t,s=!1){n.mat4.invert(a,t._viewProj),t._parent&&s&&(n.mat4.invert(r,t._parent._wmatrix),n.mat4.multiply(a,r,a)),i[0]=e[0],i[1]=e[1],i[2]=-1,n.vec3.transformMat4(this.pos,i,a),i[2]=1,n.vec3.transformMat4(this.dir,i,a),n.vec3.subtract(this.dir,this.dir,this.pos),n.vec3.normalize(this.dir,this.dir)}invalidate(){this._invalid=!0}}},225:function(e,t,s){"use strict";s.d(t,"b",(function(){return u})),s.d(t,"a",(function(){return d}));var n=s(29),i=s(36),a=s(17);class r extends a.b{constructor(e,t,s,n){super(e,t,s,n),this.textureType=a.a.TEXTURE_CUBE,this._target=34067,e.bindTexture(34067,this.id),this.setFilter(!0)}fromImages(e){var t=this.gl,s=this.format,n=this.internal,i=this.type;this.width=e[0].width,this.height=e[0].height,t.bindTexture(34067,this.id),t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X,0,n,s,i,e[0]),t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_Y,0,n,s,i,e[1]),t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_Z,0,n,s,i,e[2]),t.texImage2D(t.TEXTURE_CUBE_MAP_NEGATIVE_X,0,n,s,i,e[3]),t.texImage2D(t.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,n,s,i,e[4]),t.texImage2D(t.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,n,s,i,e[5])}}var o,h=s(37),l=s(35);!function(e){e[e.CLAMP=0]="CLAMP",e[e.REPEAT=1]="REPEAT",e[e.MIRROR=2]="MIRROR"}(o||(o={}));class c extends n.a{constructor(e,t,s){super(e,s),this.request=t}set request(e){this._request=e}get request(){return this._request}get value(){return this.texture}load(){const e=this.group.lodLevel;this.loadLevelAsync(e)}unload(){}async loadLevelAsync(e){const t=this.group.loader.extTextures,[s,n]=l.a.getCodecForRequest(this._request,t);await this.loadSourceLod(n.lods[e]),await s.decodeLod(n,e,t),this.group.loader.upload(this,n.datas);for(let t=0;t<n.lods[e].files.length;t++)this.group.removeResourceByName(n.lods[e].files[t]);this.resolve(this.texture)}async loadSourceLod(e){const t=[];for(let s=0;s<e.files.length;s++)t.push(Object(h.c)(e.files[s],this.group));const s=await Promise.all(t);return e.buffers=s,s}}class u extends c{constructor(e,t,s){super(e,t,s),this.texture=new i.a(this.group.gl)}}class d extends c{constructor(e,t,s){super(e,t,s),this.texture=new r(this.group.gl)}async loadLevelAsync(e){const t=this.group.loader.extTextures,[s,n]=l.a.getCodecForRequest(this._request,t);for(let e=0;e<n.lods.length;e++)await this.loadSourceLod(n.lods[e]);await s.decodeCube(n,t),this.group.loader.upload(this,n.datas);for(let e=0;e<n.lods.length;e++)for(let t=0;t<n.lods[e].files.length;t++)this.group.removeResourceByName(n.lods[e].files[t]);this.resolve(this.texture)}}},229:function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(14);const i=["WEBGL_compressed_texture_s3tc","MOZ_WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"],a=["WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"],r=["WEBGL_compressed_texture_etc1","WEBKIT_WEBGL_compressed_texture_etc1"],o=["WEBGL_compressed_texture_astc"];class h{constructor(e){this.gl=e,this.dxt=this.pickExtension(i),this.pvr=this.pickExtension(a),this.etc=this.pickExtension(r),this.astc=this.pickExtension(o)}pickExtension(e){let t=null;for(const s of e)if(t=this.gl.getExtension(s),t)break;return t}}var l=s(17),c=s(19);class u{constructor(e){this.gl=e,this.extTextures=new h(e),this.extAniso=e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||e.getExtension("EXT_texture_filter_anisotropic")}upload(e,t){this.gl;const s=e.texture;if(s.textureType!==t.textureType)throw new Error("TexturesLoader::upload() texture type mismatch");switch(s.bind(),s.textureType){case l.a.TEXTURE_2D:this.uploadTexture2D(s,t,0);break;case l.a.TEXTURE_CUBE:this.uploadTextureCube(s,t,0)}}uploadTexture2D(e,t,s=0){this.uploadAllSurfaceLevels(e,t,s,0,e.textureType)}uploadTextureCube(e,t,s=0){for(let n=0;n<6;n++){const i=Object(c.b)(n);this.uploadAllSurfaceLevels(e,t,s,n,i)}}uploadAllSurfaceLevels(e,t,s,n,i){switch(t.datatype){case c.a.RAW_COMPRESSED:this.uploadLevelsCompressed(e,t,s,n,i);break;case c.a.IMAGE:this.uploadLevels(e,t,s,n,i);break;case c.a.RAW:this.uploadLevelsRaw(e,t,s,n,i)}}uploadLevels(e,t,s,n,i){const a=t.sources[s].surfaces[n];for(let e=0;e<a.length;e++)this.gl.texImage2D(i,e,t.internalformat,t.format,t.type,a[e].data)}uploadLevelsRaw(e,t,s,n,i){const a=t.sources[s].surfaces[n];for(let e=0;e<a.length;e++){const s=a[e];this.gl.texImage2D(i,e,t.internalformat,s.width,s.height,0,t.format,t.type,s.data)}}uploadLevelsCompressed(e,t,s,n,i){const a=t.sources[s].surfaces[n];let r=a[0].width,o=a[0].height;for(let e=0;e<a.length;e++){const s=a[e];this.gl.compressedTexImage2D(i,e,t.internalformat,r,o,0,s.data),r=Math.max(1,r>>1),o=Math.max(1,o>>1)}}}class d extends n.a{constructor(e="default",t,s=n.a.default){super(e,s),this._lodLevel=0,this.gl=t,this.loader=new u(t)}set lodLevel(e){this._lodLevel=e}get lodLevel(){return this._lodLevel}}},231:function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(1);const i=n.quat.create(),a=n.quat.create(),r=n.quat.create(),o=n.vec3.create(),h=n.vec3.create(),l=(n.mat4.create(),n.mat4.create());var c;!function(e){e[e.NONE=-1]="NONE",e[e.IDLE=0]="IDLE",e[e.ORBIT=1]="ORBIT",e[e.PAN=2]="PAN",e[e.DOLLY=3]="DOLLY"}(c||(c={}));class u{constructor(e){this.onMouseMove=e=>{var t=this._getModeForEvt(e);this.setMode(t),function(e,t,s){s[0]=2*e.clientX/(t.width/window.devicePixelRatio)-1,s[1]=-(2*e.clientY/(t.height/window.devicePixelRatio)-1)}(e,this.el,this.mouse),this.action.update(this.mouse)},this.el=e,this.mouse=n.vec3.fromValues(0,0,1),this.cam=null,this.orbitRadius=-10,this.mode=c.NONE}start(e){this.cam=e,this.el.addEventListener("mousemove",this.onMouseMove),this.mode=-1,this.setMode(c.IDLE)}stop(){this.cam=null,this.el.removeEventListener("mousemove",this.onMouseMove)}update(e){}setMode(e){if(this.mode!==e){switch(this.mode=e,e){case c.IDLE:this.action=new d;break;case c.ORBIT:this.action=new p;break;case c.PAN:this.action=new m;break;case c.DOLLY:this.action=new g}this.unproject(o),this.action.start(this.cam,o,this.mouse)}}unproject(e){this.cam.updateMatrix(),n.mat4.invert(l,this.cam.lens._proj),n.vec3.transformMat4(o,this.mouse,l),n.vec3.scale(o,o,this.orbitRadius/o[2]),n.vec3.transformMat4(e,o,this.cam._matrix)}_getModeForEvt(e){return 2!==e.which?c.IDLE:e.altKey?e.ctrlKey?c.DOLLY:c.ORBIT:c.PAN}}class d{start(e,t,s){}update(e){}}class p{constructor(){this.initialX=n.vec3.create(),this.initialR=n.quat.create(),this.initialP=n.vec3.create(),this.startMouse=n.vec3.create(),this.focus=n.vec3.create()}start(e,t,s){this.cam=e,n.vec3.copy(this.initialX,this.cam._matrix),n.vec3.copy(this.startMouse,s),n.quat.copy(this.initialR,e.rotation),n.vec3.subtract(this.initialP,e.position,t),n.vec3.copy(this.focus,t)}update(e){n.vec3.subtract(o,e,this.startMouse),n.quat.setAxisAngle(r,this.initialX,5*o[1]),n.quat.rotateY(a,i,5*-o[0]),n.quat.multiply(a,a,r),n.quat.multiply(this.cam.rotation,a,this.initialR),n.vec3.transformQuat(o,this.initialP,a),n.vec3.add(this.cam.position,this.focus,o),this.cam.invalidate()}}class m{constructor(){this.initialX=n.vec3.create(),this.initialY=n.vec3.create(),this.initialP=n.vec3.create(),this.startMouse=n.vec3.create(),this.focus=n.vec3.create()}start(e,t,s){this.cam=e,n.vec3.copy(this.initialX,this.cam._matrix),n.vec3.copy(this.initialP,this.cam.position),this.initialY[0]=this.cam._matrix[4],this.initialY[1]=this.cam._matrix[5],this.initialY[2]=this.cam._matrix[6],n.vec3.copy(this.startMouse,s),n.vec3.copy(this.focus,t)}update(e){n.vec3.subtract(o,e,this.startMouse),n.vec3.scale(h,this.initialX,10*-o[0]),n.vec3.scaleAndAdd(h,h,this.initialY,10*-o[1]),n.vec3.add(this.cam.position,this.initialP,h),this.cam.invalidate()}}class g{constructor(){this.initialZ=n.vec3.create(),this.initialP=n.vec3.create(),this.startMouse=n.vec3.create(),this.focus=n.vec3.create()}start(e,t,s){this.cam=e,n.vec3.copy(this.initialP,this.cam.position),n.vec3.subtract(this.initialZ,this.cam.position,t),n.vec3.copy(this.startMouse,s),n.vec3.copy(this.focus,t)}update(e){n.vec3.subtract(o,e,this.startMouse),n.vec3.scale(o,this.initialZ,5*o[1]),n.vec3.add(this.cam.position,this.initialP,o),this.cam.invalidate()}}},233:function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(78),i=s(224),a=s(1);const r=a.mat4.create(),o=new Float32Array(4),h=new Float32Array(4),l=new i.a;class c{constructor(e){this.onTouchEnd=()=>{this.touch.onEnd.off(this.onTouchEnd),this.onLost.emit(),this.active=!1,this.touch=null},this.touchPos=new Float32Array(3),this.touchWPos=new Float32Array(3),this.onPicked=new n.a,this.onLost=new n.a,this.picking=e,this.touch=null,this.active=!1}_updatePos(e){this.touchWPos[0]=e[0],this.touchWPos[1]=e[1],this.touchWPos[2]=e[2],a.mat4.invert(r,this.picking.node._wmatrix),a.vec3.transformMat4(this.touchPos,this.touchWPos,r)}_picked(e,t){this.touch&&this.onTouchEnd(),this._updatePos(t),this.touch=e,this.active=!0,e.onEnd.on(this.onTouchEnd),this.onPicked.emit()}}class u{constructor(e){this.onTouchAdded=e=>{l.unproject(e.coords,this.scene.camera),h.set([0,0,0,1e4]);for(var t=null,s=0;s<this.pickables.length;s++){0!==this.pickables[s].picking.raycast(l,o)&&h[3]>o[3]&&(t=this.pickables[s],h.set(o))}null!==t&&t._picked(e,h)},this.onTouchRemoved=e=>{},this.scene=e,this.pickables=[],this.inputs=this.scene.inputs,this.inputs.onTouchAdded.on(this.onTouchAdded),this.inputs.onTouchRemoved.on(this.onTouchRemoved)}registerPicking(e){for(var t=0;t<this.pickables.length;t++)if(this.pickables[t].picking===e)return this.pickables[t];var s=new c(e);return this.pickables.push(s),s}dispose(){this.inputs.onTouchAdded.off(this.onTouchAdded),this.inputs.onTouchRemoved.off(this.onTouchRemoved)}}},235:function(e,t,s){"use strict";var n,i;s.d(t,"b",(function(){return a})),s.d(t,"a",(function(){return r})),function(e){e[e.CLAMP=0]="CLAMP",e[e.REPEAT=1]="REPEAT",e[e.MIRROR=2]="MIRROR"}(n||(n={})),function(e){e[e.NEAREST=9728]="NEAREST",e[e.LINEAR=9729]="LINEAR",e[e.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",e[e.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",e[e.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",e[e.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"}(i||(i={}));class a{constructor(e){"string"==typeof e&&(e={std:e}),this.sources=[];for(const t in e){const s=e[t];this.sources.push({codec:t,lods:[{files:[s],buffers:null}],datas:null})}}}class r{constructor(e){this.sources=[];for(const t in e){let s=[];for(let n=0;n<e[t].length;n++)s.push({files:[e[t][n]],buffers:null});this.sources.push({codec:t,lods:s,datas:null})}}}},236:function(e,t){var s=function(e){return"attribute vec2 aPosition;\nattribute vec2 aTexCoord;\n\nvarying vec2 vTexCoord0;\n\n  \nvoid main( void ){\n\n  gl_Position = vec4( aPosition, 0.0, 1.0 );\n  vTexCoord0 = aTexCoord;\n\n}\n","attribute vec2 aPosition;\nattribute vec2 aTexCoord;\n\nvarying vec2 vTexCoord0;\n\n  \nvoid main( void ){\n\n  gl_Position = vec4( aPosition, 0.0, 1.0 );\n  vTexCoord0 = aTexCoord;\n\n}\n"};s.toString=s,e.exports=s},237:function(e,t){var s=function(e){return"\nvarying vec2 vTexCoord0;\n\nuniform sampler2D tTex;\n\nvoid main(void){\n  \n  vec4 tex = texture2D( tTex, vTexCoord0 );\n  gl_FragColor.rgb = tex.rgb;\n  gl_FragColor.a = tex.a;\n  // gl_FragColor.rgb = vec3(tex.a);\n  // gl_FragColor.a = 1.0;\n\n}\n","\nvarying vec2 vTexCoord0;\n\nuniform sampler2D tTex;\n\nvoid main(void){\n  \n  vec4 tex = texture2D( tTex, vTexCoord0 );\n  gl_FragColor.rgb = tex.rgb;\n  gl_FragColor.a = tex.a;\n  // gl_FragColor.rgb = vec3(tex.a);\n  // gl_FragColor.a = 1.0;\n\n}\n"};s.toString=s,e.exports=s},248:function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(1),i=s(81);const a=n.vec4.create(),r=n.vec3.create(),o=n.vec3.create(),h=n.vec3.create(),l=n.vec4.create(),c=n.vec3.create(),u=n.vec3.create(),d=n.vec3.create(),p=n.vec3.create();class m{constructor(e){this._length=0,this._invalids=[],this.alloc(e),this._lengthsSumsInvalid=!0,this._inversionRef=0}get numAnchors(){return this._length}get numSegments(){return this._length-3}setAnchors(e,t){var s=e.length,n=s>>2;n!=this._length&&this.alloc(n);for(var i=0;i<s;i++)this._anchors[i]=e[i];for(i=0;i<n-3;i++)this._updateV(i);this.computeNormals(t)}setAnchor3(e,t){a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=0,this.setAnchor(a,t)}setAnchor(e,t){var s=t<<2;this._anchors[s++]=e[0],this._anchors[s++]=e[1],this._anchors[s++]=e[2],this._anchors[s++]=e[3],this.invalidateAt(t)}setNormal(e,t){var s=3*t;this._snormals[s++]=e[0],this._snormals[s++]=e[1],this._snormals[s++]=e[2],this.invalidateAt(t)}posToTime(e){for(var t=0,s=this.getLenghtSums(),n=s.length,i=0;i<n;i++)if(e<(t=s[i]))return i+1-(t-e)/this._lengths[i];return-1}timeToPos(e){var t=this.getLenghtSums(),s=Math.floor(e),n=e-s,i=this._lengths;return 0==s?n*i[s]:t[s-1]+n*i[s]}getLenghtSums(){if(this._lengthsSumsInvalid){for(var e=this._lengths,t=this._lengthsSums,s=e.length,n=0,i=0;i<s;i++)t[i]=n+=e[i];this._lengthsSumsInvalid=!1}return this._lengthsSums}getSize(){var e=this.getLenghtSums();return e[e.length-1]}invalidateAt(e){var t=e;for((e-=3)<0&&(e=0),t>this._length-3&&(t=this._length-3);e<=t;)this.invalidateSeg(e++)}getAnchor(e,t){var s=t<<2;e[0]=this._anchors[s++],e[1]=this._anchors[s++],e[2]=this._anchors[s++],e[3]=this._anchors[s++]}getAnchorV3(e,t){var s=t<<2;e[0]=this._anchors[s++],e[1]=this._anchors[s++],e[2]=this._anchors[s++]}alloc(e){this._length=e,this._anchors=new Float64Array(e<<2),this._normals=new Float32Array(3*e),this._snormals=new Float32Array(this._normals.buffer,12,3*(e-2)),e-=3,this._v=new Float64Array(e<<4),this._lengths=new Float64Array(e),this._lengthsSums=new Float64Array(e),this._iv=new Float32Array(e<<4)}realloc(e){this._length=e;var t=new Float64Array(e<<2),s=new Float32Array(3*e);e-=3;var n=new Float64Array(e<<4),i=new Float64Array(e),a=new Float32Array(e<<4);t.set(this._anchors,0),n.set(this._v,0),a.set(this._iv,0),i.set(this._lengths,0),s.set(this._normals,0),this._anchors=t,this._v=n,this._iv=a,this._lengths=i,this._normals=s,this._snormals=new Float32Array(this._normals.buffer,12,3*(e-2)),this._lengthsSums=new Float64Array(e),this._lengthsSumsInvalid=!0}reallocFromStart(e){var t=e-this._length;this._length=e;var s=new Float64Array(e<<2),n=new Float32Array(3*e);e-=3;var i=new Float64Array(e<<4),a=new Float64Array(e),r=new Float32Array(e<<4);s.set(this._anchors,t<<2),n.set(this._normals,3*t),i.set(this._v,t<<4),r.set(this._iv,t<<4),a.set(this._lengths,t);for(var o=this._invalids,h=o.length,l=0;l<h;l++)o[l]+=t;this._anchors=s,this._v=i,this._iv=r,this._lengths=a,this._normals=n,this._snormals=new Float32Array(this._normals.buffer,12,3*(e-2)),this._lengthsSums=new Float64Array(e),this._lengthsSumsInvalid=!0}shift(e){const t=this._length-Math.abs(e);i.a.isTrue(t>0),e>0?this.copy(this,0,t,e):e<0&&this.copy(this,-e,this._length-1,0)}copy(e,t,s,n){void 0===n&&(n=0);var i=s-t+1,a=t<<2,r=t<<3;e._anchors.set(new Float64Array(this._anchors.buffer,r<<2,i<<2),n<<2),e._normals.set(new Float32Array(this._normals.buffer,3*a,3*i),3*n),i-=3,e._v.set(new Float64Array(this._v.buffer,r<<4,i<<4),n<<4),e._lengths.set(new Float64Array(this._lengths.buffer,r,i),n),e._iv.set(new Float32Array(this._iv.buffer,a<<4,i<<4),n<<4),e._lengthsSumsInvalid=!0}copySeg(e,t,s){console.log("CatmullSpline copyPoint ",t,s);var n=4,i=t<<2,a=t<<3;e._anchors.set(new Float64Array(this._anchors.buffer,a<<2,n<<2),s<<2),e._normals.set(new Float32Array(this._normals.buffer,3*i,3*n),3*s),n-=3,e._v.set(new Float64Array(this._v.buffer,a<<4,n<<4),s<<4),e._lengths.set(new Float64Array(this._lengths.buffer,a,n),s),e._iv.set(new Float32Array(this._iv.buffer,i<<4,n<<4),s<<4),e._lengthsSumsInvalid=!0}dispose(){}invalidateSeg(e){this._lengthsSumsInvalid=!0;var t=this._invalids;-1==t.indexOf(e)&&t.push(e)}getInvalidsSegs(){return this._invalids}compute(){for(var e=this._invalids,t=e.length,s=0;s<t;s++)this._updateV(e[s]);this._invalids=[]}computeAll(){for(var e=(this._anchors.length>>2)-3,t=0;t<e;t++)this._updateV(t);this._invalids=[]}length(){return this._length}getPositionAt(e,t){var s=this._v,n=Math.floor(e);e-=n,n<<=4;var i=e*e,a=e*i;t[0]=s[n+0]+e*s[n+1]+i*s[n+2]+a*s[n+3],t[1]=s[n+4]+e*s[n+5]+i*s[n+6]+a*s[n+7],t[2]=s[n+8]+e*s[n+9]+i*s[n+10]+a*s[n+11],t[3]=s[n+12]+e*s[n+13]+i*s[n+14]+a*s[n+15];const r=2*Math.PI;t[3]>r&&(t[3]-=r),t[3]<-r&&(t[3]+=r)}getPositionAtV3(e,t){var s=this._v,n=Math.floor(e);e-=n,n<<=4;var i=e*e,a=e*i;t[0]=s[n+0]+e*s[n+1]+i*s[n+2]+a*s[n+3],t[1]=s[n+4]+e*s[n+5]+i*s[n+6]+a*s[n+7],t[2]=s[n+8]+e*s[n+9]+i*s[n+10]+a*s[n+11]}getPositionAndTangentAt(e,t,s){var i=this._v,a=Math.floor(e),r=e-a;if((a<<=4)+15>=i.length)throw"";var o=r*r,h=r*o;t[0]=i[a+0]+r*i[a+1]+o*i[a+2]+h*i[a+3],t[1]=i[a+4]+r*i[a+5]+o*i[a+6]+h*i[a+7],t[2]=i[a+8]+r*i[a+9]+o*i[a+10]+h*i[a+11],t[3]=i[a+12]+r*i[a+13]+o*i[a+14]+h*i[a+15],r*=2,o*=3,s[0]=i[a+1]+r*i[a+2]+o*i[a+3],s[1]=i[a+5]+r*i[a+6]+o*i[a+7],s[2]=i[a+9]+r*i[a+10]+o*i[a+11],n.vec3.normalize(s,s);const l=2*Math.PI;t[3]>l&&(t[3]-=l),t[3]<-l&&(t[3]+=l)}getTangentAt(e,t){const s=this._v,i=Math.floor(e)<<4;let a=e-i;const r=a*a*3;a*=2,t[0]=s[i+1]+a*s[i+2]+r*s[i+3],t[1]=s[i+5]+a*s[i+6]+r*s[i+7],t[2]=s[i+9]+a*s[i+10]+r*s[i+11],n.vec3.normalize(t,t)}getCurvatureAt(e,t){const s=this._v,n=Math.floor(e)<<4;const i=6*(e-n);t[0]=2*s[n+2]+i*s[n+3],t[1]=2*s[n+6]+i*s[n+7],t[2]=2*s[n+10]+i*s[n+11]}transformVector(e,t,s){var i=s[0],a=s[1],c=Math.floor(e),u=c+1;c==u&&console.error("CatmullSpline transformVector");var d=e-c,p=1-d;r[0]=this._snormals[3*c]*p+this._snormals[3*u]*d,r[1]=this._snormals[3*c+1]*p+this._snormals[3*u+1]*d,r[2]=this._snormals[3*c+2]*p+this._snormals[3*u+2]*d,n.vec3.normalize(r,r),this.getPositionAndTangentAt(e,l,h),n.vec3.cross(o,r,h);var m=Math.cos(l[3]),g=Math.sin(l[3]),v=o[0]*m-r[0]*g,f=o[1]*m-r[1]*g,_=o[2]*m-r[2]*g,x=o[0]*g+r[0]*m,w=o[1]*g+r[1]*m,T=o[2]*g+r[2]*m;t[0]=i*v+a*x+l[0],t[1]=i*f+a*w+l[1],t[2]=i*_+a*T+l[2]}getTransformAt(e,t){var s=t,i=Math.floor(e),a=i+1,c=e-i,u=1-c;r[0]=this._snormals[3*i]*u+this._snormals[3*a]*c,r[1]=this._snormals[3*i+1]*u+this._snormals[3*a+1]*c,r[2]=this._snormals[3*i+2]*u+this._snormals[3*a+2]*c,n.vec3.normalize(r,r),this.getPositionAndTangentAt(e,l,h),n.vec3.cross(o,r,h),n.vec3.normalize(o,o),n.vec3.cross(r,h,o);var d=Math.cos(l[3]),p=Math.sin(l[3]);s[0]=o[0]*d-r[0]*p,s[1]=o[1]*d-r[1]*p,s[2]=o[2]*d-r[2]*p,s[3]=0,s[4]=o[0]*p+r[0]*d,s[5]=o[1]*p+r[1]*d,s[6]=o[2]*p+r[2]*d,s[7]=0,s[8]=h[0],s[9]=h[1],s[10]=h[2],s[11]=0,s[12]=l[0],s[13]=l[1],s[14]=l[2],s[15]=1}_updateV(e){this._lengthsSumsInvalid=!0;const t=this._anchors,s=this._iv,n=this._v;let i=e<<2,a=i+4,r=i+8,o=i+12;var h=e<<4,l=h;var c,u,d,p,m,g,v,f,_,x,w,T,P,C,L,M,b,E;v=s[l]=n[h++]=c=t[a],f=s[l+4]=n[h++]=.5*(-t[i]+t[r]),_=s[l+8]=n[h++]=1*t[i]+-2.5*t[a]+2*t[r]-.5*t[o],x=s[l+12]=n[h++]=-.5*t[i++]+1.5*t[a++]-1.5*t[r++]+.5*t[o++],w=s[l+1]=n[h++]=u=t[a],T=s[l+5]=n[h++]=.5*(-t[i]+t[r]),P=s[l+9]=n[h++]=1*t[i]+-2.5*t[a]+2*t[r]-.5*t[o],C=s[l+13]=n[h++]=-.5*t[i++]+1.5*t[a++]-1.5*t[r++]+.5*t[o++],L=s[l+2]=n[h++]=d=t[a],M=s[l+6]=n[h++]=.5*(-t[i]+t[r]),b=s[l+10]=n[h++]=1*t[i]+-2.5*t[a]+2*t[r]-.5*t[o],E=s[l+14]=n[h++]=-.5*t[i++]+1.5*t[a++]-1.5*t[r++]+.5*t[o++],s[l+3]=n[h++]=t[a],s[l+7]=n[h++]=.5*(-t[i]+t[r]),s[l+11]=n[h++]=1*t[i]+-2.5*t[a]+2*t[r]-.5*t[o],s[l+15]=n[h++]=-.5*t[i]+1.5*t[a]-1.5*t[r]+.5*t[o],c-=p=v+.25*(f+.25*(_+.25*x)),u-=m=w+.25*(T+.25*(P+.25*C)),d-=g=L+.25*(M+.25*(b+.25*E));var R=Math.sqrt(c*c+u*u+d*d);p-=c=v+.5*(f+.5*(_+.5*x)),m-=u=w+.5*(T+.5*(P+.5*C)),g-=d=L+.5*(M+.5*(b+.5*E)),R+=Math.sqrt(p*p+m*m+g*g),c-=p=v+.75*(f+.75*(_+.75*x)),u-=m=w+.75*(T+.75*(P+.75*C)),d-=g=L+.75*(M+.75*(b+.75*E)),R+=Math.sqrt(c*c+u*u+d*d),r=8+(e<<2),p-=t[r],m-=t[r+1],g-=t[r+2],R+=Math.sqrt(p*p+m*m+g*g),this._lengths[e]=R}getAnchorTangent(e,t){const s=this._v;e<this._length-3?(e<<=4,t[0]=this._v[e+1],t[1]=this._v[e+5],t[2]=this._v[e+9]):(e=e-1<<4,t[0]=s[e+1]+2*s[e+2]+3*s[e+3],t[1]=s[e+5]+2*s[e+6]+3*s[e+7],t[2]=s[e+9]+2*s[e+10]+3*s[e+11]),n.vec3.normalize(t,t)}computeNormals(e){var t=n.vec3.create();void 0!==e?n.vec3.copy(t,e):t[1]=1;var s=this._snormals;this.getTangentAt(0,d),n.vec3.cross(u,d,t),n.vec3.cross(t,u,d),s[0]=t[0],s[1]=t[1],s[2]=t[2],this.computeNormalsFrom(1)}computeNormalsFrom(e){if(e<1||e>this._length-1)throw new Error("index out of bounds");const t=c,s=d,i=p,a=this._snormals,r=e-1;t[0]=a[3*r+0],t[1]=a[3*r+1],t[2]=a[3*r+2];for(var o=e;o<this._length-2;o++)this.getAnchorTangent(o,s),this.getAnchorTangent(o-1,i),n.vec3.cross(u,i,t),n.vec3.normalize(u,u),n.vec3.cross(t,u,s),n.vec3.normalize(t,t),a[3*o+0]=t[0],a[3*o+1]=t[1],a[3*o+2]=t[2]}logDataAt(e){console.log("CatmullSpline logDataAt "+e);var t=e+1<<2,s=3*e;console.log("  a0    : ",this._anchors[t],this._anchors[t+1],this._anchors[t+2],this._anchors[t+3]),console.log("  a1    : ",this._anchors[t+4],this._anchors[t+5],this._anchors[t+6],this._anchors[t+7]),console.log("  nrm0  : ",this._normals[s],this._normals[s+1],this._normals[s+2]),console.log("  nrm1  : ",this._normals[s+3],this._normals[s+4],this._normals[s+5])}}},266:function(e,t,s){"use strict";var n=s(1),i=s.n(n);const a=i.a.vec3,r=i.a.mat4,o=i.a.mat3,h=a.create(),l=a.create(),c=a.create(),u=a.create(),d=a.create(),p=r.create(),m=o.create(),g=a.create(),v=a.create();t.a=class{constructor(e,t,s,n){this.node=e,this.indices=t,this.vertices=s,this.doubleSided=!!n,this.pos=new Float32Array(3),this.id=""}raycast(e,t){r.invert(p,this.node._wmatrix),o.fromMat4(m,p),a.transformMat4(g,e.pos,p),a.transformMat3(v,e.dir,m);for(var s,n,i,f,_=g,x=v,w=this.indices,T=this.vertices,P=0;P<w.length;P+=3){s=3*w[P+0],n=3*w[P+1],i=3*w[P+2],h[0]=T[n+0]-T[s+0],h[1]=T[n+1]-T[s+1],h[2]=T[n+2]-T[s+2],l[0]=T[i+0]-T[s+0],l[1]=T[i+1]-T[s+1],l[2]=T[i+2]-T[s+2],a.cross(c,h,l);var C=a.dot(x,c);if(C>0){if(!this.doubleSided)continue;f=1}else{if(!(C<0))continue;f=-1,C=-C}u[0]=_[0]-T[s+0],u[1]=_[1]-T[s+1],u[2]=_[2]-T[s+2],a.cross(d,u,l);var L=f*a.dot(x,d);if(!(L<0)){a.cross(d,h,u);var M=f*a.dot(x,d);if(!(M<0||L+M>C)){var b=-f*a.dot(u,c);if(!(b<0))return a.scaleAndAdd(d,_,x,b/C),a.transformMat4(d,d,this.node._wmatrix),t[0]=d[0],t[1]=d[1],t[2]=d[2],t[3]=b/C,this.pos[0]=d[0],this.pos[1]=d[1],this.pos[2]=d[2],f}}}return 0}getPos(){return this.pos}}},276:function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(76),i=s(77),a=s(277),r=s.n(a),o=s(278),h=s.n(o);class l{constructor(e,t,s=32){var i=e.gl;this.gl=i,this.scene=e,this.blurSamples=s,this.size=t,this.spread=1,this.blurCfg=e.glstate.config().enableCullface(!1).depthMask(!1).enableDepthTest(!1),this.blurPrg=new n.a(i,r()(),h()(),"#define NUM_SAMPLES "+this.blurSamples),this.blurKernelA=new Float32Array(3*this.blurSamples),this.blurKernelB=new Float32Array(3*this.blurSamples),this.computeKernel(this.blurKernelA,!0,1/this.size),this.computeKernel(this.blurKernelB,!1,1/this.size),this.blurA_fbo=this.makeBlurFbo(!0),this.blurB_fbo=this.makeBlurFbo()}process(e){var t=this.blurPrg;this.gl.clearColor(0,0,0,0),this.blurCfg.apply(),t.use(),t.uSpread(this.spread);var s=this.scene.quad;s.attribPointer(t),this.blurA_fbo.bind(),t.tInput(e),t.uKernel(this.blurKernelA),s.render(),this.blurB_fbo.bind(),t.tInput(this.blurA_fbo.getColor()),t.uKernel(this.blurKernelB),s.render()}getBlurredTex(){return this.blurB_fbo.getColorTexture()}getBlurredFbo(){return this.blurB_fbo}makeBlurFbo(e=!1){const t=this.gl,s=new i.a(t);s.bind(),s.attachColor(e?t.RGBA:t.RGB,t.UNSIGNED_BYTE),s.resize(this.size,this.size);const n=s.getColorTexture();return n.bind(),n.clamp(),n.setFilter(!0,!1,!1),s}computeKernel(e,t,s){for(var n=t?0:1,i=t?1:0,a=Math.sqrt(Math.PI),r=0,o=0;o<this.blurSamples;++o){var h=3*o,l=o-Math.round((this.blurSamples-1)/2),c=4*l/this.blurSamples;r+=c=Math.exp(-c*c/2)/a,e[h+n]=l*s,e[h+i]=0,e[h+2]=c}for(o=0;o<this.blurSamples;++o)e[3*o+2]/=r}}},277:function(e,t){var s=function(e){return"precision highp float;\n\n\nattribute vec2 aPosition;\nattribute vec2 aTexCoord;\n\nvarying vec2 vTexCoord;\n\n  \nvoid main( void ){\n\n  gl_Position = vec4( aPosition, 0.0, 1.0 );\n  vTexCoord = aTexCoord;\n\n}\n","precision highp float;\n\n\nattribute vec2 aPosition;\nattribute vec2 aTexCoord;\n\nvarying vec2 vTexCoord;\n\n  \nvoid main( void ){\n\n  gl_Position = vec4( aPosition, 0.0, 1.0 );\n  vTexCoord = aTexCoord;\n\n}\n"};s.toString=s,e.exports=s},278:function(e,t){var s=function(e){return"precision highp float;\n\n\nvarying vec2 vTexCoord;\n\nuniform sampler2D tInput;\nuniform float uSpread;\nuniform vec3 uKernel[NUM_SAMPLES];\n\n\n\nvoid main(void){\n\n  vec3 color = vec3( 0.0 );\n\n  float alpha = .02 + .98*texture2D( tInput, vTexCoord ).a;\n\n  for(int i=0; i<NUM_SAMPLES; ++i)\n  {\n    vec3 kernel = uKernel[i].xyz;\n    color += texture2D( tInput, vTexCoord + kernel.xy * uSpread * alpha ).xyz * kernel.z;\n  }\n\n\n  gl_FragColor = vec4( color, alpha );// * 0.00001 + texture2D( tInput, vTexCoord );\n  \n\n}\n","precision highp float;\n\n\nvarying vec2 vTexCoord;\n\nuniform sampler2D tInput;\nuniform float uSpread;\nuniform vec3 uKernel[NUM_SAMPLES];\n\n\n\nvoid main(void){\n\n  vec3 color = vec3( 0.0 );\n\n  float alpha = .02 + .98*texture2D( tInput, vTexCoord ).a;\n\n  for(int i=0; i<NUM_SAMPLES; ++i)\n  {\n    vec3 kernel = uKernel[i].xyz;\n    color += texture2D( tInput, vTexCoord + kernel.xy * uSpread * alpha ).xyz * kernel.z;\n  }\n\n\n  gl_FragColor = vec4( color, alpha );// * 0.00001 + texture2D( tInput, vTexCoord );\n  \n\n}\n"};s.toString=s,e.exports=s},425:function(e,t,s){var n=function(e){var t="";return t+="#pragma SLOT version\n\n#pragma SLOT definitions\n\n\n#ifndef hasNormals\n  #define hasNormals 1\n#endif \n#ifndef hasTangents\n  #define hasTangents 1\n#endif \n\n#if hasTangents && !hasNormals \n  #pragma error tan but no nrm\n  error\n#endif\n\n#pragma SLOT precision\n\n"+s(75)()+"\n#pragma SLOT pv\n\n\nIN vec3 aPosition;\n#if hasNormals\nIN vec3 aNormal;\n#endif\n#if hasTangents\nIN vec3 aTangent;\n#endif\n\n\nuniform mat4 uWorldMatrix;\nuniform mat4 uVP;\nuniform mat4 uViewMatrix;\n\nstruct VertexData {\n  highp vec3 modelPosition;\n  highp vec3 position;\n  highp vec3 worldPos;\n  #if hasNormals\n    vec3 normal;\n  #endif\n  #if hasTangents\n    vec3 tangent;\n  #endif\n  mat4 worldMatrix;\n};\n\n\nvoid InitVertexData( out VertexData vertex ){\n\n  vertex.position = aPosition;\n  #if hasNormals\n    vertex.normal = aNormal;\n  #endif\n  #if hasTangents\n    vertex.tangent = aTangent;\n  #endif\n\n  vertex.worldMatrix = uWorldMatrix;\n   \n}\n\n#if passMode(DEPTH)\n// Offsets height | width\nuniform vec2 uMaskOffsets;\n#endif\n\n#if passMode(COLOR)\nOUT vec4 vScreenCoords;\n#endif\n\nvoid main( void ){\n\n  #pragma SLOT v\n\n  VertexData vertex;\n  InitVertexData( vertex );\n\n  #pragma SLOT vertex_warp\n\n  #if passMode(DEPTH)\n  vertex.position += vertex.normal * uMaskOffsets.x;\n  vertex.position += vertex.tangent * uMaskOffsets.y * (aTexCoord0.x - 0.5) * 2.0;\n  #endif\n\n  #if passMode(COLOR)\n  vertex.position += vertex.normal * 0.01;\n  #endif\n  vec4 worldPos = vertex.worldMatrix * vec4( vertex.position, 1.0 );\n  vertex.worldPos.xyz = worldPos.xyz / worldPos.w;\n\n\n  #pragma SLOT vertex_warp_world\n\n  gl_Position     = uVP * vec4( vertex.worldPos, 1.0 );\n\n  #if passMode(COLOR)\n  vScreenCoords = gl_Position;\n  #endif\n  \n  \n}"};n.toString=n,e.exports=n},426:function(e,t,s){var n=function(e){var t="";return t+="#pragma SLOT version\n\n#pragma SLOT definitions\n\n#pragma SLOT precision\n\n"+s(74)()+"\n\n#pragma SLOT pf\n\n\n\n// MATH\n// =========\n#define saturate(x) clamp( x, 0.0, 1.0 )\n#define sdot( a, b ) saturate( dot(a,b) )\n\nuniform sampler2D uColor;\n\nvec2 matcap(vec3 eye, vec3 normal) {\n  vec3 reflected = reflect(eye, normal);\n  float m = 2.8284271247461903 * sqrt( reflected.z+1.0 );\n  return reflected.xy / m + 0.5;\n}\n\n#if passMode(COLOR)\nIN vec4 vScreenCoords;\n#endif\n\n//                MAIN\n// ===================\n\n\nvoid main( void ){\n\n  #pragma SLOT f\n\n  vec3 _baseColor = vec3(1.0, 1.0, 1.0);\n  float _alpha = 1.0;\n\n  #if passMode(COLOR)\n    vec2 screenUv = vScreenCoords.xy / vScreenCoords.w;\n    screenUv = screenUv * 0.5 + 0.5;\n    vec3 c = texture2D(uColor, screenUv).rgb;\n    _baseColor *= vec3(0.0, 0.0, 0.0);//texture2D(uColor, screenUv).rgb * 0.65;\n    _alpha = c.r * 1.0;\n  #endif\n\n  #ifdef HAS_vertexColor\n  #if HAS_vertexColor\n    _baseColor *= vertexColor();\n  #endif\n  #endif\n\n  FragColor.xyz = _baseColor;\n \n\n  #if HAS_alpha\n    _alpha *= alpha();\n  #endif\n  #if HAS_alphaFactor\n    _alpha *= alphaFactor();\n  #endif\n\n\n  #if alphaMode( MASK )\n    if( _alpha < alphaCutoff() ) discard;\n    FragColor.a = 1.0;\n  #elif alphaMode( BLEND )\n    FragColor.a = _alpha;\n  #else\n    FragColor.a = 1.0;\n  #endif\n\n  FragColor.a = _alpha;\n\n}"};n.toString=n,e.exports=n},427:function(e,t,s){var n=function(e){var t="";return t+="#pragma SLOT version\n\n#pragma SLOT definitions\n\n\n#ifndef hasNormals\n  #define hasNormals 1\n#endif \n#ifndef hasTangents\n  #define hasTangents 0\n#endif \n\n#if hasTangents && !hasNormals \n  #pragma error tan but no nrm\n  error\n#endif\n\n#pragma SLOT precision\n\n"+s(75)()+"\n#pragma SLOT pv\n\n\nIN vec3 aPosition;\n#if hasNormals\nIN vec3 aNormal;\n#endif\n\n\nuniform mat4 uWorldMatrix;\nuniform mat4 uMVP;\n\nstruct VertexData {\n  highp vec3 modelPosition;\n  highp vec3 position;\n  highp vec3 worldPos;\n  #if hasNormals\n    vec3 normal;\n  #endif\n  #if hasTangents\n    vec3 tangent;\n  #endif\n  mat4 worldMatrix;\n};\n\nvoid InitVertexData( out VertexData vertex ){\n\n  vertex.position = aPosition;\n  #if hasNormals\n    vertex.normal = aNormal;\n  #endif\n  #if hasTangents\n    vertex.tangent = vec3(0.0);\n  #endif\n\n  vertex.worldMatrix = uWorldMatrix;\n   \n}\n\n\nvoid main( void ){\n\n  #pragma SLOT v\n\n  VertexData vertex;\n  InitVertexData( vertex );\n\n  #pragma SLOT vertex_warp\n\n  #pragma SLOT vertex_warp_world\n\n  gl_Position     = uMVP * vec4( vertex.position, 1.0 );\n\n}"};n.toString=n,e.exports=n},428:function(e,t,s){var n=function(e){var t="";return t+="#pragma SLOT version\n\n#pragma SLOT definitions\n\n#pragma SLOT precision\n\n"+s(74)()+"\n\n#pragma SLOT pf\n\n\n// MATH\n// =========\n#define saturate(x) clamp( x, 0.0, 1.0 )\n#define sdot( a, b ) saturate( dot(a,b) )\n\nfloat rand(float n){return fract(sin(n) * 43758.5453123);}\n\nfloat noise(float p){\n\tfloat fl = floor(p);\n  float fc = fract(p);\n\treturn mix(rand(fl), rand(fl + 1.0), fc);\n}\n//                MAIN\n// ===================\n\nvoid main( void ){\n\n  #pragma SLOT f\n\n vec3 _baseColor = vec3(0.45, 0.45, 0.45);\n  #if HAS_baseColor\n    _baseColor *= baseColor();\n  #endif\n\n  float ylevel = texcoord().y;\n  // ylevel -= noise(texcoord().x * 50.0 + time() * 10.0) * ( 0.15 ) * (0.5 + noise(time() * 2.0) * 0.5 ) * 0.0001;\n  _baseColor *= emission().rgb * 1.1;\n  _baseColor *= saturate( smoothstep(1.0, ylevel, 1.0 - emission().a ) );\n  _baseColor *= saturate(ylevel);\n  _baseColor *= saturate((1.0 - texcoord().y) * 3.0);\n\n  FragColor.rgb = _baseColor;\n  FragColor.a = 1.0;\n\n}"};n.toString=n,e.exports=n},429:function(e,t,s){var n=function(e){var t="";return t+="#pragma SLOT version\n\n#pragma SLOT definitions\n\n\n#ifndef hasNormals\n  #define hasNormals 1\n#endif \n#ifndef hasTangents\n  #define hasTangents 0\n#endif \n\n#if hasTangents && !hasNormals \n  #pragma error tan but no nrm\n  error\n#endif\n\n#pragma SLOT precision\n\n"+s(75)()+"\n#pragma SLOT pv\n\n\nIN vec3 aPosition;\n#if hasNormals\nIN vec3 aNormal;\n#endif\n\n\nuniform mat4 uWorldMatrix;\nuniform mat4 uMVP;\n\nstruct VertexData {\n  highp vec3 modelPosition;\n  highp vec3 position;\n  highp vec3 worldPos;\n  #if hasNormals\n    vec3 normal;\n  #endif\n  #if hasTangents\n    vec3 tangent;\n  #endif\n  mat4 worldMatrix;\n};\n\nvoid InitVertexData( out VertexData vertex ){\n\n  vertex.position = aPosition;\n  #if hasNormals\n    vertex.normal = aNormal;\n  #endif\n  #if hasTangents\n    vertex.tangent = vec3(0.0);\n  #endif\n\n  vertex.worldMatrix = uWorldMatrix;\n   \n}\n\n\nvoid main( void ){\n\n  #pragma SLOT v\n\n  VertexData vertex;\n  InitVertexData( vertex );\n\n  #pragma SLOT vertex_warp\n\n  #pragma SLOT vertex_warp_world\n\n  gl_Position     = uMVP * vec4( vertex.position, 1.0 );\n\n}"};n.toString=n,e.exports=n},430:function(e,t,s){var n=function(e){var t="";return t+="#pragma SLOT version\n\n#pragma SLOT definitions\n\n#pragma SLOT precision\n\n"+s(74)()+"\n\n#pragma SLOT pf\n\n\n// MATH\n// =========\n#define saturate(x) clamp( x, 0.0, 1.0 )\n#define sdot( a, b ) saturate( dot(a,b) )\n\nfloat rand(float n){return fract(sin(n) * 43758.5453123);}\n\n\n//                MAIN\n// ===================\n\nvoid main( void ){\n\n  #pragma SLOT f\n\n vec3 _baseColor = mix(vec3(0.8, 0.8, 0.8), baseColor(), emissionMask());\n//   #if HAS_baseColor\n//     _baseColor *= baseColor();\n//   #endif\n\n  FragColor.rgb = _baseColor + emission().rgb * emissionMask() * emission().a;\n  FragColor.a = 1.0;\n\n}"};n.toString=n,e.exports=n},431:function(e,t,s){var n=function(e){var t="";return t+="#pragma SLOT version\n\n#pragma SLOT definitions\n\n\n#ifndef hasNormals\n  #define hasNormals 1\n#endif \n#ifndef hasTangents\n  #define hasTangents 0\n#endif \n\n#if hasTangents && !hasNormals \n  #pragma error tan but no nrm\n  error\n#endif\n\n#pragma SLOT precision\n\n"+s(75)()+"\n#pragma SLOT pv\n\n\nIN vec3 aPosition;\n#if hasNormals\nIN vec3 aNormal;\n#endif\n\n\nuniform mat4 uWorldMatrix;\nuniform mat4 uVP;\nuniform mat4 uViewMatrix;\n\nstruct VertexData {\n  highp vec3 modelPosition;\n  highp vec3 position;\n  highp vec3 worldPos;\n  #if hasNormals\n    vec3 normal;\n  #endif\n  #if hasTangents\n    vec3 tangent;\n  #endif\n  mat4 worldMatrix;\n};\n\nOUT vec3 viewNormal;\n\n#if reflectedPass\nOUT vec3 localPosition;\n#endif\n\nmat3 toMat3(mat4 m4) {\n  return mat3(\n      m4[0][0], m4[0][1], m4[0][2],\n      m4[1][0], m4[1][1], m4[1][2],\n      m4[2][0], m4[2][1], m4[2][2]);\n}\n\n\nvoid InitVertexData( out VertexData vertex ){\n\n  vertex.position = aPosition;\n  #if hasNormals\n    vertex.normal = aNormal;\n  #endif\n  #if hasTangents\n    vertex.tangent = vec3(0.0);\n  #endif\n\n  vertex.worldMatrix = uWorldMatrix;\n   \n}\n\n\nvoid main( void ){\n\n  #pragma SLOT v\n\n  VertexData vertex;\n  InitVertexData( vertex );\n\n  #pragma SLOT vertex_warp\n\n  vec4 worldPos = vertex.worldMatrix * vec4( vertex.position, 1.0 );\n  vertex.worldPos.xyz = worldPos.xyz / worldPos.w;\n\n  #pragma SLOT vertex_warp_world\n\n  mat3 worldM3 = toMat3(vertex.worldMatrix);\n  mat3 viewM3 = toMat3(uViewMatrix);\n  // vec3 worldNormal = normalize(worldM3 * vertex.normal);\n  viewNormal = viewM3 * vertex.normal;\n#if reflectedPass\n  localPosition = aPosition.xyz;\n#endif\n  gl_Position     = uVP * vec4( vertex.worldPos, 1.0 );\n}"};n.toString=n,e.exports=n},432:function(e,t,s){var n=function(e){var t="";return t+="#pragma SLOT version\n\n#pragma SLOT definitions\n\n#pragma SLOT precision\n\n"+s(74)()+"\n\n#pragma SLOT pf\n\n\n\n// MATH\n// =========\n#define saturate(x) clamp( x, 0.0, 1.0 )\n#define sdot( a, b ) saturate( dot(a,b) )\nIN vec3 viewNormal;\nIN float vMorphWeight;\n\n#if reflectedPass\nIN vec3 localPosition;\n#endif\n\nvec2 matcap(vec3 eye, vec3 normal) {\n  vec3 reflected = reflect(eye, normal);\n  float m = 2.8284271247461903 * sqrt( reflected.z+1.0 );\n  return reflected.xy / m + 0.5;\n}\n\n//                MAIN\n// ===================\n\nvoid main( void ){\n\n  #pragma SLOT f\n\n vec3 _baseColor = vec3(1.0, 1.0, 1.0);\n  #if HAS_baseColor\n    _baseColor *= baseColor();\n  #endif\n\n  vec2 matcapUV = viewNormal.xy * 0.5 + 0.5;\n  matcapUV.y = 1.0 - matcapUV.y;\n  matcapUV *= 0.99;\n\n  vec3 color = vec3(0.98, 0.55, 0.32);\n\n  #if reflectedPass\n  float p = 1.0 - saturate(localPosition.y * 9.0) + matcapUV.x * 0.0000001;\n  #ifdef HAS_creamMorph\n    color += vec3(2.0);\n    color = saturate(color);\n    color *= smoothstep(uCreamCfg.w * 0.5, uCreamCfg.w, p);//vec3(, 0.0, 0.0);\n  #endif\n  #endif\n\n  vec3 gold = vec3(0.0, 0.0, 0.0);\n  #if HAS_baseColor\n    color = texture2D(uMatCapCream, matcapUV).rgb;\n  #endif\n  #if HAS_gold\n    gold = texture2D(uMatCapGold, matcapUV).rgb;\n  #endif\n\n  FragColor.xyz = _baseColor;\n \n\n#if HAS_specklesMask\n  float s = specklesMask().b;\n  float n = dot(viewNormal, normalize(vec3(0.0, 0.5, 1.0))) * 2.0;\n  float m = saturate(n * s * vMorphWeight * vMorphWeight);\n  gold = pow( gold, vec3( 0.35 ) );\n  color = mix(color, gold * 1.12, m);\n#endif\n\n  color = pow( color, vec3( 1.25 ) );\n\n  FragColor.rgb = color;\n  FragColor.a = 1.0;\n\n}"};n.toString=n,e.exports=n},433:function(e,t){var s=function(e){var t="";t+="\nfloat morphValue = 0.0;\n\n\nvertex.position.y *= uCreamCfg.z;\n#if hasNormals\n  vertex.normal.y *= uCreamCfg.z;\n#endif\n\nfloat z = vertex.position.z;\nfloat ooffset = 0.1 * (1.0 / spline_params.y);\nfloat coffset = 0.09 * (1.0 / spline_params.y);\n\nmorphValue += smoothstep(uCreamCfg.x, uCreamCfg.x + ooffset, z);\nmorphValue -= smoothstep(uCreamCfg.y + coffset, uCreamCfg.y + coffset + 0.1, z);\n\nmorphValue = clamp(morphValue, 0.0, 1.0);\n\nvMorphWeight = morphValue;\n\n";for(var s=0;s<e.length;s++){t+="\n  ";for(var n=0;n<e[s].attributes.length;n++)t+="\n\nMorphAttribute_"+e[s].name+"(vertex."+e[s].name+", morphValue);\n\n  ";t+="\n"}return t+="\n\nvertex.normal = uNrmScale * vertex.normal;\nvertex.normal = normalize(vertex.normal);\nfloat catmullTime = vertex.position.z * spline_params.y + spline_params.x;\ncatmullWarp( vertex.position, vertex.normal, clamp(catmullTime, 0.0, 0.99 ) );"};s.toString=s,e.exports=s},434:function(e,t){var s=function(e){var t="";t+="#define CMULL_SEGS "+e.num_segs+"\n#define HAS_creamMorph 1\n\nuniform lowp vec2 spline_params; // slide, scale\nuniform lowp vec4 spline_iv[  CMULL_SEGS*4 ];\nuniform mat3 uNrmScale;\n// uniform lowp vec3 spline_nrm[ CMULL_SEGS+1 ];\n\n\n\nvoid catmullWarp( inout vec3 pos, inout vec3 nrm, highp float cmullt ){\n\n  cmullt *= float( CMULL_SEGS );\n  \n  float t = cmullt - floor(cmullt + 0.00001);\n  int i = int(cmullt-t);\n\n  // vec3 nrmA = spline_nrm[i];\n  // vec3 nrmB = spline_nrm[i+1];\n  \n  // vec3 up = normalize( mix( nrmA, nrmB, t ) );\n  vec3 up = vec3(0.0, 1.0, 0.0);\n\n\n  i *= 4;\n\n  vec4 sp1 = spline_iv[ i ];\n  vec4 sp2 = spline_iv[ i + 1 ];\n  vec4 sp3 = spline_iv[ i + 2 ];\n  vec4 sp4 = spline_iv[ i + 3 ];\n  \n  // catmull pos\n  vec4 ppos = t * ( t * ( t * sp4 + sp3 ) + sp2 ) + sp1;\n\n  // catmull tangent\n  // vec3 ptan = t * ( t * ( t * sp4.xyz + sp3.xyz ) + sp2.xyz ) + sp1.xyz;\n  // ptan = normalize( ptan - ppos.xyz );\n\n  vec3 ptan = t * ( t * sp4.xyz * 3.0 + sp3.xyz * 2.0 ) + sp2.xyz;\n  ptan = normalize( ptan );\n\n\n\n  float rcos = cos( ppos.w );\n  float rsin = sin( ppos.w );\n  vec3 cros = normalize( cross( up, ptan ) );\n  up = normalize( cross( ptan, cros ) );\n\n\n  vec3 mvxx = cros*rcos - up*rsin;\n  vec3 mvxy = cros*rsin + up*rcos;\n\n\n  mat3 rotation  = mat3( mvxx, mvxy, ppos ); \n  pos = rotation * vec3( pos.xy, 1.0 );\n\n  rotation[2] = ptan; \n  nrm = rotation * nrm;\n  \n}\n\n\n// uniform mat4 uMorphs;\n// uniform float uFlip;\n// x : morph start\n// y : morph end\n// z : flipped\n// w : fadeDist\nuniform vec4 uCreamCfg;\n\nOUT float vMorphWeight;\n\n";for(var s=0;s<e.morph.length;s++){t+="\n  ";for(var n=0;n<e.morph[s].attributes.length;n++)t+="\n\nIN "+e.morph[s].type+" "+e.morph[s].attributes[n]+";\n\nvoid MorphAttribute_"+e.morph[s].name+"(inout "+e.morph[s].type+" "+e.morph[s].name+", float weight){\n\n  "+e.morph[s].type+" value = "+e.morph[s].attributes[n]+";\n  value.y *= uCreamCfg.z;\n  "+e.morph[s].name+" += value * weight;\n}\n\n  ";t+="\n"}return t+="\n\n"};s.toString=s,e.exports=s},435:function(e,t){var s=function(e){return"#define HAS_creamMorph 1\n// uniform mat4 uMorphs;\n// uniform float uFlip;\n// x : morph start\n// y : morph end\n// z : flipped\n// w : fadeDist\nuniform vec4 uCreamCfg;\n","#define HAS_creamMorph 1\n// uniform mat4 uMorphs;\n// uniform float uFlip;\n// x : morph start\n// y : morph end\n// z : flipped\n// w : fadeDist\nuniform vec4 uCreamCfg;\n"};s.toString=s,e.exports=s},436:function(e,t){var s=function(e){return"attribute vec4 aPosition;\n\nuniform mat4 uMVP;\n\nvoid main(void){\n    gl_PointSize = 10.0;\n    gl_Position = uMVP * vec4(aPosition.xyz, 1.0);\n}","attribute vec4 aPosition;\n\nuniform mat4 uMVP;\n\nvoid main(void){\n    gl_PointSize = 10.0;\n    gl_Position = uMVP * vec4(aPosition.xyz, 1.0);\n}"};s.toString=s,e.exports=s},437:function(e,t){var s=function(e){return"void main(void){\n    gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n}","void main(void){\n    gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n}"};s.toString=s,e.exports=s},438:function(e,t){var s=function(e){return"attribute vec2 aPosition;\nattribute vec2 aTexCoord;\n\nvarying vec2 vTexCoord0;\n\n  \nvoid main( void ){\n\n  gl_Position = vec4( aPosition, 0.0, 1.0 );\n  vTexCoord0 = aTexCoord;\n\n}\n","attribute vec2 aPosition;\nattribute vec2 aTexCoord;\n\nvarying vec2 vTexCoord0;\n\n  \nvoid main( void ){\n\n  gl_Position = vec4( aPosition, 0.0, 1.0 );\n  vTexCoord0 = aTexCoord;\n\n}\n"};s.toString=s,e.exports=s},439:function(e,t){var s=function(e){return"\nvarying vec2 vTexCoord0;\nuniform sampler2D uTex;\nuniform float uWriteFactor;\nuniform float uUVOffset;\n\nvoid main(void){\n\n    vec2 uv = vTexCoord0;\n    uv.x -= 0.001;\n    uv.x = max(0.0, uv.x);\n    float c = texture2D(uTex, uv).r;\n\n    float c2 = 1.0 - (vTexCoord0.x) * 10.0;\n    c2 = clamp(c2, 0.0, 1.0) * uWriteFactor;\n\n    c+= c2;\n\n\n    gl_FragColor = vec4(c);\n    // gl_FragColor.rg = vTexCoord0;\n    // gl_FragColor.ba = vec2(0.0);\n\n}\n","\nvarying vec2 vTexCoord0;\nuniform sampler2D uTex;\nuniform float uWriteFactor;\nuniform float uUVOffset;\n\nvoid main(void){\n\n    vec2 uv = vTexCoord0;\n    uv.x -= 0.001;\n    uv.x = max(0.0, uv.x);\n    float c = texture2D(uTex, uv).r;\n\n    float c2 = 1.0 - (vTexCoord0.x) * 10.0;\n    c2 = clamp(c2, 0.0, 1.0) * uWriteFactor;\n\n    c+= c2;\n\n\n    gl_FragColor = vec4(c);\n    // gl_FragColor.rg = vTexCoord0;\n    // gl_FragColor.ba = vec2(0.0);\n\n}\n"};s.toString=s,e.exports=s},440:function(e,t){var s=function(e){return"attribute vec3 aPosition;\n\nuniform mat4 uMVP;\nvarying vec3 vPos;\n\nvoid main(void){\n\n    gl_Position = uMVP * vec4(aPosition, 1.0);\n    vPos = aPosition.xyz;\n\n}","attribute vec3 aPosition;\n\nuniform mat4 uMVP;\nvarying vec3 vPos;\n\nvoid main(void){\n\n    gl_Position = uMVP * vec4(aPosition, 1.0);\n    vPos = aPosition.xyz;\n\n}"};s.toString=s,e.exports=s},441:function(e,t){var s=function(e){return"varying vec3 vPos;\n\nuniform vec2 uMinMax;\nuniform sampler2D tBlueNoise;\n\nvoid main(void){\n\n    // 33 47 84\n    // 0.129411765    0.184313725     0.329411765\n    vec3 minColor = vec3(0.129411765, 0.184313725, 0.329411765);\n    // 19 20 32\n    // 0.0784313725   0.0784313725    0.125490196   \n    vec3 maxColor = vec3(0.0784313725, 0.0784313725, 0.125490196);\n\n    float l = smoothstep(-uMinMax.x, uMinMax.y, vPos.z);\n\n    float n = texture2D(tBlueNoise, vPos.xz * 2.0).g;\n    l += ( (n - 0.5) * 2.0 ) * 0.05;\n\n    vec3 col = mix(minColor, maxColor, clamp(l, 0.0, 1.0) );\n\n    col = pow( col, vec3( 1.08 ) );\n\n    gl_FragColor = vec4(col, 1.0);\n\n}","varying vec3 vPos;\n\nuniform vec2 uMinMax;\nuniform sampler2D tBlueNoise;\n\nvoid main(void){\n\n    // 33 47 84\n    // 0.129411765    0.184313725     0.329411765\n    vec3 minColor = vec3(0.129411765, 0.184313725, 0.329411765);\n    // 19 20 32\n    // 0.0784313725   0.0784313725    0.125490196   \n    vec3 maxColor = vec3(0.0784313725, 0.0784313725, 0.125490196);\n\n    float l = smoothstep(-uMinMax.x, uMinMax.y, vPos.z);\n\n    float n = texture2D(tBlueNoise, vPos.xz * 2.0).g;\n    l += ( (n - 0.5) * 2.0 ) * 0.05;\n\n    vec3 col = mix(minColor, maxColor, clamp(l, 0.0, 1.0) );\n\n    col = pow( col, vec3( 1.08 ) );\n\n    gl_FragColor = vec4(col, 1.0);\n\n}"};s.toString=s,e.exports=s},442:function(e,t){var s=function(e){return"attribute vec3 aPosition;\nattribute vec3 aWorldPos;\nattribute vec2 aTexCoord;\n\nuniform mat4 uMVP;\nuniform sampler2D tNoise;\nuniform float uTime;\nuniform mat4 uWaves;\n\nvarying vec2 vTexCoord;\nvarying vec4 vConfig;\n\n\nvec2 getWave(vec4 wave){\n\n    float l1 = length(aWorldPos.xz - wave.xy);\n    float sinWave = smoothstep(0.85, 1.0, sin(l1 * 3.0 - uTime * 6.5));\n    sinWave = clamp(sinWave, 0.0, 1.0);\n\n    float dist = clamp((2.0 - l1) / 2.0, 0.0, 1.0);\n\n    float value = sinWave * 2.0 * dist * wave.z;\n    return vec2(value, 0.0);\n\n}\n\nvoid main(void){\n\n    vec3 pos = aPosition.xyz * 0.03 + aWorldPos;\n    gl_Position = uMVP * vec4(pos, 1.0);\n\n    vec3 noise = texture2D(tNoise, aWorldPos.xz * 0.1 + vec2(0.0, uTime * 0.015)).rgb * 1.0;\n\n    float nf = mix(noise.r, noise.g, ( sin(uTime * 0.15) + 1.0 ) * 0.5 );\n    vec2 wave = clamp(getWave(uWaves[0]) + getWave(uWaves[1]) + getWave(uWaves[2]), 0.0, 1.0);\n    nf += wave.x;\n\n    vConfig.xyz = uWaves[3].xyz;\n    vConfig.w = nf;\n\n    vTexCoord = aTexCoord;\n\n}","attribute vec3 aPosition;\nattribute vec3 aWorldPos;\nattribute vec2 aTexCoord;\n\nuniform mat4 uMVP;\nuniform sampler2D tNoise;\nuniform float uTime;\nuniform mat4 uWaves;\n\nvarying vec2 vTexCoord;\nvarying vec4 vConfig;\n\n\nvec2 getWave(vec4 wave){\n\n    float l1 = length(aWorldPos.xz - wave.xy);\n    float sinWave = smoothstep(0.85, 1.0, sin(l1 * 3.0 - uTime * 6.5));\n    sinWave = clamp(sinWave, 0.0, 1.0);\n\n    float dist = clamp((2.0 - l1) / 2.0, 0.0, 1.0);\n\n    float value = sinWave * 2.0 * dist * wave.z;\n    return vec2(value, 0.0);\n\n}\n\nvoid main(void){\n\n    vec3 pos = aPosition.xyz * 0.03 + aWorldPos;\n    gl_Position = uMVP * vec4(pos, 1.0);\n\n    vec3 noise = texture2D(tNoise, aWorldPos.xz * 0.1 + vec2(0.0, uTime * 0.015)).rgb * 1.0;\n\n    float nf = mix(noise.r, noise.g, ( sin(uTime * 0.15) + 1.0 ) * 0.5 );\n    vec2 wave = clamp(getWave(uWaves[0]) + getWave(uWaves[1]) + getWave(uWaves[2]), 0.0, 1.0);\n    nf += wave.x;\n\n    vConfig.xyz = uWaves[3].xyz;\n    vConfig.w = nf;\n\n    vTexCoord = aTexCoord;\n\n}"};s.toString=s,e.exports=s},443:function(e,t){var s=function(e){return"varying vec4 vConfig;\nvarying vec2 vTexCoord;\n// varying float vEnlighten;\n\nvoid main(void){\n\n    float l = length(vTexCoord - vec2(0.5, 0.5)) * 2.0;\n    float alpha = smoothstep(0.6, 0.7, vConfig.w);\n    alpha *= vConfig.w - l;\n\n    vec3 gold = vConfig.xyz;\n\n    gl_FragColor = vec4(gold, clamp(alpha, 0.0, 1.0));\n\n}","varying vec4 vConfig;\nvarying vec2 vTexCoord;\n// varying float vEnlighten;\n\nvoid main(void){\n\n    float l = length(vTexCoord - vec2(0.5, 0.5)) * 2.0;\n    float alpha = smoothstep(0.6, 0.7, vConfig.w);\n    alpha *= vConfig.w - l;\n\n    vec3 gold = vConfig.xyz;\n\n    gl_FragColor = vec4(gold, clamp(alpha, 0.0, 1.0));\n\n}"};s.toString=s,e.exports=s},444:function(e,t){var s=function(e){return"{\n\n    vertex.position *= smoothstep(0.0, 0.05, uProgress * 1.1 - aCenter.w * 0.1);\n    vertex.position *= 1.0 - smoothstep(0.9, 1.0, uProgress * 1.0 + aCenter.w * 0.5);\n\n    float angle = aCenter.w * 10.0 + uProgress * ( 5.0 + aAxis.w * 5.0 );\n    mat3 rot = rotationMatrix(aAxis.xyz, angle);\n    \n    vertex.position = rot * vertex.position;\n    vertex.normal = rot * vertex.normal;\n\n    vec3 offset = aCenter.xyz;\n    offset.x += aAxis.x * aAxis.w * uProgress * 1.3;\n    offset.y += aAxis.y * aAxis.w * sin(uProgress * 3.8) * 2.1;\n    offset.z += aAxis.z * aAxis.w * uProgress * 1.0;\n\n    vertex.position += offset;\n\n}\n","{\n\n    vertex.position *= smoothstep(0.0, 0.05, uProgress * 1.1 - aCenter.w * 0.1);\n    vertex.position *= 1.0 - smoothstep(0.9, 1.0, uProgress * 1.0 + aCenter.w * 0.5);\n\n    float angle = aCenter.w * 10.0 + uProgress * ( 5.0 + aAxis.w * 5.0 );\n    mat3 rot = rotationMatrix(aAxis.xyz, angle);\n    \n    vertex.position = rot * vertex.position;\n    vertex.normal = rot * vertex.normal;\n\n    vec3 offset = aCenter.xyz;\n    offset.x += aAxis.x * aAxis.w * uProgress * 1.3;\n    offset.y += aAxis.y * aAxis.w * sin(uProgress * 3.8) * 2.1;\n    offset.z += aAxis.z * aAxis.w * uProgress * 1.0;\n\n    vertex.position += offset;\n\n}\n"};s.toString=s,e.exports=s},445:function(e,t){var s=function(e){return"IN vec4 aCenter;\nIN vec4 aAxis;\n\nuniform float uTime;\nuniform float uProgress;\n\nmat3 rotationMatrix(vec3 axis, float angle)\n{\n    axis = normalize(axis);\n    float s = sin(angle);\n    float c = cos(angle);\n    float oc = 1.0 - c;\n    \n    return mat3(oc * axis.x * axis.x + c,           oc * axis.x * axis.y - axis.z * s,  oc * axis.z * axis.x + axis.y * s,\n                oc * axis.x * axis.y + axis.z * s,  oc * axis.y * axis.y + c,           oc * axis.y * axis.z - axis.x * s,\n                oc * axis.z * axis.x - axis.y * s,  oc * axis.y * axis.z + axis.x * s,  oc * axis.z * axis.z + c           );\n}","IN vec4 aCenter;\nIN vec4 aAxis;\n\nuniform float uTime;\nuniform float uProgress;\n\nmat3 rotationMatrix(vec3 axis, float angle)\n{\n    axis = normalize(axis);\n    float s = sin(angle);\n    float c = cos(angle);\n    float oc = 1.0 - c;\n    \n    return mat3(oc * axis.x * axis.x + c,           oc * axis.x * axis.y - axis.z * s,  oc * axis.z * axis.x + axis.y * s,\n                oc * axis.x * axis.y + axis.z * s,  oc * axis.y * axis.y + c,           oc * axis.y * axis.z - axis.x * s,\n                oc * axis.z * axis.x - axis.y * s,  oc * axis.y * axis.z + axis.x * s,  oc * axis.z * axis.z + c           );\n}"};s.toString=s,e.exports=s},446:function(e,t,s){e.exports=s.p+"assets/img/logo-smooth-satisfaction-4593cfb6.png"},447:function(e,t,s){e.exports=s.p+"assets/img/poster-game2-rule1-a8a6b94e.jpg"},448:function(e,t,s){e.exports=s.p+"assets/img/poster-game2-rule2-0f4a9ada.jpg"},449:function(e,t,s){e.exports=s.p+"assets/img/poster-game2-rule3-3d6dd3e9.jpg"},450:function(e,t,s){var n={"./share-challenge-game-2-desktop.png":451,"./share-challenge-game-2-mobile.png":452};function i(e){var t=a(e);return s(t)}function a(e){if(!s.o(n,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return n[e]}i.keys=function(){return Object.keys(n)},i.resolve=a,e.exports=i,i.id=450},451:function(e,t,s){e.exports=s.p+"assets/img/share-challenge-game-2-desktop-b6e0fc3e.png"},452:function(e,t,s){e.exports=s.p+"assets/img/share-challenge-game-2-mobile-4e67bbd6.png"},453:function(e,t,s){e.exports=s.p+"assets/img/share-game-2-7d6c2966.png"},454:function(e,t,s){e.exports=s.p+"assets/img/smooth_2-95a33b67.gif"},511:function(e,t,s){"use strict";s.r(t);var n=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",[s("score-ui",{attrs:{active:e.isStarted&&!e.gameState.ended,score:e.gameState.score,health:e.gameState.health,duration:2e3}}),e._v(" "),e.isLoaded?s("scoreboard",{attrs:{"is-game-ended":e.gameState.ended,"game-id":e.gameState.gameId,score:e.finalScore,"product-img":this.getResource("share-product"),"push-img":this.getResource("share-push"),"share-game-img":this.getResource("share-game"),"share-game-canvas-img":this.getResource("share-game-canvas"),"share-label":e.t("gaming.score_name_points"),"share-text-y":225,"share-text-x":3,"game-thumbnails":[this.getResource("game-thumbnail-1"),this.getResource("game-thumbnail-2"),this.getResource("game-thumbnail-3"),this.getResource("game-thumbnail-4")]},on:{onRestart:e.onClickRestart}}):e._e(),e._v(" "),s("instructions-panel",{ref:"loader",attrs:{active:e.instructionActive,onStart:e.onStart,title:e.t("gaming.game2_name"),legends:[e.labelForDesktop("gaming.game2_tuto1","gaming.game2_tuto1_desktop"),e.t("gaming.game2_tuto2"),e.t("gaming.game2_tuto3")],videos:["/assets/video/rules/game2-rule1.mp4","/assets/video/rules/game2-rule2.mp4","/assets/video/rules/game2-rule3.mp4"],posters:[this.getResource("poster-rule1"),this.getResource("poster-rule2"),this.getResource("poster-rule3")],background:this.getResource("game-preview"),logo:this.getResource("game-logo")}}),e._v(" "),e.isLoaded?s("PraiseCvs",{ref:"praise",staticClass:"praise-game-2"}):e._e()],1)};n._withStripped=!0;var i=s(1),a=s(218),r=s(239),o=s(27),h=s(230),l=s(217),c=s(219),u=s(28),d=s(229),p=s(257),m=s(30),g=s(82),v=s(242),f=s(231),_=s(232),x=s(233),w=s(234),T=s(275),P=s(37),C=s(40),L=s(247),M=s(3),b=s(26),E=s(36),R=s(291),S=s(87);const y=["Game2_HDRI_3","Game2_HDRI_2","royal_esplanade_2k","EsteeLauder_Game4_Dev_v1_HDRI"];var A=class{constructor(e){this.EXPO=1.7,this.GAMMA=1/1.8,this.convertSH=e=>{this.shBase=new Float32Array(e,0,27),this.ibl.sh=L.a.convert(this.shBase,this.shMul)};const t=e.gl;this.scene=e,this.gl=t,this.envTex=new E.a(this.gl,this.gl.RGBA),this.envHi=new E.a(this.gl,this.gl.RGBA),this.envBg=new E.a(this.gl,this.gl.RGB),this.ibl=new T.a(this.envTex,this.envHi,this.envBg),this.envTex.setFilter(!1),this.lights=new R.a(e),this.lights.setup.add(this.ibl),this.shMul=1,this.gammaMode=new b.a("gammaMode",S.a),this.gamma=new M.d("gamma",1,M.d.ALL),this.exposure=new M.d("exposure",1,M.d.ALL),this.gammaMode.set("GAMMA_STD"),this.expoUniform=this.exposure.attachUniform("utmExpo"),this.gammaUniform=this.gamma.attachUniform("uTMGamma"),this.expoUniform.set(1.7),this.gammaUniform.set(1/1.8)}setupMat(e){e.setLightSetup(this.lights.setup),e.iGamma&&e.iGamma.proxy(this.gamma),e.iExposure&&e.iExposure.proxy(this.exposure),e.gammaMode&&e.gammaMode.proxy(this.gammaMode)}dispose(){this.envTex.dispose(),this.envHi.dispose(),this.envBg.dispose(),this.envTex=null,this.envHi=null,this.envBg=null,this.ibl=null,this.scene=null,this.shBase=null,this.shMul=1}async loadDefault(){return this.load("envs/"+y[0])}async load(e){return Promise.all([P.d(C.a.asset_url(e+"/env.png")).then(e=>this.envTex.fromImage(e)),P.c(C.a.asset_url(e+"/sh.bin")).then(this.convertSH)])}preRender(){this.lights.preRender()}},O=s(241),I=s(2),D=s(42),k=s(425),F=s.n(k),N=s(426),H=s.n(N),z=s(44),U=s(43),G=s(13),V=s(45),B=s(79);const W=i.mat4.create();class q extends D.a{constructor(e="track-reflect-pass"){super({uid:"track-reflect",vert:F()(),frag:H()()}),this.width=.12,this.height=-.02;const t=this.inputs;t.add(this.texcoord0=new B.a("aTexCoord0",i.mat3.create())),t.add(this.version=new z.a("100")),t.add(this.precision=new U.a("highp")),t.add(this.shaderid=new G.a("id_track-reflect",!0)),t.add(this.alpha=new M.d("alpha",1)),t.add(this.alphaFactor=new M.d("alphaFactor",1)),t.add(this.alphaCutoff=new M.d("alphaCutoff",1)),t.add(this.alphaMode=new b.a("alphaMode",V.a)),t.add(this.alphaMode=new b.a("alphaMode",V.a)),t.add(this.doubleSided=new G.a("doubleSided",!1)),t.add(this.passMode=new b.a("passMode",["COLOR","DEPTH"])),this.offsets=i.vec2.create()}prepare(e,t,s){this.offsets[0]=this.height,this.offsets[1]=this.width,e.uMaskOffsets&&e.uMaskOffsets(this.offsets),e.uColor&&this.colorTex&&e.uColor(this.colorTex),e.uMVP&&(s.modelViewProjectionMatrix(W,t._wmatrix),e.uMVP(W)),e.uViewMatrix&&e.uViewMatrix(s._view),e.uWorldMatrix&&e.uWorldMatrix(t._wmatrix),e.uVP&&e.uVP(s._viewProj),e.uCameraPosition&&e.uCameraPosition(s._wposition)}}var K=s(221),j=s(220);class Y{constructor(e){this.renderables=[],this.extensions=[],this.paths=[],this.pathsE=[],this.scene=e}collectRenderables(e,t){e.renderable&&t.push(e.renderable);for(const s of e._children)this.collectRenderables(s,t)}init(e){this.root=e.getElementByName(I.a.NODE,"Decor"),this.collectRenderables(this.root,this.renderables),this.setupReveal(this.paths,this.root,"Path_Center",i.vec3.fromValues(0,-2,-30)),this.setupReveal(this.paths,this.root,"Path_Left",i.vec3.fromValues(-6.568,-13.033,-7.71)),this.setupReveal(this.paths,this.root,"Path_Right",i.vec3.fromValues(12,-.5,9.367)),this.setupReflector(this.scene.reflectedTrack.blur.getBlurredTex());let t=e.getElementByName(I.a.NODE,"Extensions");this.collectRenderables(t,this.extensions),this.paths[1].root.add(t.findDescendant("Road_L_Extension_1")),this.paths[1].root.add(t.findDescendant("Road_L_Extension_2")),this.paths[1].root.add(t.findDescendant("Roll_L_Extension_1")),this.paths[1].root.add(t.findDescendant("Roll_L_Extension_2")),this.paths[2].root.add(t.findDescendant("Road_R_Extension")),this.paths[2].root.add(t.findDescendant("Roll_R_Extension"))}setupReveal(e,t,s,n){let i=t.findDescendant(s),a={root:i,position:{x:i.x,y:i.y,z:i.z}};a.root.x=n[0],a.root.y=n[1],a.root.z=n[2],e.push(a)}async reveal(){return K.a.to(this.paths[1].root,this.paths[1].position,1.5).ease(j.easeOutCubic).delay(0).start(),K.a.to(this.paths[2].root,this.paths[2].position,1.5).ease(j.easeOutCubic).delay(0).start(),new Promise(e=>{K.a.to(this.paths[0].root,this.paths[0].position,1.5).ease(j.easeOutCubic).delay(.3).start().onComplete(()=>{e()})})}setupReflector(e){const t=this.root.findChild("Path_low").renderable.materials[0];t.removePass(l.a.COLOR),t.removePass(l.a.DEPTH);const s=new q;s.mask=c.a.REFLECTED,s.passMode.set("DEPTH"),s.height=-.03,t.addPass(s,l.a.REFLECT_DEPTH);const n=new q;n.passMode.set("COLOR"),n.mask=c.a.BLENDED,n.colorTex=e,n.glconfig.enableCullface(!0).cullFace(this.scene.gl.BACK).enableDepthTest(!0).depthMask(!1).enableBlend(!0).blendFunc(this.scene.gl.SRC_ALPHA,this.scene.gl.ONE_MINUS_SRC_ALPHA),t.addPass(n,l.a.COLOR),t.inputs.invalidateCode()}preRender(){}render(e,t,s=l.a.DEFAULT,n){for(const i of this.renderables)i.render(this.scene,e,t,s,n);if(this.scene.ratio>.7)for(const i of this.extensions)i.render(this.scene,e,t,s,n)}}var X,Q,$=s(228);!function(e){e.SCENE="decor",e.BARREL_LEFT="Barrel_L",e.BARREL_MIDDLE="Barrel_M",e.BARREL_RIGHT="Barrel_R",e.TOUCHLIGHT_LEFT="TouchLight_L",e.TOUCHLIGHT_MIDDLE="TouchLight_M",e.TOUCHLIGHT_RIGHT="TouchLight_R",e.SPLINE_LEFT="Spline_L",e.SPLINE_MIDDLE="Spline_M",e.SPLINE_RIGHT="Spline_R",e.CREAM_CHUNKS="CreamChunks",e.CHUNK_R_SPIRAL_SHORT="Spiral_R_small",e.CHUNK_R_SPIRAL_MEDIUM="Spiral_R_medium",e.CHUNK_R_SPIRAL_LONG="Spiral_R_large",e.CHUNK_L_SPIRAL_SHORT="Spiral_L_small",e.CHUNK_L_SPIRAL_MEDIUM="Spiral_L_medium",e.CHUNK_L_SPIRAL_LONG="Spiral_L_large",e.CHUNK_C_SPIRAL_SHORT="Spiral_C_small",e.CHUNK_C_SPIRAL_MEDIUM="Spiral_C_medium",e.CHUNK_C_SPIRAL_LONG="Spiral_C_large"}(X||(X={})),function(e){e.LEFT="track-left",e.MIDDLE="track-middle",e.RIGHT="track-right"}(Q||(Q={}));const Z=2.1,J=5.5,ee=45,te=55,se=2.3,ne=.35,ie=.8,ae=1.2,re=2.5;var oe=s(29);class he extends oe.a{constructor(e,t,s){super(e,s),this.url=t}async load(){try{const e=await Object(P.b)(this.url),t=await e.arrayBuffer();return this.resolve(t),t}catch(e){return console.log(e),this.reject(e),null}}unload(){this._abortCtrl.abort()}}var le=s(235),ce=s(225);function ue(e,t,s){let n=new le.b({dxt:C.a.asset_url(t+".png.dxt.ktx"),pvr:C.a.asset_url(t+".png.pvr.ktx"),etc:C.a.asset_url(t+".png.etc.ktx"),std:C.a.asset_url(t+".png")});return new ce.b(s,n,e)}class de{static setupResources(e){new he(X.SPLINE_LEFT,C.a.asset_url("game-2/spline-left.bin"),e),new he(X.SPLINE_MIDDLE,C.a.asset_url("game-2/spline-middle.bin"),e),new he(X.SPLINE_RIGHT,C.a.asset_url("game-2/spline-right.bin"),e)}static setupCmnTexs(e){ue(e,"game-2/Texs/MatCap_Gold","MatCap_Gold"),ue(e,"game-2/Texs/MatCap_Gold_4","MatCap_Gold_4"),ue(e,"game-2/Texs/normal_speckles","speckles-normal"),ue(e,"game-2/Texs/BlueNoise64","blue-noise"),ue(e,"game-2/Texs/noise_dots","noise-dots"),ue(e,"game-2/Texs/grad_ring","grad-ring")}static setupGltfs(e){new $.a(X.SCENE,C.a.asset_url("game-2/Game2Container.gltf"),e),new $.a(X.CREAM_CHUNKS,C.a.asset_url("game-2/CreamChunks.gltf"),e)}static processGltfs(e,t){const s=t.get(X.SCENE);e.root.add(s.root),this.setupLighting(e.iblMngr,s);const n=s.extras.lights;for(let t=0;t<n.list.length;t++)e.iblMngr.lights.registerLight(n.list[t])}static setupLighting(e,t){for(const s of t.materials){const t=s.materialPass;t&&e.setupMat(t)}}}var pe,me=s(248),ge=s(266),ve=s(38);!function(e){e.MUSIC_LOOP="MUSIC_LOOP",e.CLIP_C="CLIP_C",e.CLIP_L="CLIP_L",e.CLIP_R="CLIP_R",e.FLATTEN_LOOP="FLATTEN_LOOP",e.ROLL_FAIL="ROLL_FAIL",e.ROLL_SETUP="ROLL_SETUP",e.ROLL_C_DOWN="ROLL_C_DOWN",e.ROLL_C_UP="ROLL_C_UP",e.ROLL_L_DOWN="ROLL_L_DOWN",e.ROLL_L_UP="ROLL_L_UP",e.ROLL_R_DOWN="ROLL_R_DOWN",e.ROLL_R_UP="ROLL_R_UP",e.CIRCLE_ECHO="CIRCLE_ECHO",e.HALO_APPEARS="HALO_APPEARS",e.FLATTEN_PERFECT="FLATTEN_PERFECT",e.HYPE_WORDS="HYPE_WORDS"}(pe||(pe={}));class fe{constructor(e){this.scene=e,this.isInLowpass=!1,this.lowPassConnected=!1,this._lowpass=0,this.group=this.scene.audioResources,this.context=this.group.audioModule.context,this.masterDest=this.group.audioModule.masterNode,this.masterGain=this.context.createGain(),this.masterGain.connect(this.masterDest),this.lowpassFilter=this.context.createBiquadFilter(),this.lowpassFilter.type="lowpass",this.lowpassFilter.frequency.value=2e3,this.lowpassMaxFreq=this.context.sampleRate/2,this.setupAudioGroup()}async setupAudioGroup(){const e=await Promise.all([new ve.a(pe.MUSIC_LOOP,"game-2/G2_MUSIC_LOOP",this.group).response(),new ve.a(pe.FLATTEN_LOOP,"game-2/G2_FLATTEN_LOOP",this.group).response(),new ve.a(pe.ROLL_FAIL,"game-2/G2_ROLL_FAIL",this.group).response(),new ve.a(pe.ROLL_SETUP,"game-2/G2_ROLL_SETUP_W-CLIPS",this.group).response(),new ve.a(pe.ROLL_C_DOWN,"game-2/G2_ROLL-C_DOWN",this.group).response(),new ve.a(pe.ROLL_C_UP,"game-2/G2_ROLL-C_UP",this.group).response(),new ve.a(pe.ROLL_L_DOWN,"game-2/G2_ROLL-L_DOWN",this.group).response(),new ve.a(pe.ROLL_L_UP,"game-2/G2_ROLL-L_UP",this.group).response(),new ve.a(pe.ROLL_R_DOWN,"game-2/G2_ROLL-R_DOWN",this.group).response(),new ve.a(pe.ROLL_R_UP,"game-2/G2_ROLL-R_UP",this.group).response(),new ve.a(pe.CIRCLE_ECHO,"game-2/G2_CIRCLE_ECHO",this.group).response(),new ve.a(pe.HALO_APPEARS,"game-2/G2_HALO_APPEARS",this.group).response(),new ve.a(pe.FLATTEN_PERFECT,"game-2/G2_FLATTEN_PERFECT",this.group).response(),new ve.a(pe.HYPE_WORDS,"game-2/G2_HYPE_WORDS",this.group).response()]);for(const t of e)t.output=this.masterGain}setLowPassActve(e){this.lowPassConnected!=e&&(this.lowPassConnected=e,this.masterGain.disconnect(),this.lowpassFilter.disconnect(),e?(this.masterGain.connect(this.lowpassFilter),this.lowpassFilter.connect(this.masterDest)):this.masterGain.connect(this.masterDest))}set lowpass(e){this._lowpass=Object(a.d)(e),this.setLowPassActve(e>0);const t=Math.pow(this._lowpass,.2);this.lowpassFilter.frequency.value=this.lowpassMaxFreq*(1-.96*t),this.masterGain.gain.value=1-.6*this._lowpass}get lowpass(){return this._lowpass}setFlatten(e){this.flatten&&this.flatten.gain.gain.setTargetAtTime(e?1:0,0,.2)}playFlatten(){null==this.flatten&&(this.flatten=this.group.get(pe.FLATTEN_LOOP).play(0,!0),this.flatten.node.loopStart=.1,this.flatten.node.loopEnd=3.95)}playMainTrack(){null==this.soundtrack&&(this.soundtrack=this.group.get(pe.MUSIC_LOOP).play(.7,!0),this.soundtrack.node.loopEnd=64.137,this.soundtrack.node.loopStart=10.788)}update(){const e=this.scene.data.gameState.paused||this.scene.data.gameState.ended;this.isInLowpass!=e&&(this.isInLowpass=e,K.a.stopByTarget(this),K.a.to(this,{lowpass:e?1:0},.4).start())}play(e,t=1){this.group.get(e).play(t,!1)}dispose(){var e,t;null===(e=this.flatten)||void 0===e||e.dispose(),this.flatten=null,null===(t=this.soundtrack)||void 0===t||t.dispose(),this.soundtrack=null,this.masterGain.disconnect(),this.lowpassFilter.disconnect()}}const _e=i.vec3.create(),xe={[Q.LEFT]:X.BARREL_LEFT,[Q.MIDDLE]:X.BARREL_MIDDLE,[Q.RIGHT]:X.BARREL_RIGHT},we={[Q.LEFT]:{DOWN:pe.ROLL_L_DOWN,UP:pe.ROLL_L_UP},[Q.MIDDLE]:{DOWN:pe.ROLL_C_DOWN,UP:pe.ROLL_C_UP},[Q.RIGHT]:{DOWN:pe.ROLL_R_DOWN,UP:pe.ROLL_R_UP}};class Te{constructor(e,t){this.renderers=[],this.downTime=2,this.downDuration=.1,this._isDown=!1,this.idleProgress=0,this.idleTime=0,this.idleDuration=.33,this.revealed=!1,this.placed=!1,this.rotationProgress=1,this.prevRot=1;const s=e.ctrl.scene.gltfs.get(X.SCENE);this.track=e,this.scene=e.ctrl.scene,this.trackID=t,this.root=s.getElementByName(I.a.NODE,xe[t]);const n=this.root.findChild("Picking");switch(this.scene.root.add(n),this.idleTime=this.idleDuration,this.idleProgress=1,this.collectRenderables(this.root,this.renderers),this.picking=new ge.a(n,n.mesh.primitives[0].indices._array,n.mesh.primitives[0].attributes.getSemantic("POSITION").accessor._array,!1),this.pickingRenderer=n.renderable,this.idlePos={x:0,y:0,z:0},this.trackID){case Q.RIGHT:this.idlePos.x=2,this.root.x=25;break;case Q.LEFT:this.idlePos.x=-2,this.root.x=-25;break;case Q.MIDDLE:this.idlePos.y=2,this.root.y=5,this.rotationProgress=0,this.prevRot=0}this.cap=this.root.findChild("Cap"),this.planeCap=this.root.findChild("CapPlane")}get isDown(){return this._isDown}set isDown(e){e!=this._isDown&&(e?this.scene.audio.play(we[this.trackID].DOWN):this.scene.audio.play(we[this.trackID].UP)),this._isDown=e}collectRenderables(e,t){e.renderable&&t.push(e.renderable);for(const s of e._children)this.collectRenderables(s,t)}processPicking(e){this.track.lockedTouch||0!==this.picking.raycast(e,_e)&&(this.forceDown=!0)}reveal(e){K.a.to(this.root,this.idlePos,2).ease(j.easeOutQuad).delay(e).start().onComplete(()=>{this.revealed=!0}),1!==this.rotationProgress&&K.a.to(this,{rotationProgress:1},2).ease(j.easeOutQuad).delay(e).start()}preRender(e){if(this.placed||(this.cap.rotateY((this.rotationProgress-this.prevRot)*Math.PI*2),this.prevRot=this.rotationProgress,this.root.invalidate(),this.placed=this.rotationProgress>=1),!this.revealed)return;let t=Date.now()/1e3;this.forceDown&&(this.downTime=t),this.isDown=t-this.downTime<this.downDuration,this.isPressing=this.idleProgress/this.idleDuration<=.05,this.isPressing&&this.cap&&this.cap.rotateX(-e*this.track.speed),this.idleTime+=this.isDown?1.5*-e:1.5*e,this.idleTime=Object(a.c)(this.idleTime,0,this.idleDuration);let s=this.idleTime/this.idleDuration;this.idleProgress=s,s=Object(j.easeInCubic)(s),this.root.x=s*this.idlePos.x,this.root.y=s*this.idlePos.y,this.root.z=s*this.idlePos.z,this.planeCap&&this.planeCap.lookAt(this.scene.camera._wposition)}render(e,t,s=l.a.DEFAULT,n){for(const i of this.renderers)i.render(this.scene,e,t,s,n)}}var Pe=s(427),Ce=s.n(Pe),Le=s(428),Me=s.n(Le);const be=i.mat4.create();class Ee extends D.a{constructor(e="halo-pass"){super({uid:"halo",vert:Ce()(),frag:Me()()}),this.mask=c.a.BLENDED;const t=this.inputs;t.add(this.version=new z.a("100")),t.add(this.precision=new U.a("highp")),t.add(this.shaderid=new G.a("id_halo",!0)),t.add(this.baseColor=new M.d("baseColor",3)),t.add(this.doubleSided=new G.a("doubleSided",!1)),t.add(this.emission=new M.d("emission",4)),t.add(this.texcoord=new M.d("texcoord",2)).attachAttribute("aTexCoord0",2)}prepare(e,t,s){e.uMVP&&(s.modelViewProjectionMatrix(be,t._wmatrix),e.uMVP(be)),e.uWorldMatrix&&e.uWorldMatrix(t._wmatrix),e.uVP&&e.uVP(s._viewProj),e.uCameraPosition&&e.uCameraPosition(s._wposition)}}var Re=s(429),Se=s.n(Re),ye=s(430),Ae=s.n(ye);const Oe=i.mat4.create();class Ie extends D.a{constructor(e="ring-pass"){super({uid:"ring",vert:Se()(),frag:Ae()()}),this.mask=c.a.OPAQUE;const t=this.inputs;t.add(this.version=new z.a("100")),t.add(this.precision=new U.a("highp")),t.add(this.shaderid=new G.a("id_ring",!0)),t.add(this.baseColor=new M.d("baseColor",3)),t.add(this.emission=new M.d("emission",4)),t.add(this.emissionMask=new M.d("emissionMask",1)),t.add(this.texcoord0=new B.a("aTexCoord0",i.mat3.create()))}prepare(e,t,s){e.uMVP&&(s.modelViewProjectionMatrix(Oe,t._wmatrix),e.uMVP(Oe)),e.uWorldMatrix&&e.uWorldMatrix(t._wmatrix),e.uVP&&e.uVP(s._viewProj),e.uCameraPosition&&e.uCameraPosition(s._wposition)}}const De={[Q.LEFT]:X.TOUCHLIGHT_LEFT,[Q.MIDDLE]:X.TOUCHLIGHT_MIDDLE,[Q.RIGHT]:X.TOUCHLIGHT_RIGHT},ke=i.vec3.create(),Fe=i.vec3.fromValues(1,.717647059,.317647059);class Ne{constructor(e,t){this.wasCanPress=!1,this.canPress=!1,this.canPressProgress=0,this.warmupPress=!1,this.warmupProgress=0,this.warningProgress=0,this.revealed=!1,this.scene=e;const s=e.gltfs.get(X.SCENE);this.trackID=t,this.root=s.getElementByName(I.a.NODE,De[t]),this.glass=this.root.findChild("Touch_Glass").renderable,this.ring=this.root.findChild("Touch_Ring").renderable,this.halo=this.root.findChild("halo").renderable,this.emissionHalo=i.vec4.fromValues(1,1,1,0),this.uEmissionHalo=new M.c("uEmission",4),this.uEmissionHalo.set(...this.emissionHalo),this.emissionRing=i.vec4.fromValues(1,1,1,.8),this.uEmissionRing=new M.c("uEmission",4),this.uEmissionRing.set(...this.emissionHalo),this.uTime=new M.c("uTime",1),this.uTime.set(this.time),this.setupRing(),this.setupHalo(),this.time=1e3*Math.random(),this.idleY=this.root.y,this.root.y=-15}reveal(e){return new Promise(t=>{K.a.to(this.root,{y:this.idleY},1).ease(j.easeOutCubic).delay(e).start().onComplete(()=>{this.revealed=!0,t()})})}setupRing(){const e=new Ie("ring-pass");e.mask=c.a.OPAQUE,e.glconfig.enableDepthTest(!0).depthMask(!0).enableCullface(!0).cullFace(this.scene.gl.BACK),e.baseColor.attachConstant(Fe),e.emissionMask.attachSampler("tEmissionMask",e.texcoord0,"g").set(this.scene.cmnTexs.get("grad-ring")),e.emission.attach(this.uEmissionRing),this.ring.materials[0].removePass(l.a.COLOR),this.ring.materials[0].addPass(e,l.a.COLOR)}warningAnim(){K.a.to(this,{warningProgress:1},2.5).start()}setupHalo(){const e=new Ee("halo");e.emission.attach(this.uEmissionHalo,"rgba"),e.glconfig.enableDepthTest(!0).depthMask(!1).enableBlend(!0).blendFunc(this.scene.gl.ONE,this.scene.gl.ONE),this.halo.materials[0].removePass(l.a.COLOR),this.halo.materials[0].addPass(e,l.a.COLOR)}preRender(e){const t=Math.abs(Math.sin(this.warningProgress*Math.PI*3))*(this.isRollerDown?0:1);if(this.revealed&&0!=this.warningProgress){const e=Math.sin(Object(a.d)(3*this.warningProgress)*Math.PI);this.root.y=this.idleY-.08*e}this.warmupPress?this.warmupProgress+=8*e:this.warmupProgress-=15*e,this.warmupProgress=Object(a.d)(this.warmupProgress),this.canPress?this.canPressProgress+=8*e:this.canPressProgress-=15*e,this.canPressProgress=Object(a.d)(this.canPressProgress+t),this.canPress&&!this.wasCanPress&&this.scene.audio.play(pe.HALO_APPEARS),this.wasCanPress=this.canPress;let s=Object(a.d)(.12*this.warmupProgress*(.5*(Math.sin(40*this.time)+1))+1.12*this.canPressProgress);ke[0]=1-t,ke[1]=1-t,ke[2]=1-t,ke[0]*=Fe[0],ke[1]*=Fe[1],ke[2]*=Fe[2],ke[0]+=1*t,this.time+=e,this.emissionHalo[0]=1.1*ke[0],this.emissionHalo[1]=1.1*ke[1],this.emissionHalo[2]=1.1*ke[2],this.emissionHalo[3]=1.7*s,this.uEmissionHalo.set(...this.emissionHalo),this.emissionRing[0]=1.1*ke[0],this.emissionRing[1]=1.1*ke[1],this.emissionRing[2]=1.1*ke[2],this.emissionRing[3]=1.7*(.8+.5*s),this.uEmissionRing.set(...this.emissionRing),1===this.warningProgress&&(this.warningProgress=0)}}const He={[Q.LEFT]:29.64346255384188,[Q.MIDDLE]:28.536751424204528,[Q.RIGHT]:30.732388495206337};class ze{constructor(e,t,s){this.creamChunks=[],this.speed=Z,this.minSpawnDelay=se,this.hasPressed=!1,this.started=!1,this.flattening=!1,this.currentType=null,this.pendingChunk=null,this.lockedTouch=!0,this.id=t,this.ctrl=e;const n=new Float32Array(s);this.spline=new me.a(n.length>>2),this.spline.setAnchors(n),this.spline.computeAll(),this.spline.computeNormals(),this.roller=new Te(this,t),this.touchLight=new Ne(e.scene,t),this.spawnTime=0,this.spawnDelay=this.getSpawnDelay()}get pressPos(){return He[this.id]}start(){this.started=!0,this.fetchNextChunk(),this.spawnDelay=this.getSpawnDelay(),this.spawnTime=0;let e=Object(a.e)(this.ctrl.scene.ratio,.4,1.4,3,-1);this.pendingChunk.splineProgress=Math.max(0,11-this.pendingChunk.segSize+e),this.pushChunk()}reveal(e){return this.roller.reveal(e),this.touchLight.reveal(e+1)}fetchNextChunk(){this.pendingChunk=this.ctrl.chunkPool.fetchNextChunk(this.id,this.currentType),this.pendingChunk.allocate()}pushChunk(){this.currentType=this.pendingChunk.settings.type,this.creamChunks.push(this.pendingChunk),this.pendingChunk=null,this.fetchNextChunk()}getSpawnDelay(){return this.minSpawnDelay+1.75*Math.random()}preRender(e){var t,s;if(this.roller.preRender(e),this.touchLight.preRender(e),0==this.creamChunks.length)return;this.speed+=1*e/ee,this.speed=Math.min(J,this.speed),this.minSpawnDelay-=1*e/te,this.minSpawnDelay=Math.max(ne,this.minSpawnDelay),this.creamChunks[this.creamChunks.length-1].splineProgress>=(null===(t=this.pendingChunk)||void 0===t?void 0:t.settings.segSize)*(null===(s=this.pendingChunk)||void 0===s?void 0:s.settings.meshSize)&&(this.spawnTime+=e,this.spawnTime>=this.spawnDelay&&(this.spawnDelay=this.getSpawnDelay(),this.spawnTime=0,this.pushChunk()));const n=this.ctrl.scene.data.gameState;let i=!1,a=!1,r=null;for(let t=this.creamChunks.length-1;t>=0;t--)a=a||this.creamChunks[t].warmupInRange,i=i||this.creamChunks[t].rollerInRange,r=this.creamChunks[t],0!=r.scoreValue&&(n.score+=r.scoreValue),r.normalizedProgress<1?r.preRender(e):(this.creamChunks[t].release(),this.creamChunks[t]=null,this.creamChunks.splice(t,1));let o=!1;this.flattening=!1,this.roller.isPressing&&(this.flattening=i,this.wasPressing||i||(o=!0,n.health-=1,this.flattening=!1,this.ctrl.scene.audio.play(pe.ROLL_FAIL),0==n.health&&this.ctrl.scene.gameOver()),this.hasPressed=i,this.roller.forceDown=i),this.wasPressing=this.roller.isPressing,this.touchLight.warmupPress=a&&!this.roller.isPressing,this.touchLight.canPress=i&&!this.roller.isDown,this.touchLight.isRollerDown=this.roller.idleProgress<=.3,this.touchLight.canPress&&(this.lockedTouch=!1),o&&this.touchLight.warningAnim()}renderRoller(e,t,s=l.a.DEFAULT,n){this.roller.render(e,t,s,n)}renderCream(e,t,s=l.a.DEFAULT,n){for(const i of this.creamChunks)i.normalizedProgress<1&&i.render(e,t,s,n)}restart(){this.speed=Z,this.minSpawnDelay=se,this.spawnDelay=this.getSpawnDelay();for(let e=this.creamChunks.length-1;e>=0;e--)this.creamChunks[e].release(),this.creamChunks[e]=null,this.creamChunks.splice(e,1);this.fetchNextChunk(),this.pushChunk()}}var Ue=s(224),Ge=s(80),Ve=s(431),Be=s.n(Ve),We=s(432),qe=s.n(We);const Ke=i.mat4.create();class je extends D.a{constructor(e="cream-pass"){super({uid:"cream",vert:Be()(),frag:qe()()});const t=this.inputs;t.add(this.texcoord0=new B.a("aTexCoord0",i.mat3.create())),t.add(this.version=new z.a("100")),t.add(this.precision=new U.a("highp")),t.add(this.shaderid=new G.a("id_cream",!0)),t.add(this.baseColor=new M.d("baseColor",3)),t.add(this.gold=new M.d("gold",3)),t.add(this.specklesMask=new M.d("specklesMask",3)),t.add(this.reflected=new G.a("reflectedPass",!1))}prepare(e,t,s){e.uMVP&&(s.modelViewProjectionMatrix(Ke,t._wmatrix),e.uMVP(Ke)),e.uViewMatrix&&e.uViewMatrix(s._view),e.uWorldMatrix&&e.uWorldMatrix(t._wmatrix),e.uVP&&e.uVP(s._viewProj),e.uCameraPosition&&e.uCameraPosition(s._wposition)}}var Ye=s(7),Xe=s(433),Qe=s.n(Xe),$e=s(434),Ze=s.n($e),Je=s(435),et=s.n(Je);class tt extends Ye.a{constructor(e,t,s){super(!0,!0),this.numSegments=t,this.scale=1,this.offset=0,this._morphInfos=[],function(e){const t=e[0].attributes.length;for(let s=1;s<e.length;s++)if(e[s].attributes.length!==t)throw new Error("MorphDeformer mutiple morph dont have the same size")}(e),this._morphInfos=e,this.morphs=i.mat4.create(),this.creamCfg=i.vec4.create(),this.spline_params=new Float32Array(2),this.spline_iv=null,this.spline_nrm=null,this.nrmScale=i.mat3.create();const n=i.mat4.create();i.mat4.fromScaling(n,i.vec3.fromValues(1,1,s)),i.mat3.fromMat4(this.nrmScale,n)}get numTargets(){return this._morphInfos[0].attributes.length}get morphInfos(){return this._morphInfos}setSpline(e,t=0){this.spline_iv=new Float32Array(e._iv.buffer,16*t*4,16*this.numSegments),this.spline_nrm=new Float32Array(e._normals.buffer,3*t*4,3*this.numSegments+3)}setup(e){this.creamCfg[2]=this.reflected?-1:1,e.uNrmScale(this.nrmScale),e.uCreamCfg(this.creamCfg),this.spline_params[0]=this.offset,this.spline_params[1]=this.scale,e.spline_params(this.spline_params),e.spline_iv(this.spline_iv)}_genCode(e){e.add("vertex_warp",Qe()(this._morphInfos)),e.add("pv",Ze()({morph:this._morphInfos,num_segs:this.numSegments})),e.add("pf",et()())}_getHash(){return"creammrph"}}var st=s(295),nt=s(268);function it(e){if("position"!==e&&"normal"!==e&&"tangent"!==e)throw new Error(`semantic ${e} can't be morphed`)}class at{constructor(e,t){this.splineProgress=0,this.rollerInRange=!1,this.warmupInRange=!1,this.scoreValue=0,this.allocated=!1,this.track=e,this.scene=e.ctrl.scene;const s=this.scene.gltfs.get(X.CREAM_CHUNKS).getElementByName(I.a.MESH,t.meshId);this.settings=t,this.material=this.createMaterial(this.scene,s.primitives[0]),this.root=new nt.a,this.root.mesh=s,this.renderer=new st.a(this.scene.gl,this.root),this.renderer.materials[0]=this.material,this.scene.root.add(this.root),this.splineProgress=0,this.morph={start:1,end:2,started:!1,ended:!1},this.creamMorph.creamCfg[0]=1,this.creamMorph.creamCfg[1]=2,this.scale=t.meshSize*(t.segSize/(t.segSize+1)),this.segSize=t.segSize*t.meshSize}get normalizedProgress(){return this.splineProgress/(this.track.spline.numSegments-this.settings.segSize-2)}get pressPos(){return this.track.pressPos}allocate(){this.allocated=!0}release(){this.splineProgress=0,this.rollerInRange=!1,this.warmupInRange=!1,this.scoreValue=0,this.morph={start:1,end:2,started:!1,ended:!1},this.creamMorph.creamCfg[0]=1,this.creamMorph.creamCfg[1]=2,this.allocated=!1}createMaterial(e,t){const s=e.gl,n=new Ge.a(s);n.glconfig.enableDepthTest(!0).depthMask(!0).enableCullface(!0).cullFace(s.BACK);const i=new je;n.addPass(i,l.a.COLOR),n.mask=c.a.OPAQUE|c.a.REFLECTED,i.baseColor.attachSampler("uMatCapCream",i.texcoord0,"rgb").set(e.cmnTexs.get("MatCap_Gold_4")),i.gold.attachSampler("uMatCapGold",i.texcoord0,"rgb").set(e.cmnTexs.get("MatCap_Gold")),i.version.set(C.a.isWebgl2?"300 es":"100"),i.specklesMask.attachSampler("uSpecklesMask",i.texcoord0,"rgb").set(e.cmnTexs.get("speckles-normal"));const a=new je;a.reflected.set(!0),n.addPass(a,l.a.REFLECT_DEPTH),n.inputs.add(new G.a("hasNormals",!0)),n.inputs.add(new G.a("hasTangents",!0));const r=t.targets[0].attributes,o=[];for(const e of r){const s=t.targets.map(t=>t.getSemantic(e.semantic).glslname),n=e.semantic.toLowerCase();it(n);const i={name:n,type:e.accessor.glslType,attributes:s};o.push(i)}return this.creamMorph=new tt(o,this.settings.segSize+1,this.settings.nrmScale),n.inputs.add(this.creamMorph),n}preRender(e){if(!this.allocated)return;this.splineProgress+=e*this.track.speed;const t=this.splineProgress,s=Math.floor(t),n=t-s,i=ie,r=ae,o=re;this.creamMorph.setSpline(this.track.spline,s),this.creamMorph.scale=this.scale,this.creamMorph.offset=n/(this.settings.segSize+1);let h=(t-this.pressPos+this.segSize)/this.segSize;h=Math.max(0,h);let l=ie/this.segSize,c=t+this.segSize>this.pressPos-i&&t<this.pressPos+r;this.rollerInRange=c;let u=t+this.segSize>this.pressPos-o&&t<this.pressPos+r;this.warmupInRange=u,this.track.roller.isPressing&&!this.morph.started&&c&&(this.morph.end=1-h),this.scoreValue=0;let d=Object(a.d)(this.morph.end+l);this.track.roller.isPressing&&c&&(this.morph.started||(this.scoreValue=d*this.settings.scoreValue),this.morph.started=!0,this.morph.start=1-h),!(t<this.pressPos+r+.5)&&d>=.95&&this.morph.started&&!this.morph.ended&&(this.morph.ended=!0,this.scene.glitterParticles.addSplash(this.track.id)),this.creamMorph.creamCfg[0]=this.morph.start,this.creamMorph.creamCfg[1]=this.morph.end}render(e,t,s=l.a.DEFAULT,n){this.allocated&&(this.creamMorph.reflected=0!=(t&c.a.REFLECTED),this.creamMorph.creamCfg[3]=this.scene.reflectedTrack.fadeDist,this.renderer.render(this.scene,e,t,s,n))}}const rt={[Q.LEFT]:[X.CHUNK_C_SPIRAL_SHORT,X.CHUNK_C_SPIRAL_MEDIUM,X.CHUNK_C_SPIRAL_LONG],[Q.MIDDLE]:[X.CHUNK_C_SPIRAL_SHORT,X.CHUNK_C_SPIRAL_MEDIUM,X.CHUNK_C_SPIRAL_LONG],[Q.RIGHT]:[X.CHUNK_R_SPIRAL_SHORT,X.CHUNK_R_SPIRAL_MEDIUM,X.CHUNK_R_SPIRAL_LONG]};var ot;!function(e){e[e.SHORT=0]="SHORT",e[e.MEDIUM=1]="MEDIUM",e[e.LONG=2]="LONG"}(ot||(ot={}));class ht{constructor(e){this.MAX_BY_TYPE=5,this.tracks=e,this._pool=new Map,this._trackSettings={[Q.LEFT]:this.settingListFromTrackId(Q.LEFT),[Q.MIDDLE]:this.settingListFromTrackId(Q.MIDDLE),[Q.RIGHT]:this.settingListFromTrackId(Q.RIGHT)},this.setupPool()}setupPool(){let e=[];for(let t=0;t<this.MAX_BY_TYPE;t++)e.push(new at(this.tracks.getTrack(Q.LEFT),this._trackSettings[Q.LEFT][ot.SHORT])),e.push(new at(this.tracks.getTrack(Q.LEFT),this._trackSettings[Q.LEFT][ot.MEDIUM])),e.push(new at(this.tracks.getTrack(Q.LEFT),this._trackSettings[Q.LEFT][ot.LONG]));this._pool.set(Q.LEFT,e),e=[];for(let t=0;t<this.MAX_BY_TYPE;t++)e.push(new at(this.tracks.getTrack(Q.MIDDLE),this._trackSettings[Q.MIDDLE][ot.SHORT])),e.push(new at(this.tracks.getTrack(Q.MIDDLE),this._trackSettings[Q.MIDDLE][ot.MEDIUM])),e.push(new at(this.tracks.getTrack(Q.MIDDLE),this._trackSettings[Q.MIDDLE][ot.LONG]));this._pool.set(Q.MIDDLE,e),e=[];for(let t=0;t<this.MAX_BY_TYPE;t++)e.push(new at(this.tracks.getTrack(Q.RIGHT),this._trackSettings[Q.RIGHT][ot.SHORT])),e.push(new at(this.tracks.getTrack(Q.RIGHT),this._trackSettings[Q.RIGHT][ot.MEDIUM])),e.push(new at(this.tracks.getTrack(Q.RIGHT),this._trackSettings[Q.RIGHT][ot.LONG]));this._pool.set(Q.RIGHT,e)}fetchNextChunk(e,t){const s=this._pool.get(e);let n=null;do{n=s[Math.floor(Math.random()*s.length)]}while(n.settings.type==t||n.allocated);return n}settingListFromTrackId(e){return{[ot.SHORT]:{type:ot.SHORT,meshId:rt[e][0],segSize:11,meshSize:.2,scoreValue:150,nrmScale:1},[ot.MEDIUM]:{type:ot.MEDIUM,meshId:rt[e][1],segSize:11,meshSize:.4,scoreValue:100,nrmScale:.5},[ot.LONG]:{type:ot.LONG,meshId:rt[e][2],segSize:11,meshSize:.9,scoreValue:50,nrmScale:.22}}}dispose(){this._pool.clear()}}const lt=new Ue.a,ct=i.vec2.create();class ut{constructor(e){this._tracks=[],this.flattening=!1,this.onKeyDown=e=>{let t=null;switch(e.key){case"ArrowLeft":t=this.tracks.get(Q.LEFT);break;case"ArrowDown":t=this.tracks.get(Q.MIDDLE);break;case"ArrowRight":t=this.tracks.get(Q.RIGHT);break;default:return}null===t||t.lockedTouch||this.scene.data.gameState.ended||(t.roller.forceDown=!0)},this.onPointerDown=e=>{if(!this.scene.data.gameState.ended){ct[0]=e.coords[0],ct[1]=e.coords[1],lt.unproject(ct,this.scene.camera);for(const e of this._tracks)e.roller.processPicking(lt)}},this.scene=e,this.tracks=new Map}init(){this.addTrack(Q.LEFT,X.SPLINE_LEFT),this.addTrack(Q.MIDDLE,X.SPLINE_MIDDLE),this.addTrack(Q.RIGHT,X.SPLINE_RIGHT);for(const e of this._tracks)this.tracks.set(e.id,e);this.chunkPool=new ht(this),this.scene.inputs.onTouchAdded.on(this.onPointerDown),document.addEventListener("keydown",this.onKeyDown)}addTrack(e,t){let s=new ze(this,e,this.scene.resources.get(t));this._tracks.push(s)}getTrack(e){return this.tracks.get(e)}reveal(){return this.getTrack(Q.MIDDLE).reveal(1),this.getTrack(Q.LEFT).reveal(1.2),this.getTrack(Q.RIGHT).reveal(1.4)}start(){for(const e of this._tracks)e.start()}restart(){for(let e=0;e<this._tracks.length;e++)this._tracks[e].restart()}preRender(e){let t=!1;for(const s of this._tracks)s.preRender(e),t=t||s.flattening;t!=this.flattening&&this.scene.audio.setFlatten(t),this.flattening=t}render(e,t,s=l.a.DEFAULT,n){for(const i of this._tracks)i.renderCream(e,t,s,n);for(const i of this._tracks)i.touchLight.ring.render(this.scene,e,t,s,n);for(const i of this._tracks)i.touchLight.glass.render(this.scene,e,t,s,n);for(const i of this._tracks)i.touchLight.halo.render(this.scene,e,t,s,n);for(const i of this._tracks)i.renderRoller(e,t,s,n)}dispose(){this.scene.inputs.onTouchAdded.off(this.onPointerDown),document.removeEventListener("keydown",this.onKeyDown),this.chunkPool.dispose()}}var dt=s(76),pt=s(236),mt=s.n(pt),gt=s(237),vt=s.n(gt),ft=s(436),_t=s.n(ft),xt=s(437),wt=s.n(xt),Tt=s(438),Pt=s.n(Tt),Ct=s(439),Lt=s.n(Ct),Mt=s(440),bt=s.n(Mt),Et=s(441),Rt=s.n(Et),St=s(442),yt=s.n(St),At=s(443),Ot=s.n(At);dt.a.debug=!1;class It{constructor(e){const t=e.gl;t.getExtension("OES_standard_derivatives"),this.hasHighp=function(e){const t=e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT);return e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0&&t.precision>0}(t),this.programs=[this.debugFbo=new dt.a(t),this.catmullDebug=new dt.a(t),this.trackHeight=new dt.a(t),this.floor=new dt.a(t),this.floorParticles=new dt.a(t)],this.compile()}precision(){return this.hasHighp?"highp":"mediump"}compile(){var e="\n";e+="precision "+this.precision()+" float;\n",this.debugFbo.compile(mt()(),vt()(),e),this.catmullDebug.compile(_t()(),wt()(),e),this.trackHeight.compile(Pt()(),Lt()(),e),this.floor.compile(bt()(),Rt()(),e),this.floorParticles.compile(yt()(),Ot()(),e),this.process()}process(){for(var e of this.programs)e.use()}dispose(){for(let e=0;e<this.programs.length;e++)this.programs[e].dispose();this.programs=null}}var Dt=s(77),kt=s(276);class Ft{constructor(e){this.fadeDist=0,this.enabled=!0,this.scene=e;const t=this.scene.gl;this.fbo=new Dt.a(t),this.fbo.attachColor(t.RGB,t.UNSIGNED_BYTE),this.fbo.attachDepth(!0,!1);const s=this.fbo.getColor();s.bind(),s.clamp(),s.setFilter(!0,!1,!1),this.blur=new kt.a(this.scene,512,20),this.cfg=this.scene.glstate.config(),this.cfg.enableDepthTest(!0).depthMask(!0).enableCullface(!0).cullFace(t.FRONT),this.blur.spread=.38599416423509797,this.fadeDist=1.3,this.depthCfg=this.scene.glstate.config(),this.depthCfg.enableCullface(!1).enableDepthTest(!0).depthMask(!0).colorMask(!1,!1,!1,!1)}alertMaskConfig(){alert(`spread: ${this.scene.reflectedTrack.blur.spread}   fadeDist: ${this.scene.reflectedTrack.fadeDist}`)}bind(e,t){const s=this.scene.gl,n=512,i=512;this.fbo.bind(),this.fbo.resize(n,i),this.blur.blurA_fbo.resize(n,i),this.blur.blurB_fbo.resize(n,i),s.clearColor(0,0,0,1),s.viewport(0,0,n,i),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)}process(){this.blur.process(this.fbo.getColor())}}var Nt=s(41),Ht=s(46);const zt=i.vec3.create();var Ut=(e,t,s)=>{const n=i.vec3.dot(s.normal,t.dir);if(Math.abs(n)>1e-6){i.vec3.sub(zt,s.origin,t.pos);const a=i.vec3.dot(zt,s.normal)/n;return i.vec3.scaleAndAdd(e,t.pos,t.dir,a),!0}return!1};const Gt=new Float32Array([-1,0,-1,1,0,-1,1,0,1,-1,0,1]),Vt=new Float32Array([-0,-0,1,0,1,1,0,1]),Bt=new Uint8Array([0,1,2,0,2,3]);class Wt{constructor(e){this.floor=e,this.scene=e.scene,this.prg=this.scene.programs.floorParticles;const t=this.scene.gl;this.vbuffer=new Nt.a(t),this.vbuffer.attrib("aPosition",3,t.FLOAT).attrib("aWorldPos",3,t.FLOAT).attrib("aTexCoord",2,t.FLOAT),this.ibuffer=new Ht.a(t,t.UNSIGNED_SHORT),this.config=this.scene.glstate.config(),this.config.enableDepthTest(!0).depthMask(!1).enableBlend(!0).blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA).enableCullface(!0).cullFace(t.FRONT)}updateGeom(e,t,s,n){let i=[],a=[],r=0,o=0,h=0,l=.11;for(let c=e[2];c>t[2];c-=.22){l=.11==l?0:.11;for(let e=s[0];e<n[0];e+=.22){a[o+0]=h+Bt[0],a[o+1]=h+Bt[1],a[o+2]=h+Bt[2],a[o+3]=h+Bt[3],a[o+4]=h+Bt[4],a[o+5]=h+Bt[5],o+=Bt.length,h+=4;for(let t=0;t<Gt.length/3;t++)i[r+8*t+0]=Gt[3*t+0],i[r+8*t+1]=Gt[3*t+1],i[r+8*t+2]=Gt[3*t+2],i[r+8*t+3]=e+l,i[r+8*t+4]=s[1],i[r+8*t+5]=c,i[r+8*t+6]=Vt[2*t+0],i[r+8*t+7]=Vt[2*t+1];r+=2*Gt.length+Vt.length}}this.vbuffer.data(new Float32Array(i)),this.ibuffer.data(new Uint16Array(a)),i=null,a=null}preRender(e){}render(e){const t=this.prg;t.use(),t.uMVP(e),t.uWaves(this.floor.waves),t.tNoise(this.scene.cmnTexs.get("noise-dots")),t.uTime(this.floor.time),this.scene.glstate.push(this.config),this.scene.glstate.apply(),this.vbuffer.bind(),this.vbuffer.attribPointer(t),this.ibuffer.bind(),this.ibuffer.drawTriangles(),this.scene.glstate.pop()}}const qt=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0]),Kt=(new Float32Array([-0,-0,1,0,1,1,0,1]),new Uint8Array([0,1,2,0,2,3])),jt=new Ue.a,Yt=i.vec3.fromValues(-1,-1,1),Xt=i.vec3.fromValues(1,-1,1),Qt=i.vec3.fromValues(1,1,1),$t=i.vec3.fromValues(-1,1,1),Zt=i.vec3.create(),Jt=new class{constructor(){this.origin=new Float32Array(3),this.normal=new Float32Array(3),this.normal[1]=1}};Jt.origin.set([0,-2,0]);const es=i.mat4.create();class ts{constructor(e){this.time=0,this.audioPhasePlayed=!1,this._invalid=!0,this.scene=e;const t=this.scene.gl;this.config=this.scene.glstate.config(),this.config.enableDepthTest(!0).depthMask(!1).enableCullface(!0).cullFace(t.BACK),this.prg=e.programs.floor,this.vbuffer=new Nt.a(t),this.vbuffer.attrib("aPosition",3,t.FLOAT),this.quadPoints=new Float32Array(qt),this.vbuffer.data(this.quadPoints),this.ibuffer=new Ht.a(t,t.UNSIGNED_BYTE),this.ibuffer.data(Kt),this.root=new o.a,this.minMax=i.vec2.create(),this.waves=new Float32Array(16),this.particles=new Wt(this)}get invalid(){return this._invalid}invalidate(){this._invalid=!0}cameraScreenToWorldPoint(e,t,s){jt.unproject(s,t,!0),e.set(jt.pos),i.vec3.scale(jt.dir,jt.dir,s[2]),i.vec3.add(e,e,jt.dir)}updateCorner(e,t,s){this.cameraScreenToWorldPoint(Zt,e,t),jt.unproject(t,e,!1),Ut(Zt,jt,Jt),this.quadPoints.set(Zt,3*s)}updateGeom(e){this.updateCorner(e,Yt,0),this.updateCorner(e,Xt,1),this.updateCorner(e,Qt,2),this.updateCorner(e,$t,3),this.minMax[0]=this.quadPoints[8],this.minMax[1]=this.quadPoints[11],this.vbuffer.data(this.quadPoints);const t=this.scene.tracks.getTrack(Q.LEFT),s=this.scene.tracks.getTrack(Q.MIDDLE),n=this.scene.tracks.getTrack(Q.RIGHT);jt.pos.set(this.scene.camera._wposition),i.vec3.sub(jt.dir,this.scene.camera._wposition,t.roller.picking.node._wposition),i.vec3.normalize(jt.dir,jt.dir),Ut(Zt,jt,Jt),this.waves[0]=Zt[0],this.waves[1]=Zt[2],i.vec3.sub(jt.dir,this.scene.camera._wposition,s.roller.picking.node._wposition),i.vec3.normalize(jt.dir,jt.dir),Ut(Zt,jt,Jt),this.waves[4]=Zt[0],this.waves[5]=Zt[2],i.vec3.sub(jt.dir,this.scene.camera._wposition,n.roller.picking.node._wposition),i.vec3.normalize(jt.dir,jt.dir),Ut(Zt,jt,Jt),this.waves[8]=Zt[0],this.waves[9]=Zt[2],this.particles.updateGeom(i.vec3.fromValues(this.quadPoints[3],this.quadPoints[4],this.quadPoints[5]),i.vec3.fromValues(this.quadPoints[9],this.quadPoints[10],this.quadPoints[11]),i.vec3.fromValues(this.quadPoints[0],this.quadPoints[1],this.quadPoints[2]),i.vec3.fromValues(this.quadPoints[6],this.quadPoints[7],this.quadPoints[8])),this._invalid=!1}preRender(e){const t=this.scene.tracks.getTrack(Q.LEFT),s=this.scene.tracks.getTrack(Q.LEFT).roller,n=this.scene.tracks.getTrack(Q.MIDDLE).roller,i=this.scene.tracks.getTrack(Q.RIGHT).roller;this.waves[2]+=s.isPressing?1.25*e:1.25*-e,this.waves[2]=Object(a.d)(this.waves[2]),this.waves[6]+=n.isPressing?1.25*e:1.25*-e,this.waves[6]=Object(a.d)(this.waves[6]),this.waves[10]+=i.isPressing?1.25*e:1.25*-e,this.waves[10]=Object(a.d)(this.waves[10]);const r=Math.sin(6.5*this.time);this.waves[2]+this.waves[6]+this.waves[10]>.5&&r>.8&&!this.audioPhasePlayed&&(this.audioPhasePlayed=!0,this.scene.audio.play(pe.CIRCLE_ECHO,1)),this.waves[12]=.905882353*(this.scene.postProcess.enabled?4.35:1),this.waves[13]=.831372549*(this.scene.postProcess.enabled?4.35:1),this.waves[14]=.23*(this.scene.postProcess.enabled?4.35:1),r<.8&&(this.audioPhasePlayed=!1);let o=(t.speed-Z)/Z;this.time+=e*(1+.5*o),this.particles.preRender(e)}render(e){const t=this.prg;t.use(),e.modelViewProjectionMatrix(es,this.root._wmatrix),t.uMVP(es),t.uMinMax(this.minMax);const s=this.scene.cmnTexs;t.tBlueNoise(s.get("blue-noise")),this.vbuffer.bind(),this.vbuffer.attribPointer(t),this.scene.glstate.push(this.config),this.scene.glstate.apply(),this.ibuffer.bind(),this.ibuffer.drawTriangles(),this.scene.glstate.pop(),this.particles.render(es)}}var ss=s(243),ns=s(246);class is{constructor(e){this.minRatio=.4618226600985222,this.maxRatio=1.7,this.scene=e,this.delta=i.vec3.create(),this.basePos=i.vec3.create()}init(e){i.vec3.copy(this.delta,e._wposition),i.vec3.scale(this.delta,this.delta,-1),i.vec3.normalize(this.delta,this.delta),i.vec3.copy(this.basePos,e._wposition),this.cam=e}preRender(){if(this.scene.ratio!=this.currentRatio){this.currentRatio=this.scene.ratio;let e=Object(a.e)(this.currentRatio,this.minRatio,this.maxRatio,0,1);e=Object(a.d)(e),e*=1.6,this.cam.x=this.delta[0]*e,this.cam.y=-this.delta[1]*(e-1.1),this.cam.z=this.delta[2]*e}}}function as(e,t,s,n){return{maxDpr:e,fxaa:t,trackReflect:s,post:n}}const rs=[as(2,!0,!0,!0),as(1.5,!0,!0,!0),as(1.5,!1,!0,!0),as(1.5,!1,!0,!1),as(1.5,!1,!1,!1)];function os(e){return new Promise(t=>setTimeout(t,e))}function hs(){return performance.now()/1e3}class ls{constructor(){this._running=!1,this.lastFrameTime=-1,this.startTime=-1,this.record=[],this.onRaf=()=>{if(!this._running)return;const e=hs();if(this.lastFrameTime>0&&this.record.push(e-this.lastFrameTime),this.lastFrameTime=e,e-this.startTime>this._sampleDuration)return this._defer.resolve(this.getResult()),void this._stop();requestAnimationFrame(this.onRaf)}}start(e=1){if(!this._running)return this._sampleDuration=e,this._defer=new u.a,this.startTime=hs(),this._running=!0,requestAnimationFrame(this.onRaf),this._defer.promise}stop(){this._defer.reject("stopped"),this._stop()}_stop(){this._defer=null,this._running=!1,this.record.length=0}getResult(){let e=0;const t=this.record;for(let s=0;s<t.length;s++){e+=t[s]}e/=t.length;let s=0,n=0;for(let i=0;i<t.length;i++){const a=t[i],r=a/e;r>.25&&r<4&&(s+=a,n++)}return s/=n,{meanFrame:s}}}class cs{constructor(e){this.scene=e,this._currentLevel=0,this._forceQuality=!1,this._debugLevel=1,this.level=0}async startAutoLevel(e){const t=new ls;for(await os(1e3);;){let s=await t.start();if(e.signal.aborted)throw"";if(console.log("fps "+1/s.meanFrame),!(s.meanFrame>.02))return;if(!this.reduceQuality())return;await os(200)}}set level(e){e<0||e>=rs.length||(this._currentLevel=e,this._applyLevel())}get level(){return this._currentLevel}reduceQuality(){return!(this.level>=rs.length-1)&&(this.level++,console.log("reduced quality to "+this.level),!0)}_applyLevel(){let e=rs[this._currentLevel];this.scene.maxDpr=e.maxDpr,this.scene.enableFxaa=e.fxaa,this.scene.reflectedTrack.enabled=e.trackReflect,this.scene.postProcess.enabled=e.post}}var us=s(514),ds=s(92),ps=s(85),ms=s(444),gs=s.n(ms),vs=s(445),fs=s.n(vs);class _s extends Ye.a{constructor(){super(!0,!0),this.time=0,this.progress=0}setup(e){e.uProgress(Object(j.easeOutCubic)(this.progress))}_genCode(e){e.add("vertex_warp",gs()()),e.add("pv",fs()())}_getHash(){return"glitter-particles-effect"}}const xs=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0]),ws=new Uint8Array([0,1,2,0,2,3]);class Ts{constructor(e){this.scene=e,this._pool=[],this.scene=e,this.root=new o.a,this.scene.root.add(this.root);const t=new Ge.a(this.scene.gl,"glitter-particles"),s=new ds.a;t.mask=c.a.OPAQUE,s.mask=c.a.OPAQUE,s.glconfig.enableDepthTest(!0).depthMask(!0).enableCullface(!1),s.surface.baseColor.attachConstant([.937254902,.8313725490196078,.6784313725490196]),s.surface.baseColorFactor.attachConstant(1.12),s.surface.metalness.attachConstant(.898039216),s.surface.roughness.attachConstant(.2),t.addPass(s,l.a.COLOR),this.scene.iblMngr.setupMat(s),this.effect=new _s,t.inputs.add(this.effect),this.material=t;const n=this.scene.gl;this.vbuffer=new Nt.a(n),this.ibuffer=new Ht.a(n,n.UNSIGNED_SHORT),this.vbuffer.attrib("aPosition",3,n.FLOAT).attrib("aCenter",4,n.FLOAT).attrib("aNormal",3,n.FLOAT),this.cbuffers=[];for(let e=0;e<5;e++){let e=new Nt.a(n);e.attrib("aAxis",4,n.FLOAT),this.cbuffers.push(e)}this.createGeometry();const i=t.getPass(l.a.COLOR).getProgram();i.use(),this._vaoPool=[];for(let e=0;e<5;e++){let t=new ps.a(n);t.setup(i,[this.vbuffer,this.cbuffers[e]],this.ibuffer),this._vaoPool.push(t)}}init(){const e=this.scene.gltfs.get(X.SCENE);this._spawnLocation={[Q.LEFT]:e.getElementByName(I.a.NODE,"GlitterSpawn_L"),[Q.MIDDLE]:e.getElementByName(I.a.NODE,"GlitterSpawn_M"),[Q.RIGHT]:e.getElementByName(I.a.NODE,"GlitterSpawn_R")}}createGeometry(){let e=new Float32Array(12e3),t=new Uint16Array(300*ws.length),s=0,n=i.vec3.create();for(let i=0;i<300;i++){let a=.01+.022*Math.random(),r=.01+.005*Math.random();n[0]=.4*Math.random()-.2,n[1]=.1*Math.random()-.05,n[2]=.15*Math.random()-.075;let o=Math.random();for(let t=0;t<4;t++)e[40*i+10*t+0]=xs[3*t+0]*a,e[40*i+10*t+1]=xs[3*t+1]*r,e[40*i+10*t+2]=xs[3*t+2],e[40*i+10*t+3]=n[0],e[40*i+10*t+4]=n[1],e[40*i+10*t+5]=n[2],e[40*i+10*t+6]=o,e[40*i+10*t+7]=0,e[40*i+10*t+8]=0,e[40*i+10*t+9]=1;for(let e=0;e<ws.length;e++)t[i*ws.length+e]=ws[e]+s;s+=xs.length/3}this.vbuffer.data(e),this.ibuffer.data(t);let a=i.vec3.create();for(let e=0;e<5;e++){let t=new Float32Array(4800);for(let e=0;e<300;e++){a[0]=2*(Math.random()-.5),a[1]=Math.random(),a[2]=2*(Math.random()-.4),i.vec3.normalize(a,a);let s=Math.random();for(let n=0;n<4;n++)t[16*e+4*n+0]=a[0],t[16*e+4*n+1]=a[1],t[16*e+4*n+2]=a[2],t[16*e+4*n+3]=s}this.cbuffers[e].data(t)}}addSplash(e){this.scene.audio.play(pe.FLATTEN_PERFECT,.8),this._pool.push({progress:0,node:this._spawnLocation[e],vaoIdx:Math.floor(5*Math.random())})}preRender(e){for(let t=this._pool.length-1;t>=0;t--)1==this._pool[t].progress?(this._pool[t]=null,this._pool.splice(t,1)):(this._pool[t].progress+=.85*e,this._pool[t].progress=Object(a.d)(this._pool[t].progress))}render(e,t,s=l.a.DEFAULT){if(t!=c.a.OPAQUE||s!=l.a.COLOR)return;const n=this.material.getPass(l.a.COLOR);this.scene.glstate.push(n.pass.glconfig),this.scene.glstate.apply();for(const t of this._pool)this._vaoPool[t.vaoIdx].bind(),this.effect.progress=t.progress,n.prepare(t.node,e),this.ibuffer.drawTriangles(),this._vaoPool[t.vaoIdx].unbind();this.scene.glstate.pop()}dispose(){this.material=null}}var Ps=s(279);i.vec3.create(),i.vec3.create();class Cs{constructor(e,t,s){this.sceneWidth=0,this.sceneHeight=0,this.enableFxaa=!0,this.maxDpr=2,this.preCompileMats=()=>(this.iblMngr.lights.setup.prepare(this.gl),this.matlib.compileAllAsync()),this.onLoaded=()=>{this.programs.compile(),de.processGltfs(this,this.gltfs);const e=this.gltfs.get(X.SCENE),t=e.cameraInstances[0];this.root.updateWorldMatrix(),this.devCamera.lens.aspect=t.lens.aspect,this.mainCamera=t,this.zoomCtrl.init(t),this.decor.init(e),this.tracks.init(),this.glitterParticles.init(),this.loaded=!0},this.data=e,this.dt=0,this.time=0,this.ratio=1,this.ilayer=null,this.loaded=!1,this.resources=t,this.audioResources=s}enter(){return console.log("[SCENE][Game 2] Enter"),this.quality.startAutoLevel(this.mainCTS),this.audio.playMainTrack(),this.audio.play(pe.ROLL_SETUP),this.audio.playFlatten(),this.decor.reveal().then(()=>{this.tracks.start()}),this.tracks.reveal(),null}leave(){console.log("[SCENE][Game 2] Leave")}attachResources(e){}init(e){this.loaddefer=new u.a,this.mainCTS=new us.a,this.glview=e,this.gl=this.glview.gl,this.mainCamera=this.makeCamera(),this.devCamera=this.makeCamera(),this.camera=this.mainCamera,this.cmnTexs=new d.a("cmn",this.gl,this.resources),this.gltfs=new O.a("gltfs",this.gl,this.resources),de.setupCmnTexs(this.cmnTexs),de.setupGltfs(this.gltfs),de.setupResources(this.resources),this.sroot=new o.a,this.root=new o.a,this.glstate=new r.a(this.gl),this.quad=new h.a(this.gl),this.inputs=new _.a(this.ilayer),this.postProcess=new w.a(this,"games"),this.setupPostFX(),this.matlib=new p.a(this),this.iblMngr=new A(this),this.raycaster=new x.a(this),this.zoomCtrl=new is(this),this.audio=new fe(this),this.programs=new It(this),this.envRotation=0,this.camCtrl=new v.a(this,this.devCamera),this.maxcam=new f.a(this.glview.canvas),this.root.add(this.mainCamera),this.root.add(this.devCamera),this.sroot.add(this.root),this.decor=new Y(this),this.reflectedTrack=new Ft(this),this.tracks=new ut(this),this.floor=new ts(this),this.glitterParticles=new Ts(this),this.inputs.start(),this.quality=new cs(this)}setupPostFX(){const e=new ss.a;e.scatter=.69,e.clamp=20,e.threshold=1.2;e.color.set([7,7,7]),this.postProcess.addEffect(e),this.saturation=new Ps.a(1),this.postProcess.addEffect(this.saturation),this.postProcess.enabled=!0,this.fxaa=new ns.a(this.gl)}handleResize(){}render(e){this.loaded&&(this.audio.update(),this.data.gameState.paused||(this.dt=e,this.time+=e,this.useDebugCam?this.camera=this.devCamera:this.camera=this.mainCamera,this.drawScene(this.camera)))}drawScene(e,t=null,s=!1){const n=this.gl,i=Math.min(this.maxDpr,window.devicePixelRatio),a=t?t.width:this.glview.width,r=t?t.height:this.glview.height;let o,h;this.postProcess.enabled?(o=t?t.width:this.glview.canvasWidth*i,h=t?t.height:this.glview.canvasHeight*i):(o=a,h=r),this.ratio=o/h,this.sceneWidth==o&&this.sceneHeight==h||this.floor.invalidate(),this.sceneWidth=o,this.sceneHeight=h,this.zoomCtrl.preRender(),this.iblMngr.preRender(),this.decor.preRender(),this.tracks.preRender(this.dt),this.floor.preRender(this.dt),this.glitterParticles.preRender(this.dt),this.root.rotation.set([0,0,0,1]),this.root.rotateY(this.envRotation),this.sroot.updateWorldMatrix(),e.updateViewProjectionMatrix(o,h),this.floor.invalid&&this.floor.updateGeom(e);const u=this.reflectedTrack;u.enabled&&(u.bind(o,h),this.decor.render(e,c.a.REFLECTED,l.a.REFLECT_DEPTH,u.depthCfg),this.tracks.render(e,c.a.REFLECTED,l.a.REFLECT_DEPTH,u.cfg),u.process(),this.glstate.apply()),n.bindFramebuffer(n.FRAMEBUFFER,null),n.clearColor(0,0,0,1),this.fxaa.resize(o,h),this.postProcess.preRender(o,h),this.postProcess.bindColor(),this.floor.render(e),this.decor.render(e,c.a.OPAQUE,l.a.COLOR),this.tracks.render(e,c.a.OPAQUE,l.a.COLOR),this.glitterParticles.render(e,c.a.OPAQUE,l.a.COLOR),this.reflectedTrack.enabled&&this.decor.render(e,c.a.BLENDED,l.a.COLOR),this.tracks.render(e,c.a.BLENDED,l.a.COLOR),this.glstate.apply(),this.enableFxaa&&this.postProcess.enabled?(this.postProcess.render(this.fxaa.fbo),n.bindFramebuffer(n.FRAMEBUFFER,null),n.viewport(0,0,a,r),this.fxaa.render()):(n.viewport(0,0,a,r),this.postProcess.render(void 0,a,r))}async load(){await this.iblMngr.loadDefault(),await this.preCompileMats()}gameOver(){K.a.to(this.saturation,{amount:0},1).start().onComplete(()=>{this.data.gameState.ended=!0})}restart(){this.tracks.restart(),this.saturation.amount=1}makeCamera(){const e=new m.a(new g.a);return e.lens.setAutoFov(45*a.a),e.lens.near=.1,e.lens.far=100,e.z=2,e.y=.5,e.lookAt(i.vec3.fromValues(0,e.y,0)),e}async dispose(){var e,t,s,n,i,a,r,o,h,l,c,u;null===(e=this.mainCTS)||void 0===e||e.abort(),this.mainCTS=null,null===(t=this.audio)||void 0===t||t.dispose(),null===(s=this.tracks)||void 0===s||s.dispose(),this.tracks=null,null===(n=this.programs)||void 0===n||n.dispose(),null===(i=this.camCtrl)||void 0===i||i.setControler(null),null===(a=this.inputs)||void 0===a||a.release(),null===(r=this.raycaster)||void 0===r||r.dispose(),null===(o=this.matlib)||void 0===o||o.dispose(),null===(h=this.glitterParticles)||void 0===h||h.dispose(),null===(l=this.audio)||void 0===l||l.dispose(),null===(c=this.cmnTexs)||void 0===c||c.unloadAll(),null===(u=this.gltfs)||void 0===u||u.unloadAll(),this.root._children=null,this.root=null}}var Ls=s(83),Ms=s(18),bs=s(249),Es=s(6);class Rs extends oe.a{constructor(e,t,s){super(e,s),this.content="string",this.url=t}load(){fetch(this.url).then(e=>e.blob()).then(e=>new Promise(t=>{var s=new FileReader;s.onloadend=function(){t(s.result)},s.readAsDataURL(e)})).then(e=>{this.content=e,this.resolve(e)})}unload(){this._abortCtrl.abort()}}var Ss=s(16),ys=s(14);class As extends Ls.a{constructor(){super(),this.name="Game 2",console.log("[MODULE][Game 2] instantiate"),this.ghostloadedResources=new ys.a(this.name+"-ghostload",null),this.data.gameState=Object(bs.d)(new bs.e,new bs.c,new bs.a),this.data.gameState.gameId=Es.a.GAME_2,this.resetState()}init(e){super.init(e),this._scene=new Cs(this.data,this.resources,this.audioResources);let t=window.innerWidth>=768?"desktop":"mobile";new Ms.a("game-preview",s(125)("./bg-stars-"+t+".jpg"),this.preloadedResources),new Ms.a("game-logo",s(446),this.preloadedResources),new Ms.a("poster-rule1",s(447),this.preloadedResources),new Ms.a("poster-rule2",s(448),this.preloadedResources),new Ms.a("poster-rule3",s(449),this.preloadedResources),new Ms.a("share-push",s(126),this.resources),new Ms.a("share-product",s(250),this.resources),new Ms.a("share-game",s(450)("./share-challenge-game-2-"+t+".png"),this.resources),new Ms.a("share-game-canvas",s(453),this.resources),new Rs("smooth",s(454),this.resources),new Ms.a("game-thumbnail-1",s(121),this.resources),new Ms.a("game-thumbnail-2",s(122),this.resources),new Ms.a("game-thumbnail-3",s(123),this.resources),new Ms.a("game-thumbnail-4",s(124),this.resources),this.setupPraise("amazing",173,214),this.setupPraise("beautiful",125,170),this.setupPraise("wow",216,257),new ve.a("INSIDE_PORTAL_MAIN_LOOP","main/INSIDE_PORTAL_MAIN_LOOP",this.audioResources)}setupPraise(e,t,s){let n=0;for(let i=t;i<=s;i++)new Ms.a(`${e}-${n}`,`/assets/img/game-2/${e}/${e}_00${i}.png`,this.ghostloadedResources),n+=1}getSprites(e){return this.ghostloadedResources.getResources(new RegExp(e+"[-][00-99]"),!0)}resetState(){this.data.gameState.health=4,this.data.gameState.score=0}restart(){this.resetState(),this._scene.restart()}onLoaded(){this.ghostloadedResources.load(),this.ghostloadedResources.whenAllLoadables().then(()=>this.onGhostloadComplete()),this.playIntroGameLoop()}onGhostloadComplete(){this._vm.onGhostloadComplete()}playIntroGameLoop(){this.gameMusicLoop=this.audioResources.get("INSIDE_PORTAL_MAIN_LOOP").play(1,!0),this.gameMusicLoop.node.loopStart=1,this.gameMusicLoop.node.loopEnd=11}stopIntroGameLoop(){Ss.a.to(this.gameMusicLoop.gain.gain,{duration:1,value:0,onComplete:()=>{this.gameMusicLoop.dispose(),this.gameMusicLoop=null}})}async leave(){let e=null;return this.gameMusicLoop&&(e=new Promise(e=>{Ss.a.to(this.gameMusicLoop.gain.gain,{duration:1,value:0,onComplete:()=>{e()}})})),Promise.all([e,super.leave()]).then(()=>{this.dispose()})}dispose(){var e;this.ghostloadedResources.unloadAll(),null===(e=this.gameMusicLoop)||void 0===e||e.dispose(),this.gameMusicLoop=null}}var Os=s(39),Is=s(84),Ds=s(251),ks=s(252),Fs=s(254),Ns=s(253),Hs=s(255);const zs=Object(Is.a)(As);var Us={_module:zs,mixins:[zs,Os.a,Ds.a],components:{Scoreboard:ks.a,ScoreUi:Fs.a,InstructionsPanel:Ns.a,PraiseCvs:Hs.a},data:()=>({isGhostLoaded:!1,isLoaded:!1,isStarted:!1,instructionActive:!1,finalScore:0,praise:{step:1e3,audioDelay:0}}),watch:{"$data.gameState.ended":"onEnded"},methods:{preparePraise(){},onGhostloadComplete(){const e=this.getModule();this.$refs.praise.addSprites(e.getSprites("amazing")),this.$refs.praise.addSprites(e.getSprites("beautiful")),this.$refs.praise.addSprites(e.getSprites("wow")),this.isGhostLoaded=!0},onPraiseRequest(){this.isGhostLoaded&&this.$refs.praise.play()},onPraiseAudioRequest(){this.getModule().getScene().audio.play(pe.HYPE_WORDS)}}},Gs=s(5),Vs=Object(Gs.a)(Us,n,[],!1,null,null,null);Vs.options.__file="src/modules/game2/Game2.vue";t.default=Vs.exports}}]);