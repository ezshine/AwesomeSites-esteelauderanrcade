(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{220:function(t,e,s){"use strict";function i(t){return t}function n(t){return t*t}function r(t){return t*(2-t)}function a(t){return t<.5?2*t*t:(4-2*t)*t-1}function o(t){return t*t*t}function h(t){return--t*t*t+1}function l(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1}function c(t){return t*t*t*t}function u(t){return 1- --t*t*t*t}function d(t){return t<.5?8*t*t*t*t:1-8*--t*t*t*t}function g(t){return t*t*t*t*t}function m(t){return 1+--t*t*t*t*t}function p(t){return t<.5?16*t*t*t*t*t:1+16*--t*t*t*t*t}function f(t){return Math.pow(2,10*(t-1))}function v(t){return 1-Math.pow(2,-10*t)}function _(t){return(t*=2)<1?.5*Math.pow(2,10*(t-1)):.5*(2-Math.pow(2,-10*--t))}s.r(e),s.d(e,"easeLinear",(function(){return i})),s.d(e,"easeInQuad",(function(){return n})),s.d(e,"easeOutQuad",(function(){return r})),s.d(e,"easeInOutQuad",(function(){return a})),s.d(e,"easeInCubic",(function(){return o})),s.d(e,"easeOutCubic",(function(){return h})),s.d(e,"easeInOutCubic",(function(){return l})),s.d(e,"easeInQuart",(function(){return c})),s.d(e,"easeOutQuart",(function(){return u})),s.d(e,"easeInOutQuart",(function(){return d})),s.d(e,"easeInQuint",(function(){return g})),s.d(e,"easeOutQuint",(function(){return m})),s.d(e,"easeInOutQuint",(function(){return p})),s.d(e,"easeInExpo",(function(){return f})),s.d(e,"easeOutExpo",(function(){return v})),s.d(e,"easeInOutExpo",(function(){return _}))},221:function(t,e,s){"use strict";var i=s(220);var n=new class{constructor(){this._realTime=0,this._globalTime=0,this._running=!1,this._tweens=[],this._tweensByTarget=new Map,this._tweensById=new Map,this.timescale=1,this.frame=()=>{const t=performance.now()/1e3;let e=t-this._realTime;this._realTime=t,e>1&&(e=1/60),this._globalTime+=e*this.timescale;const s=this._globalTime;for(const t of this._tweens)t._step(s,e);this._running&&requestAnimationFrame(this.frame)}}get globalTime(){return this._globalTime}registerTween(t){var e;this.getOrCreateTweensForTarget(t.target).push(t),null!==t.id&&(null===(e=this._tweensById.get(t.id))||void 0===e||e.stop(),this._tweensById.set(t.id,t)),1===this._tweens.push(t)&&this.start()}unregisterTween(t){var e=this.getTweensForTarget(t.target);void 0!==e&&(e.splice(e.indexOf(t),1),0===e.length&&this._tweensByTarget.delete(t.target)),null!==t.id&&this._tweensById.delete(t.id);const s=this._tweens.indexOf(t);this._tweens.splice(s,1),0===this._tweens.length&&this.stop()}getTweensForTarget(t){return this._tweensByTarget.get(t)}getTweenForId(t){return this._tweensById.get(t)}getOrCreateTweensForTarget(t){if(!this._tweensByTarget.has(t)){const e=[];return this._tweensByTarget.set(t,e),e}return this._tweensByTarget.get(t)}start(){this._running||(this._running=!0,this._realTime=performance.now()/1e3,requestAnimationFrame(this.frame))}stop(){this._running=!1}};class r{constructor(t,e,s){this.target=t,this.property=e,this.initialValue=t[e],this.deltaValue=s-this.initialValue}apply(t){this.target[this.property]=this.initialValue+this.deltaValue*t}}class a{constructor(t,e,s){this.target=t,this.property=e,this.initialValue=[],this.deltaValue=[];for(let t=0;t<this.initialValue.length;t++)this.deltaValue[t]=s[t]-this.initialValue[t]}apply(t){var e=this.target[this.property];for(let s=0;s<this.initialValue.length;s++)e[s]=this.initialValue[s]+this.deltaValue[s]*t}}class o{constructor(){this._listeners=[]}on(t){-1===this._listeners.indexOf(t)&&this._listeners.push(t)}off(t){const e=this._listeners.indexOf(t);e>-1&&this._listeners.splice(e,1)}release(){this._listeners=[]}emit(t){for(const e of this._listeners)e(t)}}class h{constructor(t){this._easeFunc=i.easeLinear,this._delay=0,this._isRunning=!1,this._onCompleteSignal=new o,this._config=t,this._startTime=n.globalTime,this._interpolators=function(t,e){const s=[];for(const i in e){const n=e[i];let o;o="number"==typeof n?new r(t,i,n):new a(t,i,n),s.push(o)}return s}(t.target,t.properties),this._duration=t.duration,this._delay=t.delayValue,this._easeFunc=t.easeFunc,this.resume()}get target(){return this._config.target}get id(){return this._config.idValue}stop(){this._isRunning&&(this._isRunning=!1,n.unregisterTween(this),this._onCompleteSignal.release())}onComplete(t){this._onCompleteSignal.on(t)}_step(t,e){const s=(t-this._startTime-this._delay)/this._duration;if(s<0)return;const i=Math.min(1,s),n=this._easeFunc(i);for(const t of this._interpolators)t.apply(n);s>=1&&this._complete()}resume(){this._isRunning||(this._isRunning=!0,n.registerTween(this))}_complete(){this._onCompleteSignal.emit(),this.stop()}}class l{constructor(t,e,s=.4){if(this._delay=0,this._easeFunc=i.easeLinear,this._id=null,s<1e-6||isNaN(s))throw new Error("duration must be positive");this._duration=s,this._target=t,this._properties=e}get target(){return this._target}get properties(){return this._properties}get duration(){return this._duration}get delayValue(){return this._delay}get easeFunc(){return this._easeFunc}get idValue(){return this._id}start(){return new h(this)}ease(t){return this._easeFunc=t||this._easeFunc||i.easeLinear,this}delay(t){return this._delay=Math.max(0,t),this}id(t){this._id=t}}const c={Ease:i,to:function(t,e,s){return new l(t,e,s)},stopByTarget:function(t){var e=n.getTweensForTarget(t);if(void 0!==e)for(const t of e)t.stop()},stopById:function(t){var e;null===(e=n.getTweenForId(t))||void 0===e||e.stop()},set timescale(t){n.timescale=t},get timescale(){return n.timescale}};e.a=c},223:function(t,e,s){"use strict";s.d(e,"b",(function(){return r})),s.d(e,"d",(function(){return a})),s.d(e,"e",(function(){return o})),s.d(e,"c",(function(){return h})),s.d(e,"a",(function(){return l}));var i=s(1),n=i.vec3.create();function r(t,e){return e[0]=(t>>16&255)/255,e[1]=(t>>8&255)/255,e[2]=(255&t)/255,e}function a(t){return r(t,i.vec3.create())}function o(t,e){const s=r(t,i.vec3.create());return s[0]*=e,s[1]*=e,s[2]*=e,s}function h(t,e,s){const i=t>>16,n=t>>8&255,r=255&t;return(i+s*((e>>16)-i)<<16)+(n+s*((e>>8&255)-n)<<8)+(0|r+s*((255&e)-r))}function l(t,e,s){return function(t){n[0]=(t>>16&255)/255,n[1]=(t>>8&255)/255,n[2]=(255&t)/255}(t),s[0]=n[0],s[1]=n[1],s[2]=n[2],s[3]=e,s}},224:function(t,e,s){"use strict";s.d(e,"a",(function(){return o}));var i=s(1);const n=i.vec3.create(),r=i.mat4.create(),a=(i.mat3.create(),i.mat4.create());class o{constructor(){this._invalid=!0,this.pos=i.vec3.create(),this.dir=i.vec3.create()}unproject(t,e,s=!1){i.mat4.invert(r,e._viewProj),e._parent&&s&&(i.mat4.invert(a,e._parent._wmatrix),i.mat4.multiply(r,a,r)),n[0]=t[0],n[1]=t[1],n[2]=-1,i.vec3.transformMat4(this.pos,n,r),n[2]=1,i.vec3.transformMat4(this.dir,n,r),i.vec3.subtract(this.dir,this.dir,this.pos),i.vec3.normalize(this.dir,this.dir)}invalidate(){this._invalid=!0}}},225:function(t,e,s){"use strict";s.d(e,"b",(function(){return u})),s.d(e,"a",(function(){return d}));var i=s(29),n=s(36),r=s(17);class a extends r.b{constructor(t,e,s,i){super(t,e,s,i),this.textureType=r.a.TEXTURE_CUBE,this._target=34067,t.bindTexture(34067,this.id),this.setFilter(!0)}fromImages(t){var e=this.gl,s=this.format,i=this.internal,n=this.type;this.width=t[0].width,this.height=t[0].height,e.bindTexture(34067,this.id),e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X,0,i,s,n,t[0]),e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_Y,0,i,s,n,t[1]),e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_Z,0,i,s,n,t[2]),e.texImage2D(e.TEXTURE_CUBE_MAP_NEGATIVE_X,0,i,s,n,t[3]),e.texImage2D(e.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,i,s,n,t[4]),e.texImage2D(e.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,i,s,n,t[5])}}var o,h=s(37),l=s(35);!function(t){t[t.CLAMP=0]="CLAMP",t[t.REPEAT=1]="REPEAT",t[t.MIRROR=2]="MIRROR"}(o||(o={}));class c extends i.a{constructor(t,e,s){super(t,s),this.request=e}set request(t){this._request=t}get request(){return this._request}get value(){return this.texture}load(){const t=this.group.lodLevel;this.loadLevelAsync(t)}unload(){}async loadLevelAsync(t){const e=this.group.loader.extTextures,[s,i]=l.a.getCodecForRequest(this._request,e);await this.loadSourceLod(i.lods[t]),await s.decodeLod(i,t,e),this.group.loader.upload(this,i.datas);for(let e=0;e<i.lods[t].files.length;e++)this.group.removeResourceByName(i.lods[t].files[e]);this.resolve(this.texture)}async loadSourceLod(t){const e=[];for(let s=0;s<t.files.length;s++)e.push(Object(h.c)(t.files[s],this.group));const s=await Promise.all(e);return t.buffers=s,s}}class u extends c{constructor(t,e,s){super(t,e,s),this.texture=new n.a(this.group.gl)}}class d extends c{constructor(t,e,s){super(t,e,s),this.texture=new a(this.group.gl)}async loadLevelAsync(t){const e=this.group.loader.extTextures,[s,i]=l.a.getCodecForRequest(this._request,e);for(let t=0;t<i.lods.length;t++)await this.loadSourceLod(i.lods[t]);await s.decodeCube(i,e),this.group.loader.upload(this,i.datas);for(let t=0;t<i.lods.length;t++)for(let e=0;e<i.lods[t].files.length;e++)this.group.removeResourceByName(i.lods[t].files[e]);this.resolve(this.texture)}}},229:function(t,e,s){"use strict";s.d(e,"a",(function(){return d}));var i=s(14);const n=["WEBGL_compressed_texture_s3tc","MOZ_WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"],r=["WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"],a=["WEBGL_compressed_texture_etc1","WEBKIT_WEBGL_compressed_texture_etc1"],o=["WEBGL_compressed_texture_astc"];class h{constructor(t){this.gl=t,this.dxt=this.pickExtension(n),this.pvr=this.pickExtension(r),this.etc=this.pickExtension(a),this.astc=this.pickExtension(o)}pickExtension(t){let e=null;for(const s of t)if(e=this.gl.getExtension(s),e)break;return e}}var l=s(17),c=s(19);class u{constructor(t){this.gl=t,this.extTextures=new h(t),this.extAniso=t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||t.getExtension("EXT_texture_filter_anisotropic")}upload(t,e){this.gl;const s=t.texture;if(s.textureType!==e.textureType)throw new Error("TexturesLoader::upload() texture type mismatch");switch(s.bind(),s.textureType){case l.a.TEXTURE_2D:this.uploadTexture2D(s,e,0);break;case l.a.TEXTURE_CUBE:this.uploadTextureCube(s,e,0)}}uploadTexture2D(t,e,s=0){this.uploadAllSurfaceLevels(t,e,s,0,t.textureType)}uploadTextureCube(t,e,s=0){for(let i=0;i<6;i++){const n=Object(c.b)(i);this.uploadAllSurfaceLevels(t,e,s,i,n)}}uploadAllSurfaceLevels(t,e,s,i,n){switch(e.datatype){case c.a.RAW_COMPRESSED:this.uploadLevelsCompressed(t,e,s,i,n);break;case c.a.IMAGE:this.uploadLevels(t,e,s,i,n);break;case c.a.RAW:this.uploadLevelsRaw(t,e,s,i,n)}}uploadLevels(t,e,s,i,n){const r=e.sources[s].surfaces[i];for(let t=0;t<r.length;t++)this.gl.texImage2D(n,t,e.internalformat,e.format,e.type,r[t].data)}uploadLevelsRaw(t,e,s,i,n){const r=e.sources[s].surfaces[i];for(let t=0;t<r.length;t++){const s=r[t];this.gl.texImage2D(n,t,e.internalformat,s.width,s.height,0,e.format,e.type,s.data)}}uploadLevelsCompressed(t,e,s,i,n){const r=e.sources[s].surfaces[i];let a=r[0].width,o=r[0].height;for(let t=0;t<r.length;t++){const s=r[t];this.gl.compressedTexImage2D(n,t,e.internalformat,a,o,0,s.data),a=Math.max(1,a>>1),o=Math.max(1,o>>1)}}}class d extends i.a{constructor(t="default",e,s=i.a.default){super(t,s),this._lodLevel=0,this.gl=e,this.loader=new u(e)}set lodLevel(t){this._lodLevel=t}get lodLevel(){return this._lodLevel}}},231:function(t,e,s){"use strict";s.d(e,"a",(function(){return u}));var i=s(1);const n=i.quat.create(),r=i.quat.create(),a=i.quat.create(),o=i.vec3.create(),h=i.vec3.create(),l=(i.mat4.create(),i.mat4.create());var c;!function(t){t[t.NONE=-1]="NONE",t[t.IDLE=0]="IDLE",t[t.ORBIT=1]="ORBIT",t[t.PAN=2]="PAN",t[t.DOLLY=3]="DOLLY"}(c||(c={}));class u{constructor(t){this.onMouseMove=t=>{var e=this._getModeForEvt(t);this.setMode(e),function(t,e,s){s[0]=2*t.clientX/(e.width/window.devicePixelRatio)-1,s[1]=-(2*t.clientY/(e.height/window.devicePixelRatio)-1)}(t,this.el,this.mouse),this.action.update(this.mouse)},this.el=t,this.mouse=i.vec3.fromValues(0,0,1),this.cam=null,this.orbitRadius=-10,this.mode=c.NONE}start(t){this.cam=t,this.el.addEventListener("mousemove",this.onMouseMove),this.mode=-1,this.setMode(c.IDLE)}stop(){this.cam=null,this.el.removeEventListener("mousemove",this.onMouseMove)}update(t){}setMode(t){if(this.mode!==t){switch(this.mode=t,t){case c.IDLE:this.action=new d;break;case c.ORBIT:this.action=new g;break;case c.PAN:this.action=new m;break;case c.DOLLY:this.action=new p}this.unproject(o),this.action.start(this.cam,o,this.mouse)}}unproject(t){this.cam.updateMatrix(),i.mat4.invert(l,this.cam.lens._proj),i.vec3.transformMat4(o,this.mouse,l),i.vec3.scale(o,o,this.orbitRadius/o[2]),i.vec3.transformMat4(t,o,this.cam._matrix)}_getModeForEvt(t){return 2!==t.which?c.IDLE:t.altKey?t.ctrlKey?c.DOLLY:c.ORBIT:c.PAN}}class d{start(t,e,s){}update(t){}}class g{constructor(){this.initialX=i.vec3.create(),this.initialR=i.quat.create(),this.initialP=i.vec3.create(),this.startMouse=i.vec3.create(),this.focus=i.vec3.create()}start(t,e,s){this.cam=t,i.vec3.copy(this.initialX,this.cam._matrix),i.vec3.copy(this.startMouse,s),i.quat.copy(this.initialR,t.rotation),i.vec3.subtract(this.initialP,t.position,e),i.vec3.copy(this.focus,e)}update(t){i.vec3.subtract(o,t,this.startMouse),i.quat.setAxisAngle(a,this.initialX,5*o[1]),i.quat.rotateY(r,n,5*-o[0]),i.quat.multiply(r,r,a),i.quat.multiply(this.cam.rotation,r,this.initialR),i.vec3.transformQuat(o,this.initialP,r),i.vec3.add(this.cam.position,this.focus,o),this.cam.invalidate()}}class m{constructor(){this.initialX=i.vec3.create(),this.initialY=i.vec3.create(),this.initialP=i.vec3.create(),this.startMouse=i.vec3.create(),this.focus=i.vec3.create()}start(t,e,s){this.cam=t,i.vec3.copy(this.initialX,this.cam._matrix),i.vec3.copy(this.initialP,this.cam.position),this.initialY[0]=this.cam._matrix[4],this.initialY[1]=this.cam._matrix[5],this.initialY[2]=this.cam._matrix[6],i.vec3.copy(this.startMouse,s),i.vec3.copy(this.focus,e)}update(t){i.vec3.subtract(o,t,this.startMouse),i.vec3.scale(h,this.initialX,10*-o[0]),i.vec3.scaleAndAdd(h,h,this.initialY,10*-o[1]),i.vec3.add(this.cam.position,this.initialP,h),this.cam.invalidate()}}class p{constructor(){this.initialZ=i.vec3.create(),this.initialP=i.vec3.create(),this.startMouse=i.vec3.create(),this.focus=i.vec3.create()}start(t,e,s){this.cam=t,i.vec3.copy(this.initialP,this.cam.position),i.vec3.subtract(this.initialZ,this.cam.position,e),i.vec3.copy(this.startMouse,s),i.vec3.copy(this.focus,e)}update(t){i.vec3.subtract(o,t,this.startMouse),i.vec3.scale(o,this.initialZ,5*o[1]),i.vec3.add(this.cam.position,this.initialP,o),this.cam.invalidate()}}},233:function(t,e,s){"use strict";s.d(e,"a",(function(){return u}));var i=s(78),n=s(224),r=s(1);const a=r.mat4.create(),o=new Float32Array(4),h=new Float32Array(4),l=new n.a;class c{constructor(t){this.onTouchEnd=()=>{this.touch.onEnd.off(this.onTouchEnd),this.onLost.emit(),this.active=!1,this.touch=null},this.touchPos=new Float32Array(3),this.touchWPos=new Float32Array(3),this.onPicked=new i.a,this.onLost=new i.a,this.picking=t,this.touch=null,this.active=!1}_updatePos(t){this.touchWPos[0]=t[0],this.touchWPos[1]=t[1],this.touchWPos[2]=t[2],r.mat4.invert(a,this.picking.node._wmatrix),r.vec3.transformMat4(this.touchPos,this.touchWPos,a)}_picked(t,e){this.touch&&this.onTouchEnd(),this._updatePos(e),this.touch=t,this.active=!0,t.onEnd.on(this.onTouchEnd),this.onPicked.emit()}}class u{constructor(t){this.onTouchAdded=t=>{l.unproject(t.coords,this.scene.camera),h.set([0,0,0,1e4]);for(var e=null,s=0;s<this.pickables.length;s++){0!==this.pickables[s].picking.raycast(l,o)&&h[3]>o[3]&&(e=this.pickables[s],h.set(o))}null!==e&&e._picked(t,h)},this.onTouchRemoved=t=>{},this.scene=t,this.pickables=[],this.inputs=this.scene.inputs,this.inputs.onTouchAdded.on(this.onTouchAdded),this.inputs.onTouchRemoved.on(this.onTouchRemoved)}registerPicking(t){for(var e=0;e<this.pickables.length;e++)if(this.pickables[e].picking===t)return this.pickables[e];var s=new c(t);return this.pickables.push(s),s}dispose(){this.inputs.onTouchAdded.off(this.onTouchAdded),this.inputs.onTouchRemoved.off(this.onTouchRemoved)}}},236:function(t,e){var s=function(t){return"attribute vec2 aPosition;\nattribute vec2 aTexCoord;\n\nvarying vec2 vTexCoord0;\n\n  \nvoid main( void ){\n\n  gl_Position = vec4( aPosition, 0.0, 1.0 );\n  vTexCoord0 = aTexCoord;\n\n}\n","attribute vec2 aPosition;\nattribute vec2 aTexCoord;\n\nvarying vec2 vTexCoord0;\n\n  \nvoid main( void ){\n\n  gl_Position = vec4( aPosition, 0.0, 1.0 );\n  vTexCoord0 = aTexCoord;\n\n}\n"};s.toString=s,t.exports=s},237:function(t,e){var s=function(t){return"\nvarying vec2 vTexCoord0;\n\nuniform sampler2D tTex;\n\nvoid main(void){\n  \n  vec4 tex = texture2D( tTex, vTexCoord0 );\n  gl_FragColor.rgb = tex.rgb;\n  gl_FragColor.a = tex.a;\n  // gl_FragColor.rgb = vec3(tex.a);\n  // gl_FragColor.a = 1.0;\n\n}\n","\nvarying vec2 vTexCoord0;\n\nuniform sampler2D tTex;\n\nvoid main(void){\n  \n  vec4 tex = texture2D( tTex, vTexCoord0 );\n  gl_FragColor.rgb = tex.rgb;\n  gl_FragColor.a = tex.a;\n  // gl_FragColor.rgb = vec3(tex.a);\n  // gl_FragColor.a = 1.0;\n\n}\n"};s.toString=s,t.exports=s},245:function(t,e,s){"use strict";s.d(e,"a",(function(){return n}));var i=s(225);class n{constructor(t){this._request=t,this._resources=[]}load(t,e){const s=new i.b(t,this._request,e);return this._resources.push(s),s}}},248:function(t,e,s){"use strict";s.d(e,"a",(function(){return m}));var i=s(1),n=s(81);const r=i.vec4.create(),a=i.vec3.create(),o=i.vec3.create(),h=i.vec3.create(),l=i.vec4.create(),c=i.vec3.create(),u=i.vec3.create(),d=i.vec3.create(),g=i.vec3.create();class m{constructor(t){this._length=0,this._invalids=[],this.alloc(t),this._lengthsSumsInvalid=!0,this._inversionRef=0}get numAnchors(){return this._length}get numSegments(){return this._length-3}setAnchors(t,e){var s=t.length,i=s>>2;i!=this._length&&this.alloc(i);for(var n=0;n<s;n++)this._anchors[n]=t[n];for(n=0;n<i-3;n++)this._updateV(n);this.computeNormals(e)}setAnchor3(t,e){r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=0,this.setAnchor(r,e)}setAnchor(t,e){var s=e<<2;this._anchors[s++]=t[0],this._anchors[s++]=t[1],this._anchors[s++]=t[2],this._anchors[s++]=t[3],this.invalidateAt(e)}setNormal(t,e){var s=3*e;this._snormals[s++]=t[0],this._snormals[s++]=t[1],this._snormals[s++]=t[2],this.invalidateAt(e)}posToTime(t){for(var e=0,s=this.getLenghtSums(),i=s.length,n=0;n<i;n++)if(t<(e=s[n]))return n+1-(e-t)/this._lengths[n];return-1}timeToPos(t){var e=this.getLenghtSums(),s=Math.floor(t),i=t-s,n=this._lengths;return 0==s?i*n[s]:e[s-1]+i*n[s]}getLenghtSums(){if(this._lengthsSumsInvalid){for(var t=this._lengths,e=this._lengthsSums,s=t.length,i=0,n=0;n<s;n++)e[n]=i+=t[n];this._lengthsSumsInvalid=!1}return this._lengthsSums}getSize(){var t=this.getLenghtSums();return t[t.length-1]}invalidateAt(t){var e=t;for((t-=3)<0&&(t=0),e>this._length-3&&(e=this._length-3);t<=e;)this.invalidateSeg(t++)}getAnchor(t,e){var s=e<<2;t[0]=this._anchors[s++],t[1]=this._anchors[s++],t[2]=this._anchors[s++],t[3]=this._anchors[s++]}getAnchorV3(t,e){var s=e<<2;t[0]=this._anchors[s++],t[1]=this._anchors[s++],t[2]=this._anchors[s++]}alloc(t){this._length=t,this._anchors=new Float64Array(t<<2),this._normals=new Float32Array(3*t),this._snormals=new Float32Array(this._normals.buffer,12,3*(t-2)),t-=3,this._v=new Float64Array(t<<4),this._lengths=new Float64Array(t),this._lengthsSums=new Float64Array(t),this._iv=new Float32Array(t<<4)}realloc(t){this._length=t;var e=new Float64Array(t<<2),s=new Float32Array(3*t);t-=3;var i=new Float64Array(t<<4),n=new Float64Array(t),r=new Float32Array(t<<4);e.set(this._anchors,0),i.set(this._v,0),r.set(this._iv,0),n.set(this._lengths,0),s.set(this._normals,0),this._anchors=e,this._v=i,this._iv=r,this._lengths=n,this._normals=s,this._snormals=new Float32Array(this._normals.buffer,12,3*(t-2)),this._lengthsSums=new Float64Array(t),this._lengthsSumsInvalid=!0}reallocFromStart(t){var e=t-this._length;this._length=t;var s=new Float64Array(t<<2),i=new Float32Array(3*t);t-=3;var n=new Float64Array(t<<4),r=new Float64Array(t),a=new Float32Array(t<<4);s.set(this._anchors,e<<2),i.set(this._normals,3*e),n.set(this._v,e<<4),a.set(this._iv,e<<4),r.set(this._lengths,e);for(var o=this._invalids,h=o.length,l=0;l<h;l++)o[l]+=e;this._anchors=s,this._v=n,this._iv=a,this._lengths=r,this._normals=i,this._snormals=new Float32Array(this._normals.buffer,12,3*(t-2)),this._lengthsSums=new Float64Array(t),this._lengthsSumsInvalid=!0}shift(t){const e=this._length-Math.abs(t);n.a.isTrue(e>0),t>0?this.copy(this,0,e,t):t<0&&this.copy(this,-t,this._length-1,0)}copy(t,e,s,i){void 0===i&&(i=0);var n=s-e+1,r=e<<2,a=e<<3;t._anchors.set(new Float64Array(this._anchors.buffer,a<<2,n<<2),i<<2),t._normals.set(new Float32Array(this._normals.buffer,3*r,3*n),3*i),n-=3,t._v.set(new Float64Array(this._v.buffer,a<<4,n<<4),i<<4),t._lengths.set(new Float64Array(this._lengths.buffer,a,n),i),t._iv.set(new Float32Array(this._iv.buffer,r<<4,n<<4),i<<4),t._lengthsSumsInvalid=!0}copySeg(t,e,s){console.log("CatmullSpline copyPoint ",e,s);var i=4,n=e<<2,r=e<<3;t._anchors.set(new Float64Array(this._anchors.buffer,r<<2,i<<2),s<<2),t._normals.set(new Float32Array(this._normals.buffer,3*n,3*i),3*s),i-=3,t._v.set(new Float64Array(this._v.buffer,r<<4,i<<4),s<<4),t._lengths.set(new Float64Array(this._lengths.buffer,r,i),s),t._iv.set(new Float32Array(this._iv.buffer,n<<4,i<<4),s<<4),t._lengthsSumsInvalid=!0}dispose(){}invalidateSeg(t){this._lengthsSumsInvalid=!0;var e=this._invalids;-1==e.indexOf(t)&&e.push(t)}getInvalidsSegs(){return this._invalids}compute(){for(var t=this._invalids,e=t.length,s=0;s<e;s++)this._updateV(t[s]);this._invalids=[]}computeAll(){for(var t=(this._anchors.length>>2)-3,e=0;e<t;e++)this._updateV(e);this._invalids=[]}length(){return this._length}getPositionAt(t,e){var s=this._v,i=Math.floor(t);t-=i,i<<=4;var n=t*t,r=t*n;e[0]=s[i+0]+t*s[i+1]+n*s[i+2]+r*s[i+3],e[1]=s[i+4]+t*s[i+5]+n*s[i+6]+r*s[i+7],e[2]=s[i+8]+t*s[i+9]+n*s[i+10]+r*s[i+11],e[3]=s[i+12]+t*s[i+13]+n*s[i+14]+r*s[i+15];const a=2*Math.PI;e[3]>a&&(e[3]-=a),e[3]<-a&&(e[3]+=a)}getPositionAtV3(t,e){var s=this._v,i=Math.floor(t);t-=i,i<<=4;var n=t*t,r=t*n;e[0]=s[i+0]+t*s[i+1]+n*s[i+2]+r*s[i+3],e[1]=s[i+4]+t*s[i+5]+n*s[i+6]+r*s[i+7],e[2]=s[i+8]+t*s[i+9]+n*s[i+10]+r*s[i+11]}getPositionAndTangentAt(t,e,s){var n=this._v,r=Math.floor(t),a=t-r;if((r<<=4)+15>=n.length)throw"";var o=a*a,h=a*o;e[0]=n[r+0]+a*n[r+1]+o*n[r+2]+h*n[r+3],e[1]=n[r+4]+a*n[r+5]+o*n[r+6]+h*n[r+7],e[2]=n[r+8]+a*n[r+9]+o*n[r+10]+h*n[r+11],e[3]=n[r+12]+a*n[r+13]+o*n[r+14]+h*n[r+15],a*=2,o*=3,s[0]=n[r+1]+a*n[r+2]+o*n[r+3],s[1]=n[r+5]+a*n[r+6]+o*n[r+7],s[2]=n[r+9]+a*n[r+10]+o*n[r+11],i.vec3.normalize(s,s);const l=2*Math.PI;e[3]>l&&(e[3]-=l),e[3]<-l&&(e[3]+=l)}getTangentAt(t,e){const s=this._v,n=Math.floor(t)<<4;let r=t-n;const a=r*r*3;r*=2,e[0]=s[n+1]+r*s[n+2]+a*s[n+3],e[1]=s[n+5]+r*s[n+6]+a*s[n+7],e[2]=s[n+9]+r*s[n+10]+a*s[n+11],i.vec3.normalize(e,e)}getCurvatureAt(t,e){const s=this._v,i=Math.floor(t)<<4;const n=6*(t-i);e[0]=2*s[i+2]+n*s[i+3],e[1]=2*s[i+6]+n*s[i+7],e[2]=2*s[i+10]+n*s[i+11]}transformVector(t,e,s){var n=s[0],r=s[1],c=Math.floor(t),u=c+1;c==u&&console.error("CatmullSpline transformVector");var d=t-c,g=1-d;a[0]=this._snormals[3*c]*g+this._snormals[3*u]*d,a[1]=this._snormals[3*c+1]*g+this._snormals[3*u+1]*d,a[2]=this._snormals[3*c+2]*g+this._snormals[3*u+2]*d,i.vec3.normalize(a,a),this.getPositionAndTangentAt(t,l,h),i.vec3.cross(o,a,h);var m=Math.cos(l[3]),p=Math.sin(l[3]),f=o[0]*m-a[0]*p,v=o[1]*m-a[1]*p,_=o[2]*m-a[2]*p,b=o[0]*p+a[0]*m,x=o[1]*p+a[1]*m,w=o[2]*p+a[2]*m;e[0]=n*f+r*b+l[0],e[1]=n*v+r*x+l[1],e[2]=n*_+r*w+l[2]}getTransformAt(t,e){var s=e,n=Math.floor(t),r=n+1,c=t-n,u=1-c;a[0]=this._snormals[3*n]*u+this._snormals[3*r]*c,a[1]=this._snormals[3*n+1]*u+this._snormals[3*r+1]*c,a[2]=this._snormals[3*n+2]*u+this._snormals[3*r+2]*c,i.vec3.normalize(a,a),this.getPositionAndTangentAt(t,l,h),i.vec3.cross(o,a,h),i.vec3.normalize(o,o),i.vec3.cross(a,h,o);var d=Math.cos(l[3]),g=Math.sin(l[3]);s[0]=o[0]*d-a[0]*g,s[1]=o[1]*d-a[1]*g,s[2]=o[2]*d-a[2]*g,s[3]=0,s[4]=o[0]*g+a[0]*d,s[5]=o[1]*g+a[1]*d,s[6]=o[2]*g+a[2]*d,s[7]=0,s[8]=h[0],s[9]=h[1],s[10]=h[2],s[11]=0,s[12]=l[0],s[13]=l[1],s[14]=l[2],s[15]=1}_updateV(t){this._lengthsSumsInvalid=!0;const e=this._anchors,s=this._iv,i=this._v;let n=t<<2,r=n+4,a=n+8,o=n+12;var h=t<<4,l=h;var c,u,d,g,m,p,f,v,_,b,x,w,C,T,P,S,E,y;f=s[l]=i[h++]=c=e[r],v=s[l+4]=i[h++]=.5*(-e[n]+e[a]),_=s[l+8]=i[h++]=1*e[n]+-2.5*e[r]+2*e[a]-.5*e[o],b=s[l+12]=i[h++]=-.5*e[n++]+1.5*e[r++]-1.5*e[a++]+.5*e[o++],x=s[l+1]=i[h++]=u=e[r],w=s[l+5]=i[h++]=.5*(-e[n]+e[a]),C=s[l+9]=i[h++]=1*e[n]+-2.5*e[r]+2*e[a]-.5*e[o],T=s[l+13]=i[h++]=-.5*e[n++]+1.5*e[r++]-1.5*e[a++]+.5*e[o++],P=s[l+2]=i[h++]=d=e[r],S=s[l+6]=i[h++]=.5*(-e[n]+e[a]),E=s[l+10]=i[h++]=1*e[n]+-2.5*e[r]+2*e[a]-.5*e[o],y=s[l+14]=i[h++]=-.5*e[n++]+1.5*e[r++]-1.5*e[a++]+.5*e[o++],s[l+3]=i[h++]=e[r],s[l+7]=i[h++]=.5*(-e[n]+e[a]),s[l+11]=i[h++]=1*e[n]+-2.5*e[r]+2*e[a]-.5*e[o],s[l+15]=i[h++]=-.5*e[n]+1.5*e[r]-1.5*e[a]+.5*e[o],c-=g=f+.25*(v+.25*(_+.25*b)),u-=m=x+.25*(w+.25*(C+.25*T)),d-=p=P+.25*(S+.25*(E+.25*y));var M=Math.sqrt(c*c+u*u+d*d);g-=c=f+.5*(v+.5*(_+.5*b)),m-=u=x+.5*(w+.5*(C+.5*T)),p-=d=P+.5*(S+.5*(E+.5*y)),M+=Math.sqrt(g*g+m*m+p*p),c-=g=f+.75*(v+.75*(_+.75*b)),u-=m=x+.75*(w+.75*(C+.75*T)),d-=p=P+.75*(S+.75*(E+.75*y)),M+=Math.sqrt(c*c+u*u+d*d),a=8+(t<<2),g-=e[a],m-=e[a+1],p-=e[a+2],M+=Math.sqrt(g*g+m*m+p*p),this._lengths[t]=M}getAnchorTangent(t,e){const s=this._v;t<this._length-3?(t<<=4,e[0]=this._v[t+1],e[1]=this._v[t+5],e[2]=this._v[t+9]):(t=t-1<<4,e[0]=s[t+1]+2*s[t+2]+3*s[t+3],e[1]=s[t+5]+2*s[t+6]+3*s[t+7],e[2]=s[t+9]+2*s[t+10]+3*s[t+11]),i.vec3.normalize(e,e)}computeNormals(t){var e=i.vec3.create();void 0!==t?i.vec3.copy(e,t):e[1]=1;var s=this._snormals;this.getTangentAt(0,d),i.vec3.cross(u,d,e),i.vec3.cross(e,u,d),s[0]=e[0],s[1]=e[1],s[2]=e[2],this.computeNormalsFrom(1)}computeNormalsFrom(t){if(t<1||t>this._length-1)throw new Error("index out of bounds");const e=c,s=d,n=g,r=this._snormals,a=t-1;e[0]=r[3*a+0],e[1]=r[3*a+1],e[2]=r[3*a+2];for(var o=t;o<this._length-2;o++)this.getAnchorTangent(o,s),this.getAnchorTangent(o-1,n),i.vec3.cross(u,n,e),i.vec3.normalize(u,u),i.vec3.cross(e,u,s),i.vec3.normalize(e,e),r[3*o+0]=e[0],r[3*o+1]=e[1],r[3*o+2]=e[2]}logDataAt(t){console.log("CatmullSpline logDataAt "+t);var e=t+1<<2,s=3*t;console.log("  a0    : ",this._anchors[e],this._anchors[e+1],this._anchors[e+2],this._anchors[e+3]),console.log("  a1    : ",this._anchors[e+4],this._anchors[e+5],this._anchors[e+6],this._anchors[e+7]),console.log("  nrm0  : ",this._normals[s],this._normals[s+1],this._normals[s+2]),console.log("  nrm1  : ",this._normals[s+3],this._normals[s+4],this._normals[s+5])}}},276:function(t,e,s){"use strict";s.d(e,"a",(function(){return l}));var i=s(76),n=s(77),r=s(277),a=s.n(r),o=s(278),h=s.n(o);class l{constructor(t,e,s=32){var n=t.gl;this.gl=n,this.scene=t,this.blurSamples=s,this.size=e,this.spread=1,this.blurCfg=t.glstate.config().enableCullface(!1).depthMask(!1).enableDepthTest(!1),this.blurPrg=new i.a(n,a()(),h()(),"#define NUM_SAMPLES "+this.blurSamples),this.blurKernelA=new Float32Array(3*this.blurSamples),this.blurKernelB=new Float32Array(3*this.blurSamples),this.computeKernel(this.blurKernelA,!0,1/this.size),this.computeKernel(this.blurKernelB,!1,1/this.size),this.blurA_fbo=this.makeBlurFbo(!0),this.blurB_fbo=this.makeBlurFbo()}process(t){var e=this.blurPrg;this.gl.clearColor(0,0,0,0),this.blurCfg.apply(),e.use(),e.uSpread(this.spread);var s=this.scene.quad;s.attribPointer(e),this.blurA_fbo.bind(),e.tInput(t),e.uKernel(this.blurKernelA),s.render(),this.blurB_fbo.bind(),e.tInput(this.blurA_fbo.getColor()),e.uKernel(this.blurKernelB),s.render()}getBlurredTex(){return this.blurB_fbo.getColorTexture()}getBlurredFbo(){return this.blurB_fbo}makeBlurFbo(t=!1){const e=this.gl,s=new n.a(e);s.bind(),s.attachColor(t?e.RGBA:e.RGB,e.UNSIGNED_BYTE),s.resize(this.size,this.size);const i=s.getColorTexture();return i.bind(),i.clamp(),i.setFilter(!0,!1,!1),s}computeKernel(t,e,s){for(var i=e?0:1,n=e?1:0,r=Math.sqrt(Math.PI),a=0,o=0;o<this.blurSamples;++o){var h=3*o,l=o-Math.round((this.blurSamples-1)/2),c=4*l/this.blurSamples;a+=c=Math.exp(-c*c/2)/r,t[h+i]=l*s,t[h+n]=0,t[h+2]=c}for(o=0;o<this.blurSamples;++o)t[3*o+2]/=a}}},277:function(t,e){var s=function(t){return"precision highp float;\n\n\nattribute vec2 aPosition;\nattribute vec2 aTexCoord;\n\nvarying vec2 vTexCoord;\n\n  \nvoid main( void ){\n\n  gl_Position = vec4( aPosition, 0.0, 1.0 );\n  vTexCoord = aTexCoord;\n\n}\n","precision highp float;\n\n\nattribute vec2 aPosition;\nattribute vec2 aTexCoord;\n\nvarying vec2 vTexCoord;\n\n  \nvoid main( void ){\n\n  gl_Position = vec4( aPosition, 0.0, 1.0 );\n  vTexCoord = aTexCoord;\n\n}\n"};s.toString=s,t.exports=s},278:function(t,e){var s=function(t){return"precision highp float;\n\n\nvarying vec2 vTexCoord;\n\nuniform sampler2D tInput;\nuniform float uSpread;\nuniform vec3 uKernel[NUM_SAMPLES];\n\n\n\nvoid main(void){\n\n  vec3 color = vec3( 0.0 );\n\n  float alpha = .02 + .98*texture2D( tInput, vTexCoord ).a;\n\n  for(int i=0; i<NUM_SAMPLES; ++i)\n  {\n    vec3 kernel = uKernel[i].xyz;\n    color += texture2D( tInput, vTexCoord + kernel.xy * uSpread * alpha ).xyz * kernel.z;\n  }\n\n\n  gl_FragColor = vec4( color, alpha );// * 0.00001 + texture2D( tInput, vTexCoord );\n  \n\n}\n","precision highp float;\n\n\nvarying vec2 vTexCoord;\n\nuniform sampler2D tInput;\nuniform float uSpread;\nuniform vec3 uKernel[NUM_SAMPLES];\n\n\n\nvoid main(void){\n\n  vec3 color = vec3( 0.0 );\n\n  float alpha = .02 + .98*texture2D( tInput, vTexCoord ).a;\n\n  for(int i=0; i<NUM_SAMPLES; ++i)\n  {\n    vec3 kernel = uKernel[i].xyz;\n    color += texture2D( tInput, vTexCoord + kernel.xy * uSpread * alpha ).xyz * kernel.z;\n  }\n\n\n  gl_FragColor = vec4( color, alpha );// * 0.00001 + texture2D( tInput, vTexCoord );\n  \n\n}\n"};s.toString=s,t.exports=s},365:function(t,e){var s=function(t){return"attribute vec2 aPosition;\nattribute vec2 aTexCoord;\n\nvarying vec2 vTexCoord0;\nuniform mat4 uUnproject;\n\nvarying vec3 vTexCoord;\n\nvoid main( void ){\n\n  vec4 pos = vec4( aPosition, 0.99, 1.0 );\n\n\n  vTexCoord0 = aTexCoord;\n  vTexCoord = normalize( (uUnproject * pos).xyz );\n\n  gl_Position = pos;\n\n\n}\n","attribute vec2 aPosition;\nattribute vec2 aTexCoord;\n\nvarying vec2 vTexCoord0;\nuniform mat4 uUnproject;\n\nvarying vec3 vTexCoord;\n\nvoid main( void ){\n\n  vec4 pos = vec4( aPosition, 0.99, 1.0 );\n\n\n  vTexCoord0 = aTexCoord;\n  vTexCoord = normalize( (uUnproject * pos).xyz );\n\n  gl_Position = pos;\n\n\n}\n"};s.toString=s,t.exports=s},366:function(t,e,s){var i=function(t){var e="";return e+="\nvarying vec2 vTexCoord0;\nvarying vec3 vTexCoord;\n\nuniform sampler2D tTex;\nuniform float uExposure;\nuniform float uGamma;\n\n"+s(273)()+"\n"+s(274)()+"\n\n\n#define EXPOSURE(color) color *= vec3( uExposure );\n#define GAMMA_CORRECTION(color) color = pow( color, vec3( uGamma ) );\n\nconst vec2 _IBL_UVM = vec2(\n  0.25*(254.0/256.0),\n  0.5*(254.0/256.0)\n);\n\nvec4 SampleBg( sampler2D tEnv, vec3 skyDir )\n{\n\n  vec2 uvA = octwrapDecode( skyDir );\n  uvA = uvA * _IBL_UVM + vec2(0.5);\n\n  return texture2D( tEnv, uvA );\n}\n\n\nvoid main(void){\n  \n  // vec4 tex = texture2D( tTex, vTexCoord0 );\n  vec4 tex = SampleBg(tTex, vTexCoord);\n  vec3 color = decodeRGBE(tex);\n  EXPOSURE(color)\n  GAMMA_CORRECTION(color)\n  gl_FragColor.rgb = color;\n  gl_FragColor.a = 1.0;\n  // gl_FragColor.rgb = vec3(tex.a);\n  // gl_FragColor.a = 1.0;\n\n}\n"};i.toString=i,t.exports=i},380:function(t,e,s){var i=function(t){var e="";return e+="#define CMULL_SEGS "+t.num_segs+"\n\nuniform lowp vec2 spline_params; // slide, scale\nuniform lowp vec4 spline_iv[  CMULL_SEGS*4 ];\nuniform lowp vec3 spline_nrm[ CMULL_SEGS+1 ];\n\n"+s(381)()};i.toString=i,t.exports=i},381:function(t,e){var s=function(t){return"#ifndef _INC_CATMULL\n#define _INC_CATMULL 1\n\nvoid catmullWarp( inout vec3 pos, inout vec3 nrm, highp float cmullt ){\n\n  cmullt *= float( CMULL_SEGS );\n  \n  float t = cmullt - floor(cmullt + 0.00001);\n  int i = int(cmullt-t);\n\n  vec3 nrmA = spline_nrm[i];\n  vec3 nrmB = spline_nrm[i+1];\n  \n  vec3 up = normalize( mix( nrmA, nrmB, t ) );\n\n\n  i *= 4;\n\n  vec4 sp1 = spline_iv[ i ];\n  vec4 sp2 = spline_iv[ i + 1 ];\n  vec4 sp3 = spline_iv[ i + 2 ];\n  vec4 sp4 = spline_iv[ i + 3 ];\n  \n  // catmull pos\n  vec4 ppos = t * ( t * ( t * sp4 + sp3 ) + sp2 ) + sp1;\n\n  // catmull tangent\n  // vec3 ptan = t * ( t * ( t * sp4.xyz + sp3.xyz ) + sp2.xyz ) + sp1.xyz;\n  // ptan = normalize( ptan - ppos.xyz );\n\n  vec3 ptan = t * ( t * sp4.xyz * 3.0 + sp3.xyz * 2.0 ) + sp2.xyz;\n  ptan = normalize( ptan );\n\n\n\n  float rcos = cos( ppos.w );\n  float rsin = sin( ppos.w );\n  vec3 cros = normalize( cross( up, ptan ) );\n  up = normalize( cross( ptan, cros ) );\n\n\n  vec3 mvxx = cros*rcos - up*rsin;\n  vec3 mvxy = cros*rsin + up*rcos;\n\n\n  mat3 rotation  = mat3( mvxx, mvxy, ppos ); \n  pos = rotation * vec3( pos.xy, 1.0 );\n\n  rotation[2] = ptan; \n  nrm = rotation * nrm;\n  \n}\n\n#endif","#ifndef _INC_CATMULL\n#define _INC_CATMULL 1\n\nvoid catmullWarp( inout vec3 pos, inout vec3 nrm, highp float cmullt ){\n\n  cmullt *= float( CMULL_SEGS );\n  \n  float t = cmullt - floor(cmullt + 0.00001);\n  int i = int(cmullt-t);\n\n  vec3 nrmA = spline_nrm[i];\n  vec3 nrmB = spline_nrm[i+1];\n  \n  vec3 up = normalize( mix( nrmA, nrmB, t ) );\n\n\n  i *= 4;\n\n  vec4 sp1 = spline_iv[ i ];\n  vec4 sp2 = spline_iv[ i + 1 ];\n  vec4 sp3 = spline_iv[ i + 2 ];\n  vec4 sp4 = spline_iv[ i + 3 ];\n  \n  // catmull pos\n  vec4 ppos = t * ( t * ( t * sp4 + sp3 ) + sp2 ) + sp1;\n\n  // catmull tangent\n  // vec3 ptan = t * ( t * ( t * sp4.xyz + sp3.xyz ) + sp2.xyz ) + sp1.xyz;\n  // ptan = normalize( ptan - ppos.xyz );\n\n  vec3 ptan = t * ( t * sp4.xyz * 3.0 + sp3.xyz * 2.0 ) + sp2.xyz;\n  ptan = normalize( ptan );\n\n\n\n  float rcos = cos( ppos.w );\n  float rsin = sin( ppos.w );\n  vec3 cros = normalize( cross( up, ptan ) );\n  up = normalize( cross( ptan, cros ) );\n\n\n  vec3 mvxx = cros*rcos - up*rsin;\n  vec3 mvxy = cros*rsin + up*rcos;\n\n\n  mat3 rotation  = mat3( mvxx, mvxy, ppos ); \n  pos = rotation * vec3( pos.xy, 1.0 );\n\n  rotation[2] = ptan; \n  nrm = rotation * nrm;\n  \n}\n\n#endif"};s.toString=s,t.exports=s},382:function(t,e){var s=function(t){return"float catmullTime = vertex.position.z * spline_params.y + spline_params.x;\ncatmullWarp( vertex.position, vertex.normal, clamp(catmullTime, 0.0, 0.99 ) );","float catmullTime = vertex.position.z * spline_params.y + spline_params.x;\ncatmullWarp( vertex.position, vertex.normal, clamp(catmullTime, 0.0, 0.99 ) );"};s.toString=s,t.exports=s},383:function(t,e,s){var i=function(t){var e="";return e+="#pragma SLOT version\n\n#pragma SLOT definitions\n\n\n#ifndef hasNormals\n  #define hasNormals 1\n#endif \n#ifndef hasTangents\n  #define hasTangents hasNormals\n#endif \n\n#if hasTangents && !hasNormals \n  #pragma error tan but no nrm\n  error\n#endif\n\n#pragma SLOT precision\n\n"+s(75)()+"\n\n#pragma SLOT pv\n\n\nIN vec3 aPosition;\n\n#if hasNormals\nIN vec3 aNormal;\nOUT mediump vec3 vWorldNormal;\n#endif\n\n// has normal map and tangent attribute\n#if hasTangents\nIN vec4 aTangent;\n#endif\n\n#if HAS_normal && hasTangents\nOUT mediump vec3 vWorldTangent;\nOUT mediump vec3 vWorldBitangent;\n#endif\n\n\n// uniform mat4 uMVP;\nuniform mat4 uWorldMatrix;\nuniform mat4 uVP;\n\nOUT vec3 vWorldPosition;\n\n\n\n\n\n#if perVertexIrrad\n  OUT vec3 vIrradiance;\n  uniform vec4 uSHCoeffs[7];\n  "+s(127)()+"\n#endif\n\n\n\nvec3 rotate( mat4 m, vec3 v )\n{\n  return m[0].xyz*v.x + m[1].xyz*v.y + m[2].xyz*v.z;\n}\n\n\nstruct VertexData {\n  highp vec3 position;\n  highp vec3 worldPos;\n  #if hasNormals\n    vec3 normal;\n  #endif\n  #if hasTangents\n    vec3 tangent;\n  #endif\n  mat4 worldMatrix;\n};\n\n\nvoid InitVertexData( out VertexData vertex ){\n\n  vertex.position = aPosition;\n  #if hasNormals\n    vertex.normal = aNormal;\n  #endif\n  #if hasTangents\n    vertex.tangent = aTangent.xyz;\n  #endif\n\n  vertex.worldMatrix = uWorldMatrix;\n   \n}\n\nOUT lowp vec3 vScreen;\n\nvoid main( void ){\n\n  #pragma SLOT v\n\n  VertexData vertex;\n  InitVertexData( vertex );\n\n  #pragma SLOT vertex_warp\n\n  vec4 worldPos = vertex.worldMatrix * vec4( vertex.position, 1.0 );\n  vertex.worldPos.xyz = worldPos.xyz / worldPos.w;\n\n  #pragma SLOT vertex_warp_world\n\n  gl_Position     = uVP * vec4( vertex.worldPos, 1.0 );\n  vWorldPosition  = vertex.worldPos;\n  \n  #if hasNormals\n  vWorldNormal    = normalize( rotate( vertex.worldMatrix, vertex.normal ) );\n  #endif\n\n  #if HAS_normal && hasTangents\n    vWorldTangent   = normalize( rotate( vertex.worldMatrix, vertex.tangent.xyz ) );\n    vWorldBitangent = normalize( cross( vWorldNormal, vWorldTangent ) * aTangent.w );\n  #endif\n\n  #if perVertexIrrad\n    vIrradiance = SampleSH( vWorldNormal, uSHCoeffs );\n  #endif\n\n  vScreen = gl_Position.xyw;\n}\n"};i.toString=i,t.exports=i},384:function(t,e,s){var i=function(t){var e="";return e+="#pragma SLOT version\n\n#pragma SLOT definitions\n\n\n#ifndef hasNormals\n  #define hasNormals 1\n#endif \n#ifndef hasTangents\n  #define hasTangents hasNormals\n#endif \n\n#if hasTangents && !hasNormals \n  #pragma error tan but no nrm\n  error\n#endif\n\n\n#if !hasTangents && __VERSION__ != 300\n  #extension GL_OES_standard_derivatives : enable\n#endif \n\n#pragma SLOT precision\n\n"+s(74)()+"\n"+s(133)()+"\n\n#pragma SLOT pf\n\n\nuniform vec3 uCameraPosition;\nIN vec3 vWorldPosition;\n\n#if hasNormals\nIN mediump vec3 vWorldNormal;\n#endif \n\n#if HAS_normal && hasTangents\nIN mediump vec3 vWorldTangent;\nIN mediump vec3 vWorldBitangent;\n#endif \n\n\n\nIN lowp vec3 vScreen;\nuniform sampler2D tReflect;\n\nstruct InputData\n{\n    vec3  worldPos;\n    mediump vec3   worldNrm;\n    mediump vec3   viewDir;\n};\n\n\n"+s(134)()+"\n"+s(135)()+"\n"+s(136)()+"\n"+s(137)()+"\n"+s(138)()+"\n\n\n\n\nvoid InitializeBRDFData(SurfaceData surface, out BRDFData brdf)\n{\n    mediump float reflectivity = ReflectivitySpecular(surface.specular);\n    mediump float oneMinusReflectivity = 1.0 - reflectivity;\n\n    brdf.diffuse = surface.albedo * (vec3(1.0, 1.0, 1.0) - surface.specular);\n    brdf.specular = surface.specular;\n\n    brdf.grazingTerm = saturate(surface.smoothness + reflectivity);\n    brdf.perceptualRoughness = PerceptualSmoothnessToPerceptualRoughness(surface.smoothness);\n    brdf.roughness = max(PerceptualRoughnessToRoughness(brdf.perceptualRoughness), 0.001);\n    brdf.roughness2 = brdf.roughness * brdf.roughness;\n\n    brdf.normalizationTerm = brdf.roughness * 4.0 + 2.0;\n    brdf.roughness2MinusOne = brdf.roughness2 - 1.0;\n\n}\n\nfloat F_SchlickTest( float VoH,float glo )\n{\n  return glo*glo * pow( 1.0-VoH, 5.0 );\n}\n\n\n//                MAIN\n// ===================\n\nvoid main( void ){\n\n  #pragma SLOT f\n\n\n  SurfaceData surface;\n  #pragma SLOT pbrsurface\n\n  #if alphaMode( MASK )\n    if( surface.alpha < alphaCutoff() ) discard;\n  #endif\n\n  //\n  #ifdef HAS_vertexColor\n  #if HAS_vertexColor\n    surface.albedo *= vertexColor();\n  #endif\n  #endif\n\n  // -----------\n\n\n  InputData inputData;\n  inputData.worldPos = vWorldPosition;\n  inputData.viewDir  = normalize( uCameraPosition - vWorldPosition ); // safe normalize?\n  inputData.worldNrm = normalize(COMPUTE_NORMAL());\n  // inputData.vertexLighting = input.fogFactorAndVertexLight.yzw;\n\n\n  BRDFData brdfData;\n  InitializeBRDFData( surface, brdfData );\n\n  // used by IBL reflexion\n  // --------------\n  vec3 worldReflect = reflect( -inputData.viewDir, inputData.worldNrm );\n  float NoV = sdot( inputData.viewDir, inputData.worldNrm );\n\n\n  vec3 diffuseContrib = vec3(0.0);\n  vec3 specularContrib = vec3(0.0);\n\n  vec3 color = vec3(0.0);\n\n  #define LS_SPECULAR specularContrib\n  #define LS_DIFFUSE  diffuseContrib\n\n  #pragma SLOT lightsf\n\n\n  #if enableReflect\n    vec2 screenUV = (vScreen.xy/vScreen.z)*.5+.5;\n    vec3 ref = texture2D( tReflect, screenUV ).rgb;\n    ref = pow( ref, vec3(2.2) ) * reflectIntensity();\n    // ref = ref/.25;\n    specularContrib += ref;\n    // if( ref.r > 0.0 ){\n    //     specularContrib = ref;\n    // }\n    // specularContrib = max( ref, specularContrib );\n  #endif\n\n\n  specularContrib *= F_Schlick( NoV, brdfData.specular, surface.smoothness );\n  color += surface.occlusion * (diffuseContrib*brdfData.diffuse + specularContrib);\n\n\n  color += surface.emission;\n\n\n\n\n  #if alphaMode( MASK )\n    FragColor.a = 1.0;\n  #elif alphaMode( BLEND )\n    FragColor.a = surface.alpha;\n  #else\n    FragColor.a = 1.0;\n  #endif\n\n\n//   vec3 color = diffuseContrib*surface.albedo + specularContrib;\n\n\n//  #if HAS_occlusion\n//     float _occlusion = occlusion();\n//     #if HAS_occlusionStrength\n//       _occlusion = 1.0 - occlusionStrength() + _occlusion*occlusionStrength();\n//     #endif\n//     color *= _occlusion;\n//   #endif\n\n\n  FragColor.rgb = color;\n\n\n  #pragma SLOT postf_linear\n\n\n  EXPOSURE(FragColor.rgb);\n\n\n// #if HAS_normal && hasTangents\n  // vec3 nrmnn = inputData.worldNrm;\n  // nrmnn.z *= -1.0;\n  // nrmnn = nrmnn * .5 + .5;\n  // FragColor.rgb = FragColor.rgb*0.0001 + nrmnn ;\n// #endif\n  // FragColor.rgb = FragColor.rgb*0.0001 + specularContrib;\n  // FragColor.rgb = FragColor.rgb*0.0001 + surface.smoothness;\n  // FragColor.rgb = FragColor.rgb*0.0001 + surface.specular;\n  // FragColor.rgb = FragColor.rgb*0.0001 + brdfData.diffuse;\n\n  \n//   FragColor.rgb = FragColor.rgb*0.0001 + ref;\n\n//   FragColor.rgb = FragColor.rgb*0.0001 + F_SchlickTest( NoV, 1.0 );//surface.smoothness ) ;\n  GAMMA_CORRECTION(FragColor.rgb);\n\n  #pragma SLOT postf\n\n\n\n\n  // FragColor.a = 1.0;\n\n  // FragColor.rgb = FragColor.rgb*0.0001 + color;\n  // #ifdef HAS_specular\n  // #if HAS_specular\n  //   FragColor.rgb = FragColor.rgb*0.0001 + specular();\n  // #endif\n  // #endif\n  // FragColor.rgb = FragColor.rgb*0.0001 + surface.smoothness;\n  // FragColor.rgb = FragColor.rgb*0.0001 + specularContrib;\n  // FragColor.rgb = FragColor.rgb*0.0001 + albedo();\n  // FragColor.rgb = FragColor.rgb*0.0001 + albedoSq;\n  // FragColor.rgb = FragColor.rgb*0.0001 + diffuseContrib;\n  // FragColor.rgb = FragColor.rgb*0.0001 + worldNormal;\n  // FragColor.rgb = FragColor.rgb*0.0001 + vWorldNormal;\n  // FragColor.rgb = FragColor.rgb*0.0001 + vWorldBitangent;\n  // FragColor.rgb = FragColor.rgb*0.0001 + vWorldTangent;\n  // FragColor.rgb = FragColor.rgb*0.0001 + vec3(1.0, 0.0, 0.0);\n  // FragColor.rg = vec2(0.0);\n\n  // pure mirror\n\n  // vec3 _rr = reflect( -viewDir, vWorldNormal );\n  // vec3 purerefl = SpecularIBL( tEnv, _rr, 0.0 );\n  // FragColor.rgb = FragColor.rgb*0.0001 + purerefl;\n\n  #if HAS_normal\n  // FragColor.rgb = FragColor.rgb*0.0001 + normal();\n  #endif\n\n  #if HAS_occlusion\n    // FragColor.rgb = FragColor.rgb*0.0001 + occlusion();\n  #endif\n\n\n  // #ifdef HAS_GI\n  // #if HAS_GI\n  //   FragColor.rgb = FragColor.rgb*0.0001 + gi;\n  // #endif\n  // #endif\n\n\n}"};i.toString=i,t.exports=i},385:function(t,e){var s=function(t){return"FragColor.rgb *= exposure();","FragColor.rgb *= exposure();"};s.toString=s,t.exports=s},386:function(t,e){var s=function(t){return"\n// IBL \n{\n  LS_DIFFUSE  += ComputeIBLDiffuse( inputData.worldNrm );\n  LS_SPECULAR += SpecularIBL( tEnv, worldReflect*vec3(1, -1, -1 ) );\n}\n","\n// IBL \n{\n  LS_DIFFUSE  += ComputeIBLDiffuse( inputData.worldNrm );\n  LS_SPECULAR += SpecularIBL( tEnv, worldReflect*vec3(1, -1, -1 ) );\n}\n"};s.toString=s,t.exports=s},387:function(t,e,s){var i=function(t){var e="";return e+="\n\n#ifndef _H_SPECULAR_RPROBE_\n#define _H_SPECULAR_RPROBE_\n\n"+s(273)()+"\n"+s(274)()+"\n\n#if __VERSION__ == 300\n  #define textureCube(a,b) texture( a, b )\n#endif\n\n// IBL\n// ========\nuniform samplerCube tEnv;\n\n#if perVertexIrrad\n  IN vec3 vIrradiance;\n#else\n  uniform vec4 uSHCoeffs[7];\n  "+s(127)()+"\n#endif\n\n\nvec3 SpecularIBL( samplerCube tEnv, vec3 skyDir)\n{\n  return textureCube( tEnv, skyDir ).rgb;\n}\n\n\n\nvec3 ComputeIBLDiffuse( vec3 worldNormal ){\n  #if perVertexIrrad\n    return vIrradiance;\n  #else\n    return SampleSH(worldNormal, uSHCoeffs );\n  #endif\n}\n\n#endif"};i.toString=i,t.exports=i},388:function(t,e){var s=function(t){return"\nuniform float uDotRingProgress;\n\n\nfloat DR_remap( float lum, float width, float offset ){\n    return clamp( (lum/width)-(offset/width), 0.0, 1.0);\n}\n\n\nvoid DotRingEffect( inout vec4 color ){\n    // sample the texture\n    float lum = color.r;\n    float radialPos = baseColor_texCoord().y;\n\n    float dist = radialPos - 2.0 + uDotRingProgress*3.0;\n    float offset = exp( -dist*dist*2.0 ) - exp(-8.0);\n    lum = DR_remap( lum, .15, 1.0-offset );\n\n    color = vec4(DotRingColor()*lum, 1.0);\n}","\nuniform float uDotRingProgress;\n\n\nfloat DR_remap( float lum, float width, float offset ){\n    return clamp( (lum/width)-(offset/width), 0.0, 1.0);\n}\n\n\nvoid DotRingEffect( inout vec4 color ){\n    // sample the texture\n    float lum = color.r;\n    float radialPos = baseColor_texCoord().y;\n\n    float dist = radialPos - 2.0 + uDotRingProgress*3.0;\n    float offset = exp( -dist*dist*2.0 ) - exp(-8.0);\n    lum = DR_remap( lum, .15, 1.0-offset );\n\n    color = vec4(DotRingColor()*lum, 1.0);\n}"};s.toString=s,t.exports=s},389:function(t,e){var s=function(t){return"  #if fogMode( NONE )\n  #else\n\n    float fogDist = 0.0;\n\n    // fogDist = length( uCameraPosition - vWorldPosition );\n    fogDist = gl_FragCoord.z / gl_FragCoord.w;\n\n\tCalcFog( FragColor.rgb, fogDist );\n  #endif","  #if fogMode( NONE )\n  #else\n\n    float fogDist = 0.0;\n\n    // fogDist = length( uCameraPosition - vWorldPosition );\n    fogDist = gl_FragCoord.z / gl_FragCoord.w;\n\n\tCalcFog( FragColor.rgb, fogDist );\n  #endif"};s.toString=s,t.exports=s},390:function(t,e){var s=function(t){return"\nvoid CalcFog( inout vec3 baseColor, float fragDist )\n{\n\tfloat fogFactor = 1.0;\n\n    #if fogMode( EXP )\n\t    float fogDensity = fogParams().z;\n\t\tfogFactor = 1.0 / exp( fragDist * fogDensity);\n    \n    #elif fogMode( EXP2 )\n\t    float fogDensity = fogParams().z;\n\t\tfogFactor = 1.0 / exp( fragDist * fragDist * fogDensity * fogDensity);\n    \n    #elif fogMode( LINEAR )\n        float fogStart   = fogParams().x;\n        float fogEnd     = fogParams().y;\n\t\tfogFactor = (fogEnd - fragDist) / (fogEnd - fogStart);\n\t    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    #endif\n\n    baseColor = mix( fogColor(), baseColor, fogFactor );\n}","\nvoid CalcFog( inout vec3 baseColor, float fragDist )\n{\n\tfloat fogFactor = 1.0;\n\n    #if fogMode( EXP )\n\t    float fogDensity = fogParams().z;\n\t\tfogFactor = 1.0 / exp( fragDist * fogDensity);\n    \n    #elif fogMode( EXP2 )\n\t    float fogDensity = fogParams().z;\n\t\tfogFactor = 1.0 / exp( fragDist * fragDist * fogDensity * fogDensity);\n    \n    #elif fogMode( LINEAR )\n        float fogStart   = fogParams().x;\n        float fogEnd     = fogParams().y;\n\t\tfogFactor = (fogEnd - fragDist) / (fogEnd - fogStart);\n\t    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    #endif\n\n    baseColor = mix( fogColor(), baseColor, fogFactor );\n}"};s.toString=s,t.exports=s},391:function(t,e){var s=function(t){return"  #if fogMode( NONE )\n  #else\n\n    float fogDist = gl_FragCoord.z / gl_FragCoord.w;\n    float fogY = 1.0 - (gl_FragCoord.y / uScreenHeight);\n    fogY = fogY*fogY;\n\n\tCalcFog( FragColor.rgb, fogDist, fogY );\n  #endif","  #if fogMode( NONE )\n  #else\n\n    float fogDist = gl_FragCoord.z / gl_FragCoord.w;\n    float fogY = 1.0 - (gl_FragCoord.y / uScreenHeight);\n    fogY = fogY*fogY;\n\n\tCalcFog( FragColor.rgb, fogDist, fogY );\n  #endif"};s.toString=s,t.exports=s},392:function(t,e){var s=function(t){return"uniform float uScreenHeight;\n\nvoid CalcFog( inout vec3 baseColor, float fragDist, float fogY )\n{\n\tfloat fogFactor = 1.0;\n\n    #if fogMode( EXP )\n\t    float fogDensity = fogParams().z;\n\t\tfogFactor = 1.0 / exp( fragDist * fogDensity);\n    \n    #elif fogMode( EXP2 )\n\t    float fogDensity = fogParams().z;\n\t\tfogFactor = 1.0 / exp( fragDist * fragDist * fogDensity * fogDensity);\n    \n    #elif fogMode( LINEAR )\n        float fogStart   = fogParams().x;\n        float fogEnd     = fogParams().y;\n\t\tfogFactor = (fogEnd - fragDist) / (fogEnd - fogStart);\n\t    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    #endif\n\n    vec3 fogColor = mix( fogColor1(), fogColor2(), fogY );\n\n    baseColor = mix( fogColor, baseColor, fogFactor );\n}","uniform float uScreenHeight;\n\nvoid CalcFog( inout vec3 baseColor, float fragDist, float fogY )\n{\n\tfloat fogFactor = 1.0;\n\n    #if fogMode( EXP )\n\t    float fogDensity = fogParams().z;\n\t\tfogFactor = 1.0 / exp( fragDist * fogDensity);\n    \n    #elif fogMode( EXP2 )\n\t    float fogDensity = fogParams().z;\n\t\tfogFactor = 1.0 / exp( fragDist * fragDist * fogDensity * fogDensity);\n    \n    #elif fogMode( LINEAR )\n        float fogStart   = fogParams().x;\n        float fogEnd     = fogParams().y;\n\t\tfogFactor = (fogEnd - fragDist) / (fogEnd - fogStart);\n\t    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    #endif\n\n    vec3 fogColor = mix( fogColor1(), fogColor2(), fogY );\n\n    baseColor = mix( fogColor, baseColor, fogFactor );\n}"};s.toString=s,t.exports=s},393:function(t,e,s){t.exports=function(){"use strict";const t=function(t,e){const s="number"==typeof t?{value:t}:t;Object.entries(s).map(([t,s])=>e(s,t))};function e(t,e){this.start=new Date/1e3,this.time=e,this.from=t,this.current=t,this.to=t,this.speed=0}return e.prototype.get=function(t){const e=t/1e3-this.start;if(e<0)throw new Error("Cannot read in the past");return e>=this.time?this.to:this.to-((t,e,s,i)=>(e*s+2*t)/s**3*i**3+-(2*e*s+3*t)/s**2*i**2+e*i+t)(this.to-this.from,this.speed,this.time,e)},e.prototype.getSpeed=function(t){const e=t/1e3-this.start;return e>=this.time?0:((t,e,s,i)=>(e*s+2*t)/s**3*3*i**2+-(2*e*s+3*t)/s**2*2*i+e)(this.to-this.from,this.speed,this.time,e)},e.prototype.set=function(t,e){const s=new Date,i=this.get(s);return this.speed=this.getSpeed(s),this.start=s/1e3,this.from=i,this.to=t,e&&(this.time=e),i},function(s,i=300){return"number"==typeof s&&(s={value:s}),t(s,(t,n)=>{const r=new e(t,i/1e3);Object.defineProperty(s,"_"+n,{value:r}),Object.defineProperty(s,n,{get:()=>r.get(new Date),set:t=>r.set(t),enumerable:!0})}),Object.defineProperty(s,"get",{get:()=>function(t="value",e=new Date){return this["_"+t].get(e)}}),Object.defineProperty(s,"set",{get:()=>function(e,s=0){t(e,(t,e)=>{this["_"+e].set(t,s/1e3)})}}),s}}()},394:function(t,e){var s=function(t){return"precision lowp float;\n\nuniform vec3 uColor1;\nuniform vec3 uColor2;\n\nvarying vec2 vCoords;\n\nvoid main( void ){\n    float ypos = vCoords.x/vCoords.y;\n    ypos = ypos*-.5 + .5;\n    ypos = ypos*ypos;\n    vec3 gcolor = mix( uColor1, uColor2, ypos );\n    gl_FragColor = vec4( gcolor, 1.0 );\n\n}","precision lowp float;\n\nuniform vec3 uColor1;\nuniform vec3 uColor2;\n\nvarying vec2 vCoords;\n\nvoid main( void ){\n    float ypos = vCoords.x/vCoords.y;\n    ypos = ypos*-.5 + .5;\n    ypos = ypos*ypos;\n    vec3 gcolor = mix( uColor1, uColor2, ypos );\n    gl_FragColor = vec4( gcolor, 1.0 );\n\n}"};s.toString=s,t.exports=s},395:function(t,e){var s=function(t){return"\nattribute vec2 aPosition;\nvarying vec2 vCoords;\n\nvoid main( void ){\n    gl_Position = vec4( aPosition, 1.0, 1.0 );\n    vCoords = gl_Position.yw;\n}","\nattribute vec2 aPosition;\nvarying vec2 vCoords;\n\nvoid main( void ){\n    gl_Position = vec4( aPosition, 1.0, 1.0 );\n    vCoords = gl_Position.yw;\n}"};s.toString=s,t.exports=s},396:function(t,e){var s=function(t){return"attribute vec3 aData;\n\nuniform mat4 uMVP;\nuniform float uTime;\n\nvoid main( void ){\n    gl_Position = uMVP * vec4( aData.xy, 0.0, 1.0 );\n    float dist = 1.0 - length( aData.xy )/20.0;\n    // dist = pow( dist, .3);\n    // dist = .3 + .7 * dist;\n\n    float sinf = sin( uTime + aData.z )*.5 + .5;\n    sinf = pow( sinf, .3);\n\n    gl_PointSize = dist * sinf * 16.0;\n}","attribute vec3 aData;\n\nuniform mat4 uMVP;\nuniform float uTime;\n\nvoid main( void ){\n    gl_Position = uMVP * vec4( aData.xy, 0.0, 1.0 );\n    float dist = 1.0 - length( aData.xy )/20.0;\n    // dist = pow( dist, .3);\n    // dist = .3 + .7 * dist;\n\n    float sinf = sin( uTime + aData.z )*.5 + .5;\n    sinf = pow( sinf, .3);\n\n    gl_PointSize = dist * sinf * 16.0;\n}"};s.toString=s,t.exports=s},397:function(t,e){var s=function(t){return"\nprecision lowp float;\n\nuniform sampler2D uTex;\n\nconst vec3 color = vec3(0.855,0.796,0.584);\n\nvoid main( void ){\n    float lum = texture2D( uTex, gl_PointCoord.xy*2.0 ).r;\n    gl_FragColor = vec4(color, lum );\n}","\nprecision lowp float;\n\nuniform sampler2D uTex;\n\nconst vec3 color = vec3(0.855,0.796,0.584);\n\nvoid main( void ){\n    float lum = texture2D( uTex, gl_PointCoord.xy*2.0 ).r;\n    gl_FragColor = vec4(color, lum );\n}"};s.toString=s,t.exports=s},400:function(t,e){var s=function(t){return"\n\n{\n\n  #define CS_SAMPLES 8\n  #define CS_P .068\n  vec2 tc = texCoordVP - vec2(.5);\n\n//   if( tc.x < 0.0 ){\n\n\n    for( int i = 0; i < CS_SAMPLES; i++ ){\n        float shift = float(i)/float(CS_SAMPLES-1);\n\n        vec2 ftc = tc * (1.0 + uAmount*(shift - .5));\n        c += texture2D( tInput, ftc + .5 ).xyz * texture2D( tChromaShiftTex, vec2( shift * (1.0-2.0*CS_P) + CS_P , .5 ) ).rgb;\n    }\n\n\n    c /= (float( CS_SAMPLES ) *.4);\n//   }\n}","\n\n{\n\n  #define CS_SAMPLES 8\n  #define CS_P .068\n  vec2 tc = texCoordVP - vec2(.5);\n\n//   if( tc.x < 0.0 ){\n\n\n    for( int i = 0; i < CS_SAMPLES; i++ ){\n        float shift = float(i)/float(CS_SAMPLES-1);\n\n        vec2 ftc = tc * (1.0 + uAmount*(shift - .5));\n        c += texture2D( tInput, ftc + .5 ).xyz * texture2D( tChromaShiftTex, vec2( shift * (1.0-2.0*CS_P) + CS_P , .5 ) ).rgb;\n    }\n\n\n    c /= (float( CS_SAMPLES ) *.4);\n//   }\n}"};s.toString=s,t.exports=s},401:function(t,e){var s=function(t){return"\nuniform sampler2D tChromaShiftTex;\n\nuniform float uAmount;","\nuniform sampler2D tChromaShiftTex;\n\nuniform float uAmount;"};s.toString=s,t.exports=s},402:function(t,e){var s=function(t){return"uniform vec4 uGrainCoord;\nuniform vec2 uGrainScaleBias;\nuniform sampler2D tGrain;","uniform vec4 uGrainCoord;\nuniform vec2 uGrainScaleBias;\nuniform sampler2D tGrain;"};s.toString=s,t.exports=s},403:function(t,e){var s=function(t){return"\nc += c * (uGrainScaleBias.x * texture2D(tGrain,texCoordVP*uGrainCoord.xy+uGrainCoord.zw).x+uGrainScaleBias.y);","\nc += c * (uGrainScaleBias.x * texture2D(tGrain,texCoordVP*uGrainCoord.xy+uGrainCoord.zw).x+uGrainScaleBias.y);"};s.toString=s,t.exports=s},404:function(t,e,s){t.exports=s.p+"assets/img/logo-repair-racer-71710509.png"},405:function(t,e,s){t.exports=s.p+"assets/img/poster-game1-rule1-0edb0e95.jpg"},406:function(t,e,s){t.exports=s.p+"assets/img/poster-game1-rule2-ab5ab597.jpg"},407:function(t,e,s){t.exports=s.p+"assets/img/poster-game1-rule3-1e81ca72.jpg"},408:function(t,e,s){var i={"./share-challenge-game-1-desktop.png":409,"./share-challenge-game-1-mobile.png":410};function n(t){var e=r(t);return s(e)}function r(t){if(!s.o(i,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return i[t]}n.keys=function(){return Object.keys(i)},n.resolve=r,t.exports=n,n.id=408},409:function(t,e,s){t.exports=s.p+"assets/img/share-challenge-game-1-desktop-50c81190.png"},410:function(t,e,s){t.exports=s.p+"assets/img/share-challenge-game-1-mobile-ecdbb1d0.png"},411:function(t,e,s){t.exports=s.p+"assets/img/share-game-1-ebe01d89.png"},508:function(t,e,s){"use strict";s.r(e);var i=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"module-games"},[s("score-ui",{attrs:{active:t.isStarted&&!t.gameState.ended,score:t.gameState.score,health:t.gameState.health}}),t._v(" "),t.isLoaded?s("scoreboard",{attrs:{"is-game-ended":t.gameState.ended,"game-id":t.gameState.gameId,score:t.finalScore,"product-img":this.getResource("share-product"),"push-img":this.getResource("share-push"),"share-game-img":this.getResource("share-game"),"share-game-canvas-img":this.getResource("share-game-canvas"),"share-label":t.t("gaming.score_name_points"),"share-text-y":225,"share-text-x":0,"game-thumbnails":[this.getResource("game-thumbnail-1"),this.getResource("game-thumbnail-2"),this.getResource("game-thumbnail-3"),this.getResource("game-thumbnail-4")]},on:{onRestart:t.onClickRestart}}):t._e(),t._v(" "),s("instructions-panel",{ref:"loader",attrs:{active:t.instructionActive,onStart:t.onStart,title:t.t("gaming.game1_name"),legends:[t.labelForDesktop("gaming.game1_tuto1","gaming.game1_tuto1_desktop"),t.t("gaming.game1_tuto2"),t.t("gaming.game1_tuto3")],videos:["/assets/video/rules/game1-rule1.mp4","/assets/video/rules/game1-rule2.mp4","/assets/video/rules/game1-rule3.mp4"],posters:[this.getResource("poster-rule1"),this.getResource("poster-rule2"),this.getResource("poster-rule3")],background:this.getResource("game-preview"),logo:this.getResource("game-logo")}}),t._v(" "),s("PraiseCvs",{ref:"praise",staticClass:"praise-game-1"})],1)};i._withStripped=!0;var n=s(218),r=s(239),a=s(27),o=s(230),h=s(76),l=s(236),c=s.n(l),u=s(237),d=s.n(u),g=s(365),m=s.n(g),p=s(366),f=s.n(p);h.a.debug=!1;class v{constructor(t){const e=t.gl;e.getExtension("OES_standard_derivatives"),this.hasHighp=function(t){const e=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT);return t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT).precision>0&&e.precision>0}(e),this.programs=[this.debugFbo=new h.a(e),this.sky=new h.a(e)],this.compile()}precision(){return this.hasHighp?"highp":"mediump"}compile(){var t="\n";t+="precision "+this.precision()+" float;\n",this.debugFbo.compile(c()(),d()(),t),this.sky.compile(m()(),f()(),t),this.process()}process(){for(var t of this.programs)t.use()}dispose(){for(let t=0;t<this.programs.length;t++)this.programs[t].dispose();this.programs=null}}var _=s(28),b=s(229),x=s(257),w=s(275),C=s(37),T=s(40),P=s(247),S=s(3),E=s(26),y=s(36),M=s(291),F=s(87);const R=["Helipad","Ice_Lake","LA_Downtown_Afternoon_Fishing","lakeside_2k","palermo_square_2k","unity_sky","royal_esplanade_2k","SD_tomoco_studio"];var A=class{constructor(t){this.EXPO=1,this.GAMMA=1/2.2,this.convertSH=t=>{this.shBase=new Float32Array(t,0,27),this.ibl.sh=P.a.convert(this.shBase,this.shMul)};const e=t.gl;this.scene=t,this.gl=e,this.envTex=new y.a(this.gl,this.gl.RGBA),this.envHi=new y.a(this.gl,this.gl.RGBA),this.envBg=new y.a(this.gl,this.gl.RGB),this.ibl=new w.a(this.envTex,this.envHi,this.envBg),this.envTex.setFilter(!1),this.lights=new M.a(t),this.lights.setup.add(this.ibl),this.shMul=1,this.gammaMode=new E.a("gammaMode",F.a),this.gamma=new S.d("gamma",1,S.d.ALL),this.exposure=new S.d("exposure",1,S.d.ALL),this.gammaMode.set("GAMMA_STD"),this.expoUniform=this.exposure.attachUniform("utmExpo"),this.gammaUniform=this.gamma.attachUniform("uTMGamma"),this.expoUniform.set(1),this.gammaUniform.set(1/2.2)}setupLinear(){this.expoUniform.set(1),this.gammaUniform.set(1)}setupGamma(){this.expoUniform.set(1),this.gammaUniform.set(1/2.2)}setupMat(t){var e,s,i;t.setLightSetup(this.lights.setup),null===(e=t.iGamma)||void 0===e||e.proxy(this.gamma),null===(s=t.iExposure)||void 0===s||s.proxy(this.exposure),null===(i=t.gammaMode)||void 0===i||i.proxy(this.gammaMode)}setupMatTM(t){var e,s,i;null===(e=t.iGamma)||void 0===e||e.proxy(this.gamma),null===(s=t.iExposure)||void 0===s||s.proxy(this.exposure),null===(i=t.gammaMode)||void 0===i||i.proxy(this.gammaMode)}dispose(){this.envTex.dispose(),this.envHi.dispose(),this.envBg.dispose(),this.envTex=null,this.envHi=null,this.envBg=null,this.ibl=null,this.scene=null,this.shBase=null,this.shMul=1}async loadDefault(){return this.load("envs/"+R[0])}async load(t){return Promise.all([C.d(T.a.asset_url(t+"/env.png")).then(t=>this.envTex.fromImage(t)),C.c(T.a.asset_url(t+"/sh.bin")).then(this.convertSH)])}preRender(){this.lights.preRender()}},L=s(30),D=s(82),I=s(242),k=s(231),O=s(232),B=s(233),N=s(234),G=s(219),U=s(217),z=s(248),W=s(1);function H(t){for(var e=4022871197,s=t.toString(),i=0;i<s.length;i++){var n=.02519603282416938*(e+=s.charCodeAt(i));n-=e=n>>>0,e=(n*=e)>>>0,e+=4294967296*(n-=e)}return 2.3283064365386963e-10*(e>>>0)}class V{constructor(t){this.c=1,this.s0=H(0),this.s1=H(0),this.s2=H(0),this.s0-=H(t),this.s0<0&&(this.s0+=1),this.s1-=H(t),this.s1<0&&(this.s1+=1),this.s2-=H(t),this.s2<0&&(this.s2+=1)}next(){var t=2091639*this.s0+2.3283064365386963e-10*this.c;return this.s0=this.s1,this.s1=this.s2,this.s2=t-(this.c=0|t)}double(){return this.next()+11102230246251565e-32*(2097152*this.next()|0)}int32(){return 4294967296*this.next()|0}}class X{constructor(t=0){this.seed=0|t,this.index=0,this.impl=new V(t)}static next(){return this.global.next()}reset(t=this.seed){this.seed=t,this.index=0,this.impl=new V(this.seed)}next(){return this.impl.double()}}X.global=new X(51623);class q{constructor(t,e=1,s=1){this.prng=new X(t),this.factors=new Float64Array(256),this.amplitude=s,this.scale=e,this._val=0,this._p=0,this.reset()}reset(){this._p=0;var t=this.factors,e=this.prng;e.reset();for(var s=0;s<256;s++)t[s]=e.next()}next(t=1){var e=this.factors;this._p+=this.scale*t;var s=this._p,i=Math.floor(s),n=s-i,r=n*n*(3-2*n),a=255&i,o=a+1&255;return(function(t,e,s){return t*(1-s)+e*s}(e[a],e[o],r)-.5)*this.amplitude}}W.mat4.create(),W.mat4.create(),W.mat4.create(),W.mat3.create(),W.vec3.create(),W.vec3.create(),W.vec3.fromValues(0,0,1),W.quat.create(),W.quat.create();const Y=5,j=.6,K=.5,Q=0;class Z{constructor(t=987654){this.seed=t,this.currentTilt=0,this.currentSegment=0,this.debugHist=[],this.reset()}reset(){this.safePathPrng=new X(this.seed+234),this.chaosDirX=new q(this.seed+10,.2),this.chaosDirY=new q(this.seed+110,.1),this.chaosTilt=new q(this.seed+210,8),this.currentMatrix=W.mat4.create(),this.currentXAxis=new Float32Array(this.currentMatrix.buffer,0,3),this.currentYAxis=new Float32Array(this.currentMatrix.buffer,16,3),this.currentZAxis=new Float32Array(this.currentMatrix.buffer,32,3),this.currentPos=new Float32Array(this.currentMatrix.buffer,48,3),this.currentSegment=0,this.currentTilt=0}normalizeMatrix(){W.vec3.normalize(this.currentXAxis,this.currentXAxis),W.vec3.cross(this.currentZAxis,this.currentXAxis,this.currentYAxis),W.vec3.normalize(this.currentZAxis,this.currentZAxis),W.vec3.cross(this.currentYAxis,this.currentZAxis,this.currentXAxis),W.vec3.normalize(this.currentYAxis,this.currentYAxis)}recenter(t){W.vec3.add(this.currentPos,this.currentPos,t)}getNext(t){this.currentSegment++;const e=this.chaosDirX.next(),s=this.chaosDirY.next();let i=this.chaosTilt.next();const r=Object(n.d)((this.currentSegment-Y)/15);W.mat4.rotateY(this.currentMatrix,this.currentMatrix,e*j*r),W.mat4.rotateX(this.currentMatrix,this.currentMatrix,s*K*r),W.vec3.scaleAndAdd(this.currentPos,this.currentPos,this.currentZAxis,et.SEG_LEN),this.normalizeMatrix(),this.debugHist.push(new Float32Array(this.currentMatrix)),this.debugHist.length>50&&this.debugHist.shift(),this.currentTilt=(2*e+i*Q)*r,t[0]=this.currentPos[0],t[1]=this.currentPos[1],t[2]=this.currentPos[2],t[3]=this.currentTilt,t[4]=this.currentYAxis[0],t[5]=this.currentYAxis[1],t[6]=this.currentYAxis[2],t[7]=this.safePathPrng.next()-.5}}var $=s(81);const J=W.vec3.create(),tt=new Float64Array(8);$.a.isTrue(!0);class et{constructor(t){this.game=t,this._mainOffset=0,this.maxSegments=12,this.spline=new z.a(15),this.safePath=new z.a(15),this.generator=new Z(1596248)}get mainOffset(){return this._mainOffset}recenter(){this.spline.getPositionAtV3(0,J),W.vec3.scale(J,J,-1);const t=this.spline._anchors,e=this.spline._length;for(let s=0;s<e;s++){const e=4*s;t[e+0]+=J[0],t[e+1]+=J[1],t[e+2]+=J[2]}this.generator.recenter(J),this.game.camCtrl.recenter(J),this.game.ptrail.recenter(J)}set currentPosition(t){if(t+6>this._mainOffset+12){const e=Math.floor(t)-1,s=e-this._mainOffset;this.spline.shift(-s),this.safePath.shift(-s),this._mainOffset=e;const i=12-s+3,n=this.spline._anchors,r=this.spline._normals,a=this.safePath._anchors;for(let t=i;t<15;t++){const e=4*t,s=3*t;this.generator.getNext(tt),n[e+0]=tt[0],n[e+1]=tt[1],n[e+2]=tt[2],n[e+3]=tt[3],r[s+0]=tt[4],r[s+1]=tt[5],r[s+2]=tt[6],a[e+0]=tt[7],this.spline.invalidateAt(t),this.safePath.invalidateAt(t)}this.recenter(),this.spline.computeAll(),this.safePath.compute()}}reset(){this._mainOffset=0,this.generator.seed=this.game.mainSeed+4758,this.generator.reset(),this.initializePath()}initializePath(){const t=this.spline.numAnchors,e=this.spline._anchors,s=this.spline._normals,i=this.safePath._anchors;for(let n=0;n<t;n++){this.generator.getNext(tt);const t=4*n,r=3*n;e[t+0]=tt[0],e[t+1]=tt[1],e[t+2]=tt[2],e[t+3]=tt[3],s[r+0]=tt[4],s[r+1]=tt[5],s[r+2]=tt[6],i[t+0]=tt[7]}this.spline.computeAll(),this.safePath.computeAll()}}et.SEG_LEN=5;var st=s(7),it=s(380),nt=s.n(it),rt=s(382),at=s.n(rt);class ot extends st.a{constructor(t){super(!0,!0),this.numSegments=t,this.scale=1,this.offset=0,this.spline_params=new Float32Array(2),this.spline_iv=null,this.spline_nrm=null}setSpline(t,e=0){t===this.spline&&e===this.sOffset||(this.spline=t,this.sOffset=e,this.spline_iv=new Float32Array(t._iv.buffer,16*e*4,16*this.numSegments),this.spline_nrm=new Float32Array(t._snormals.buffer,3*e*4,3*this.numSegments+3))}_genCode(t){t.add("vertex_warp",at()()),t.add("pv",nt()({num_segs:this.numSegments}))}setup(t){this.spline_params[0]=this.offset,this.spline_params[1]=this.scale,t.spline_params(this.spline_params),t.spline_iv(this.spline_iv),t.spline_nrm(this.spline_nrm)}}var ht={init(){},drawGuizmo(t){},drawFrustum(t){},clear(){},render(){}},lt=s(383),ct=s.n(lt),ut=s(384),dt=s.n(ut),gt=s(13),mt=s(92);class pt extends mt.a{constructor(t="standard-pass"){super(t),this._shaderSource={uid:"trkstd",vert:ct()(),frag:dt()()},this.reflectTex=null,this.inputs.add(this.enableReflect=new gt.a("enableReflect",!0)),this.inputs.add(this.reflectIntensity=new S.d("reflectIntensity",1)),this.reflectIntensity.attachConstant(3)}prepare(t,e,s){super.prepare(t,e,s),t.tReflect&&t.tReflect(this.reflectTex)}}var ft=s(80),vt=s(79),_t=s(223);class bt{constructor(t){this.game=t,this.lineLum=2,this.reflectEanbled=!0}init(){const t=this.game.scene.cmnTexs;this.renderable=this.game.assets.getRenderable("Track"),this.game.track.root.add(this.renderable.node),this.splineDeformer=new ot(7);const e=this.game.assets.getPass("Track"),s=new pt;this.trackPass=s,s.setSurface(e.surface),s.surface.baseColor.attachConstant(Object(_t.d)(789778)),s.surface.baseColorFactor.detach(),s.emissive.attachSampler("temmisive",vt.b.create()).set(t.get("tex_track_emissive")),s.enableReflect.set(!0),s.glconfig._set=e.glconfig._set,s.glconfig._dat.set(e.glconfig._dat),s.glconfig.enableCullface(!1),s.reflectTex=this.game.reflect.getOutput(),s.inputs.add(this.game.assets.fog);const i=new S.c("reflectamnt",1);this.reflectIntensity=i,i.set(30),s.reflectIntensity.attach(i),this.game.scene.iblMngr.setupMat(s),s.mask=e.mask;const n=new ft.a(this.game.scene.gl);n.addPass(s,U.a.COLOR),n.inputs.add(this.splineDeformer),this.renderable.materials[0]=n,this.renderable.materials[1].inputs.add(this.splineDeformer);const r=this.game.scene.gl;this.lineSection=new y.a(r,r.LUMINANCE,r.UNSIGNED_BYTE);const a=Math.exp(-4),o=new Uint8Array(16);for(let t=0;t<16;t++){let e=t/15;e=4*e-2,e=Math.exp(-e*e)-a,o[t]=Math.floor(255*e)}this.lineSection.fromData(16,1,o),this.lineSection.clamp(),this.lineSection.setFilter(!0,!0,!0),r.generateMipmap(r.TEXTURE_2D);const h=this.game.assets.getPass("TrackLines");h.mask=G.a.BLENDED|G.a.REFLECTED,h.glconfig.enableBlend().blendFunc(r.ONE,r.ONE).depthMask(!1),h.baseColor.attachSampler("lemmisive",vt.b.create()).set(this.lineSection),this.lineEmissiveUniform=new S.c("bcf",3),h.baseColorFactor.attach(this.lineEmissiveUniform),this.lineEmissiveUniform.set(this.lineLum,this.lineLum,this.lineLum)}enableReflect(t){this.reflectEanbled!=t&&(this.reflectEanbled=t,this.trackPass.enableReflect.set(t),t?this.trackPass.reflectIntensity.attach(this.reflectIntensity):this.trackPass.reflectIntensity.attachConstant(0))}render(t){const e=this.game.track,s=this.game.player.progression-.5-e.path.mainOffset,i=s-Math.floor(s);this.splineDeformer.setSpline(e.path.spline,Math.floor(s));this.splineDeformer.scale=1/35*(6/7),this.splineDeformer.offset=i/7,this.renderable.render(this.game.scene,t.camera,t.mask,t.pass)}debugDraw(){const t=this.game.track.path,e=W.mat4.create(),s=W.vec3.fromValues(.5,.05,.05);W.vec3.fromValues(.1,.01,.01),W.vec3.create();for(const i of t.generator.debugHist)W.mat4.multiply(e,this.game.track.playerInvMatrix,i),W.mat4.scale(e,e,s),ht.drawGuizmo(e)}}W.mat3.create(),W.vec3.create(),W.vec3.create(),W.vec3.create(),W.vec3.fromValues(0,1,0);const xt=W.mat4.create(),wt=W.vec3.create();class Ct{constructor(t){this.game=t,this.numLanes=7,this.playerMatrix=W.mat4.create(),this.playerInvMatrix=W.mat4.create(),this.path=new et(t),this.root=new a.a,this.renderer=new bt(t),this.game.scene.root.add(this.root)}reset(){this.path.reset()}render(t){this.renderer.render(t)}getLanePosition(t){return(t+.5)/this.numLanes-.5}getSafePositionAt(t){return this.path.safePath.getPositionAtV3(this.getSplineCoord(t),wt),wt[0]}getPositionAt(t,e){this.path.spline.getPositionAt(this.getSplineCoord(t),e)}getPositionAtV3(t,e){this.path.spline.getPositionAtV3(this.getSplineCoord(t),e)}getPositionAndTangentAt(t,e,s){this.path.spline.getPositionAndTangentAt(this.getSplineCoord(t),e,s)}getTransformAt(t,e){this.path.spline.getTransformAt(this.getSplineCoord(t),e)}transformVector(t,e,s){this.path.spline.transformVector(this.getSplineCoord(t),e,s)}getMaxTime(){return this.path.spline._length-3.001+this.path.mainOffset}getSplineCoord(t){return t-this.path.mainOffset}preRender(){const t=this.game.player.progression;this.path.currentPosition=t,this.getTransformAt(t,xt),W.mat4.invert(xt,xt),this.root.setMatrix(xt)}graphUpdate(){this.playerInvMatrix.set(this.root._wmatrix)}}const Tt=W.mat3.create();const Pt=W.mat4.create(),St=new Float32Array(Pt.buffer,0,3),Et=new Float32Array(Pt.buffer,16,3),yt=new Float32Array(Pt.buffer,32,3),Mt=new Float32Array(Pt.buffer,48,3),Ft=new Float32Array([0,1,0]);function Rt(t,e,s,i=Ft){W.vec3.subtract(yt,e,s),W.vec3.cross(St,i,yt),W.vec3.cross(Et,yt,St),W.vec3.normalize(St,St),W.vec3.normalize(Et,Et),W.vec3.normalize(yt,yt),Mt.set(e),t.set(Pt)}var At=s(221);const Lt=W.quat.create(),Dt=W.vec3.create(),It=W.vec3.create(),kt=W.vec3.create(),Ot=(W.vec3.create(),W.mat4.create()),Bt=W.mat4.create(),Nt=W.mat4.create(),Gt=(new Float32Array(Ot.buffer,0,3),new Float32Array(Ot.buffer,16,3)),Ut=(new Float32Array(Ot.buffer,32,3),new Float32Array(Ot.buffer,48,3)),zt=W.quat.create();W.quat.rotateY(zt,zt,Math.PI);class Wt{constructor(t){this.game=t,this.localpos=W.vec3.fromValues(0,.48,-1.6),this.localtgt=W.vec3.fromValues(0,.23,0),this.rlocal=W.vec3.create(),this.fov=25*n.a,this.posSplineOffset=.0301,this.tgtSplineOffset=.1001,this.following=.2,this.smoothPos=W.vec3.create(),this.introProgress=0,this.vertigoFactor=0,this.shakiness=0,this.camera=this.createGameCamera(),t.track.root.add(this.camera),this.shakeChaosX=new q(3578691,30,.05),this.shakeChaosY=new q(1248964,30,.05)}createGameCamera(){const t=new L.a(new D.a);return t.lens.setAutoFov(this.fov),t.lens.near=.1,t.lens.far=40,t}getTargetTransform(t,e,s,i){const n=this.game.track;var r,a;n.getTransformAt(t+this.tgtSplineOffset,Ot),W.vec3.scaleAndAdd(Ut,Ut,Gt,1-this.introProgress),W.vec3.transformMat4(It,this.localtgt,Ot),n.getTransformAt(t+this.posSplineOffset,Ot),W.vec3.scaleAndAdd(Ut,Ut,Gt,1-this.introProgress),n.getPositionAtV3(t+1.5,kt),W.mat4.invert(Nt,Ot),W.vec3.transformMat4(kt,kt,Nt),this.rlocal.set(this.localpos),kt[1]<0&&(this.rlocal[1]+=-.8*kt[1]),W.vec3.transformMat4(e,this.rlocal,Ot),i.set(Ot),Rt(Ot,e,It,W.vec3.fromValues(Ot[4],Ot[5],Ot[6])),r=s,a=Ot,W.mat3.fromMat4(Tt,a),W.quat.fromMat3(r,Tt)}reset(){this.shakiness=0,this.vertigoFactor=0;const{camera:t,player:e}=this.game;this.getTargetTransform(e.progression,Dt,Lt,Bt),this.smoothPos.set(Dt),t.rotation.set(Lt),t.invalidate()}shake(t=.7){this.shakiness=1,At.a.stopByTarget(this),At.a.to(this,{shakiness:0},t).start()}recenter(t){W.vec3.add(this.smoothPos,this.smoothPos,t)}preRender(){const{camera:t,player:e}=this.game,s=this.game.scene.dt,i=60*s;t.scale.set([1,1,1]);const n=1.7*e.speedupGain.value;this.vertigoFactor+=.01*(n-this.vertigoFactor)*i,this.updateFov(),this.getTargetTransform(e.progression,Dt,Lt,Bt),W.quat.slerp(t.rotation,t.rotation,Lt,.05*i),this.rlocal[0]=e.trackX*this.following,W.mat4.invert(Ot,Bt),W.vec3.transformMat4(Dt,this.smoothPos,Ot);let r=Math.min(1,3*s),a=Math.min(1,10*s);Dt[0]=Dt[0]*(1-r)+this.rlocal[0]*r,Dt[1]=Dt[1]*(1-r)+this.rlocal[1]*r,Dt[2]=Dt[2]*(1-a)+this.rlocal[2]*a,W.vec3.transformMat4(this.smoothPos,Dt,Bt),t.position.set(this.smoothPos);const o=1.5*Math.tan(this.fov),h=this.fov*(1+this.vertigoFactor),l=1.5-o/Math.tan(h);t.invalidate(),t.updateMatrix();const c=t._matrix;c[12]-=c[8]*l,c[13]-=c[9]*l,c[14]-=c[10]*l;const u=this.shakiness;if(u>0){const t=u*this.shakeChaosX.next(s),e=u*this.shakeChaosY.next(s);c[12]+=c[0]*t,c[13]+=c[1]*t,c[14]+=c[2]*t,c[12]+=c[4]*e,c[13]+=c[5]*e,c[14]+=c[6]*e}t.setMatrix(c)}updateFov(){const t=this.game.scene.glview,e=t.width/t.height;let s=this.fov*(1+this.vertigoFactor);e>.5?(s=2*Math.atan(Math.tan(s/2)/.5),this.camera.lens.setVerticalFov(s)):this.camera.lens.setHorizontalFov(s)}}class Ht{constructor(){this.matteColor=Object(_t.d)(790295),this.matteColorLight=Object(_t.d)(6782911),this.blackBlocs=Object(_t.d)(463653)}}var Vt=s(228),Xt=s(2),qt=s(245);var Yt=new qt.a({options:{bbc:!1,flipY:!1,filtering:9729,wrap:0,genMips:!1},sources:[{codec:"basis",lods:[{files:["/assets/webgl/Game1_Track_emissive_7833a0d2ce005b747c6abaa729a96d71.basis"],buffers:null}],datas:null},{codec:"std",lods:[{files:["/assets/webgl/Game1_Track_emissive_7833a0d2ce005b747c6abaa729a96d71.jpg"],buffers:null}],datas:null}]});var jt=new qt.a({options:{bbc:!1,flipY:!1,filtering:9729,wrap:0,genMips:!1},sources:[{codec:"std",lods:[{files:["/assets/webgl/Game1Lightmaps_basecolor_6959c65f1f3b8bf1516ae87e4655fcca.jpg"],buffers:null}],datas:null}]});var Kt=s(385),Qt=s.n(Kt);class Zt extends st.a{constructor(){super(!0,!1),this.iExposure=new S.d("exposure",1,S.b.FRAGMENT),this.addChild(this.iExposure)}setConstant(t){this.iExposure.attachConstant(t)}_genCode(t){t.add("postf",Qt()())}}var $t=s(294),Jt=s(238),te=s(386),ee=s.n(te),se=s(387),ie=s.n(se);class ne extends Jt.b{constructor(t,e){super(t,e),this.type=12}static registerLighModel(t){t.registerLightModel(new ne(ee.a,ie.a))}genCodePerLights(t,e,s){return this.codeTemplate(this)}prepare(t,e){}addLight(t){if(this.lights.length>0)throw new Error("IblModel support only one Ibl Light");super.addLight(t)}setup(t){if(this.lights.length>0){const e=this.lights[0];t.tEnv&&t.tEnv(e.bindable),t.uSHCoeffs&&t.uSHCoeffs(e.baseIbl.sh)}}}class re extends st.a{constructor(t){super(!0,!1),this.game=t}_genCode(t){t.add("pv","OUT float vTfogMix;"),t.add("v","vTfogMix = clamp( -aPosition.y*2.0, 0.0, 1.0 );"),t.add("pf","IN float vTfogMix;"),t.add("postf","\n        vec3 fogColor = mix( fogColor1(), fogColor2(), fogY );\n        FragColor.rgb = mix( FragColor.rgb, fogColor, vTfogMix );")}}var ae,oe=s(388),he=s.n(oe);class le extends st.a{constructor(){super(!0,!0),this.progress=0,this.color=new S.d("DotRingColor",3),this.color.attachConstant([1,1,1]),this.addChild(this.color)}_genCode(t){t.add("pf",he()()),t.add("postf","DotRingEffect(FragColor);")}setup(t){t.uDotRingProgress(this.progress)}}function ce(t,...e){for(let s=0;s<e.length;s++)if(0===t.indexOf(e[s]))return!0;return!1}!function(t){t.DarkCube="DarkCube",t.GlowingYellow="GlowingYellow",t.GoldenBall="GoldenBall",t.PlayerWhite="PlayerWhite",t.PlayerGlow="PlayerGlow",t.Score10="Score10",t.Score25="Score25",t.PlayerTrail="PlayerTrail",t.Towers="Towers",t.TowerGlow="TowerGlow",t.Track="Track",t.TrackLines="TrackLines",t.BottleHalo="BottleHalo",t.BottleGlow="BottleGlow",t.BottleGold="BottleGold",t.Shadows="Shadows",t.DotRingVFX="DotRingVFX"}(ae||(ae={}));class ue{constructor(t){this.game=t}async load(){await Promise.all([this.loadMainGltf(),Yt.load("tex_track_emissive",this.game.scene.cmnTexs),jt.load("tex_lightmaps",this.game.scene.cmnTexs)])}async loadMainGltf(){const t=this.game.scene.gl,e=this.game.theme,s=new Vt.a("Track",T.a.asset_url("game-1/MainAssets.gltf"),this.game.scene.gltfs);this.mainGltf=await s.response();const i=new Zt;i.iExposure.proxy(this.game.scene.iblMngr.exposure),this.fog=this.game.fog.createFog(),this.towerfog=new re(this.game);const n=new S.a("lm",vt.b.create());n.set(this.game.scene.cmnTexs.get("tex_lightmaps"));for(const t of this.mainGltf.materials){const e=t.name,s=t.materialPass;s.name=e,ce(e,ae.Score10,ae.Score25,ae.TrackLines,ae.BottleHalo,ae.Shadows)||s.inputs.add(this.fog),ce(e,ae.TrackLines,ae.BottleHalo)&&s.inputs.add(this.game.fog.createBlackFog()),"PlayerWhite"!=e&&this.game.scene.iblMngr.setupMat(s),ce(e,ae.Towers,ae.TowerGlow,ae.TrackLines,ae.Track,ae.GoldenBall,ae.BottleGlow,ae.BottleHalo,ae.BottleGold,ae.GlowingYellow,ae.DarkCube)&&(s.mask=s.mask|G.a.REFLECTED)}let r;r=this.getPass(ae.Towers),r.emissiveColorSpace.set("COLORSPACE_SRGB"),r.emissive.attach(n),r.inputs.add(this.towerfog),r=this.getPass(ae.DarkCube),r.emissiveColorSpace.set("COLORSPACE_SRGB"),r.emissive.attach(n),r=this.getPass(ae.TowerGlow),r.glconfig.enableCullface(!1),r=this.getPass(ae.DarkCube),r.surface.baseColor.attachUniform("ucolor")._value=e.blackBlocs,r.surface.baseColorFactor.param._value.set([1,1,1]),r.surface.roughnessFactor.attachConstant(.121);const a=this.getPass(ae.Shadows);a.inputs.add(this.game.fog.createWhiteFog()),a.mask=G.a.SHADOWS,a.glconfig.enableBlend().blendFunc(t.ZERO,t.SRC_COLOR).enableDepthTest(!1),this.getPass(ae.TrackLines).glconfig.enablePolygonOffset().polygonOffset(0,-1e3);const o=this.getPass(ae.DotRingVFX),h=new le;h.color.attachConstant(Object(_t.e)(16563804,3)),o.inputs.add(h),o.mask=G.a.BLENDED,o.glconfig.enableBlend().blendFunc(t.ONE,t.ONE),this.probeLightSetup=new $t.a,ne.registerLighModel(this.probeLightSetup.stdModel),this.probeLightSetup.add(this.game.rprobe),this._lightSetupChunks=this.game.scene.iblMngr.lights.setup.getChunks("std"),this._lightSetupChunksProbe=this.probeLightSetup.getChunks("std"),this.enableReflectionProbeChanged();const l=this.getPass(ae.TowerGlow);l.inputs.add(i),l.baseColorFactor.param._value.set(Object(_t.e)(9877495,2));const c=this.getPass(ae.BottleHalo);c.mask=G.a.BLENDED|G.a.REFLECTED,c.glconfig.enableBlend().blendFunc(t.ONE,t.ONE).depthMask(!1),c.inputs.add(i),c.baseColorFactor.attachUniform("emf")._value.set(Object(_t.e)(9877495,1));const u=this.getPass(ae.BottleGlow);u.inputs.add(i),u.baseColorFactor.attachUniform("emf")._value.set(Object(_t.e)(9877495,2))}enableReflectionProbeChanged(){const t=this.getPass("PlayerWhite");if(this.game.scene.iblMngr.setupMatTM(t),this.game.enableReflectionProbe){for(const e of this._lightSetupChunks)t.inputs.remove(e);t.inputs.addChunks(this._lightSetupChunksProbe)}else{for(const e of this._lightSetupChunksProbe)t.inputs.remove(e);t.inputs.addChunks(this._lightSetupChunks)}}getPass(t){return this.mainGltf.getElementByName(Xt.a.MATERIAL,t).materialPass}getNode(t){var e=this.mainGltf.getElementByName(Xt.a.NODE,t);return $.a.isDefined(e),e}getRenderable(t){var e=this.getNode(t);return $.a.isDefined(e.renderable),e.renderable}}class de{constructor(t){this.entities=t,this.head=0,this.prng=new X(32167841)}reset(t){this.prng.reset(t),this.head=0}}const ge=W.mat4.create(),me=W.mat4.create(),pe=W.vec3.create();var fe;!function(t){t[t.BlackBloc=0]="BlackBloc",t[t.BlackBlocWide=1]="BlackBlocWide",t[t.GoldenBall=2]="GoldenBall",t[t.SpeedPowerup=3]="SpeedPowerup"}(fe||(fe={}));class ve{constructor(t=0,e=0){this.halfWidth=t,this.halfDepth=e}}class _e{constructor(){this.matrix=W.mat4.create(),this.worldMatrix=W.mat4.create(),this.reflWorldMatrix=W.mat4.create(),this._markedForRemove=!1,this._beenHit=!1}remove(){this._markedForRemove=!0}reset(){this._beenHit=!1,this._markedForRemove=!1}}class be{constructor(t){this.game=t,this.bounds=new ve(1/15,1/15),this.instances=[],this.positionOffset=W.vec3.create(),this.culldistance=21}addInstance(t){this.instances.push(t)}getMinDist(){const t=this.game.player.sphereNode._wposition;let e=1e4;for(let s=this.instances.length-1;s>-1;s--){const i=this.instances[s].worldMatrix;pe[0]=i[12],pe[1]=i[13],pe[2]=i[14];const n=W.vec3.squaredDistance(pe,t);e=Math.min(n,e)}return Math.sqrt(e)}updateInstances(){const t=et.SEG_LEN,e=this.game.track,s=e.playerInvMatrix,i=this.game.player,n=i.progression,r=i.radius,a=i.trackX,o=e.getMaxTime();for(let h=this.instances.length-1;h>-1;h--){const l=this.instances[h];let c=l.progress;if(!l._beenHit){let e=!1;if(Math.abs(c-n)<.2){const s=(c-i.progression)*t;if(Math.abs(s)<this.bounds.halfDepth+r){const t=l.matrix[12]-a;Math.abs(t)<this.bounds.halfWidth+r&&(e=!0,this.handleInstanceHit(l),l._beenHit=!0)}}}l._markedForRemove||c<n-.5?(l.release(),this.instances.splice(h,1)):(c=Math.min(c,o),e.getTransformAt(c,ge),me.set(ge),me[4]*=-1,me[5]*=-1,me[6]*=-1,l.update(this.game),W.mat4.multiply(ge,ge,l.matrix),W.mat4.multiply(me,me,l.matrix),W.mat4.multiply(l.worldMatrix,s,ge),W.mat4.multiply(l.reflWorldMatrix,s,me))}}handleInstanceHit(t){t.remove()}render(t,e,s=!1){const i=t.glstate,n=this.renderable,r=e.camera,a=e.mask,o=e.pass,h=n.mesh.primitives;for(let t=0;t<h.length;t++){const l=h[t],c=n.materials[t];if(!c.hasPass(o)||0==(c.mask&a))continue;const u=c.getPass(o);if(0==(u.pass.mask&a))continue;u.prepare(n.node,r),i.push(u.pass.glconfig),c.glconfig&&i.push(c.glconfig),n.glconfig&&i.push(n.glconfig),e.cfg&&i.push(e.cfg),i.apply();const d=u.getProgram();l.bindVao(d);for(const t of this.instances){const e=t.worldMatrix;pe[0]=e[12],pe[1]=e[13],pe[2]=e[14],W.vec3.length(pe)<this.culldistance&&this.renderInstance(l,r,d,t,s)}l.unbindVao(),i.pop(),c.glconfig&&i.pop(),n.glconfig&&i.pop(),e.cfg&&i.pop()}}renderInstance(t,e,s,i,n){const r=n?i.reflWorldMatrix:i.worldMatrix;s.uMVP&&(e.modelViewProjectionMatrix(ge,r),s.uMVP(ge)),s.uWorldMatrix&&s.uWorldMatrix(r),t.render()}removeAll(){for(let t=0;t<this.instances.length;t++)this.instances[t].release();this.instances.length=0}}class xe extends _e{constructor(){super()}static get(){return 0==this._pool.length?new xe:this._pool.pop()}static release(t){t.reset(),this._pool.push(t)}update(t){}release(){xe.release(this)}}xe._pool=[];class we extends be{constructor(t,e){super(t),this.positionOffset[1]=e.node.position[1],this.renderable=e}addInstanceAt(t,e){const s=xe.get();s.bounds=this.bounds,s.progress=t;const i=s.matrix;return i.set(e),i[12]+=this.positionOffset[0],i[13]+=this.positionOffset[1],i[14]+=this.positionOffset[2],$.a.isTrue(!isNaN(i[12])),this.addInstance(s),s}}var Ce,Te=s(78);!function(t){t[t.S10=10]="S10",t[t.S25=25]="S25"}(Ce||(Ce={}));class Pe{constructor(t){this.game=t,this.onChange=new Te.a}get value(){return this.game.data.gameState.score}reset(){this.game.data.gameState.score=0}add(t){this.game.data.gameState.score+=t,this.onChange.emit({increment:t,newvalue:this.value})}dispose(){this.onChange.release()}}const Se=W.vec3.fromValues(10/14,10/14,10/14);class Ee{constructor(t){this.size=t,this.count=0}ballCatched(){return this.count++,this.count>=this.size}}class ye extends _e{constructor(){super(),this.dotRing=null,W.mat4.scale(this.matrix,this.matrix,Se)}static get(){return 0==this._pool.length?new ye:this._pool.pop()}static release(t){t.reset(),this._pool.push(t)}update(t){if(null!=this.dotRing){if(this.dotRing.progress>1)return this.dotRing.release(),void(this.dotRing=null);const t=this.dotRing.node._wmatrix;t.set(this.worldMatrix),t[12]-=.08*t[4],t[13]-=.08*t[5],t[14]-=.08*t[6],t[12]+=.15*t[8],t[13]+=.15*t[9],t[14]+=.15*t[10]}}reset(){super.reset()}release(){var t;null===(t=this.dotRing)||void 0===t||t.release(),this.dotRing=null,this.group=null,ye.release(this)}}ye._pool=[];class Me extends be{constructor(t,e){super(t),this.positionOffset[1]=e.node.position[1],this.renderable=e}createInstance(){return ye.get()}handleInstanceHit(t){t.group.ballCatched()?this.game.score.add(Ce.S25):this.game.score.add(Ce.S10);const e=this.game.dotRings.createInstance();e.progress=.15,t.dotRing=e}renderInstance(t,e,s,i,n){null==i.dotRing&&super.renderInstance(t,e,s,i,n)}}const Fe=W.vec3.fromValues(10/14,10/14,10/14);class Re extends _e{constructor(){super(),W.mat4.scale(this.matrix,this.matrix,Fe)}static get(){return 0==this._pool.length?new Re:this._pool.pop()}static release(t){t.reset(),this._pool.push(t)}update(t){}release(){Re.release(this)}}Re._pool=[];class Ae extends be{constructor(t,e){super(t),this.positionOffset[1]=e.node.position[1],this.renderable=e}createInstance(){return Re.get()}handleInstanceHit(t){this.game.gainLife(),t.remove()}}const Le=W.mat4.create(),De=W.mat4.create(),Ie=W.vec3.create();W.vec3.fromValues(10/14,10/14,10/14);class ke extends _e{constructor(){super()}static get(){return 0==this._pool.length?new ke:this._pool.pop()}static release(t){t.reset(),this._pool.push(t)}update(t){}release(){ke.release(this)}}ke._pool=[];class Oe extends be{constructor(t,e){super(t),this.positionOffset[1]=e.node.position[1],this.renderable=e}createInstance(){return ke.get()}handleInstanceHit(t){this.game.speedup()}renderInstance(t,e,s,i,n){const r=n?i.reflWorldMatrix:i.worldMatrix;Le.set(r);for(let i=0;i<3;i++)Ie[2]=.3*i-.3,W.mat4.translate(Le,r,Ie),s.uMVP&&(e.modelViewProjectionMatrix(De,Le),s.uMVP(De)),s.uWorldMatrix&&s.uWorldMatrix(Le),t.render()}}var Be;function Ne(t,e){return{type:t,p:e,s:0}}function Ge(t,e){return t*e*7.38921%1}!function(t){t[t.Nothing=0]="Nothing",t[t.Balls=1]="Balls",t[t.Life=2]="Life",t[t.Speedup=3]="Speedup",t[t.StaticWall=4]="StaticWall",t[t.MovingWall=5]="MovingWall",t[t.StaticWallWide=6]="StaticWallWide",t[t.MovingWallWide=7]="MovingWallWide",t[t.BrainHell=8]="BrainHell",t[t.Passage=9]="Passage"}(Be||(Be={}));class Ue extends de{constructor(){super(...arguments),this.events=function(){const t=[Ne(Be.Nothing,3),Ne(Be.Balls,2),Ne(Be.Life,.3),Ne(Be.Speedup,.6),Ne(Be.StaticWall,7),Ne(Be.MovingWall,2),Ne(Be.StaticWallWide,5),Ne(Be.MovingWallWide,2),Ne(Be.BrainHell,.3),Ne(Be.Passage,.3)];let e=0;for(const s of t)e+=s.p;let s=0;for(const i of t)i.p/=e,s+=i.p,i.s=s;return t}(),this.lastEvent=Be.Nothing}reset(t){super.reset(t),this.head=5}pickRandomEvent(t){for(let e=0;e<this.events.length;e++){const s=this.events[e];if(t<s.s)return s}}generateUntil(t){for(;this.head<t;){var e=this.prng.next();const t=this.pickRandomEvent(e);switch(t.type){case Be.Nothing:this.head+=.2;break;case Be.Balls:this.lastEvent!=Be.Balls&&this.addBallGroup(e);break;case Be.Life:this.addLife(e);break;case Be.Speedup:this.addSpeedup(e);break;case Be.StaticWall:this.addWall(e,!1,!1),this.head+=.2;break;case Be.StaticWallWide:this.addWall(e,!1,!0),this.head+=.2;break;case Be.MovingWall:this.addWall(e,!0,!1),this.head+=.2;break;case Be.MovingWallWide:this.addWall(e,!0,!0),this.head+=.2;break;case Be.BrainHell:this.brainHell(e);break;case Be.Passage:this.passage(e);break;default:throw""}this.lastEvent=t.type}}addBallGroup(t){const e=this.entities.game.track;var s=3+Math.floor(1e3*this.prng.next())%4;const i=new Ee(s);for(let t=0;t<s;t++){const t=ye.get();t.matrix[12]=e.getSafePositionAt(this.head),t.matrix[13]=.075,t.group=i,t.progress=this.head,this.entities.goldenBalls.addInstance(t),this.head+=.15}this.head+=.2}addLife(t){const e=Re.get();e.matrix[12]=.85*(Ge(t,958714)-.5),e.matrix[13]=.015,e.progress=this.head,this.entities.lifes.addInstance(e),this.head+=.2}addSpeedup(t){this.entities.game.track;const e=ke.get();e.matrix[12]=.85*(Ge(t,956214)-.5),e.progress=this.head,this.entities.speedups.addInstance(e),this.head+=.2}addWall(t,e,s){const i=this.entities.game.player.radius,n=this.entities.game.track;let r,a,o,h,l;const c=n.getSafePositionAt(this.head);if(s?(l=this.entities.blackBlocsWide,r=Math.floor(98765*t)%6+1,a=n.getLanePosition(r-.5),o=n.getLanePosition(1.5),h=n.getLanePosition(4.5)):(l=this.entities.blackBlocs,r=Math.floor(98765*t)%6+1,a=n.getLanePosition(r-.5),o=n.getLanePosition(.5),h=n.getLanePosition(5.5)),Math.abs(c-a)<l.bounds.halfWidth+i+.02&&(a+=.5,a>.5&&(a-=1)),Math.abs(c-a)<l.bounds.halfWidth+i+.02)return;e||(o=h=a),a<o&&(o=a),a>h&&(h=a);const u=Math.floor(659741256*t)%2==0;l.addInstanceAt(this.head,a,o,h,u)}brainHell(t){const e=this.entities.game.track,s=Math.floor(659741256*t)%2;let i=new Ee(4);for(let t=0;t<4;t++){const t=ye.get(),s=e.getSafePositionAt(this.head);t.matrix[12]=s,t.matrix[13]=.075,t.group=i,t.progress=this.head,this.entities.goldenBalls.addInstance(t),this.head+=.15}for(let t=0;t<16;t++){const i=e.getSafePositionAt(this.head)-.4+t%2*.8;Math.abs(i)<.5&&this.entities.blackBlocs.addInstanceAt(this.head,i,-.5,.5,t%2==s),this.head+=.07}this.head+=1}passage(t){const e=this.entities.game.track;let s=new Ee(0),i=0;for(let t=0;t<2;t+=.15){const n=this.head+t,r=ye.get(),a=e.getSafePositionAt(n);r.matrix[12]=a,r.matrix[13]=.075,r.group=s,r.progress=n,this.entities.goldenBalls.addInstance(r),i++}s.size=i;for(let t=0;t<2;t+=.15){const s=this.head+t,i=e.getSafePositionAt(s),r=.8-.5*Object(n.d)(t/2*3);let a;a=i-r,a>-.5&&this.entities.blackBlocs.addInstanceAt(s,a),a=i+r,a<.5&&this.entities.blackBlocs.addInstanceAt(s,a)}this.head+=2}}const ze=W.vec3.create(),We=W.mat4.create(),He=W.mat4.create(),Ve=W.vec4.create(),Xe=W.mat4.create(),qe=W.vec3.fromValues(0,0,1);class Ye extends de{constructor(){super(...arguments),this.isLeft=!1}generateUntil(t){const e=this.entities.game.track;for(;this.head<t;){const t=this.prng.next(),r=Math.floor(4*t),a=this.entities.towers[r];var s=Math.floor(6543*t)%4,i=1.2+.4*this.prng.next();ze[0]=ze[1]=ze[2]=i;var n=.8*this.prng.next()-.36;W.mat4.rotateY(We,Xe,s*Math.PI/2),W.mat4.scale(We,We,ze);const o=this.isLeft?1:-1;We[12]=o*(1.5+n),We[13]=-1,e.getPositionAt(this.head,Ve);const h=Ve[3];W.mat4.fromRotation(He,h,qe),W.mat4.multiply(We,He,We),a.addInstanceAt(this.head,We),this.head+=.2,this.isLeft=!this.isLeft}}}class je extends _e{constructor(){super()}static get(){return 0==this._pool.length?new je:this._pool.pop()}static release(t){this._pool.push(t)}init(t,e=t,s=t,i=!0){if(this.minPos=e,this.deltaPos=s-e,this.deltaPos>0){const n=(t-e)/(s-e);if(this.phase=Math.asin(2*n-1),isNaN(this.phase))throw"nan";i&&(this.phase=Math.PI-this.phase)}else this.phase=0}update(t){const e=this.progress-t.player.progression,s=.5*Math.sin(this.phase+2*e)+.5;this.matrix[12]=this.minPos+s*this.deltaPos}release(){je.release(this)}}je._pool=[];class Ke extends be{constructor(t,e,s){super(t),this.positionOffset[1]=e.node.position[1],this.renderable=e,s&&(this.bounds.halfWidth=2/15)}addInstanceAt(t,e,s=e,i=e,n=!0){const r=je.get();return r.reset(),r.init(e,s,i,n),r.bounds=this.bounds,r.progress=t,r.matrix[13]=.025,this.addInstance(r),r}handleInstanceHit(t){this.game.loseLife(),t.remove()}}const Qe=W.vec3.create();class Ze extends _e{constructor(){super(...arguments),this.baseMatrix=W.mat4.create()}static get(){return 0==this._pool.length?new Ze:this._pool.pop()}static release(t){t.reset(),this._pool.push(t)}release(){Ze.release(this)}update(t){const e=Object(n.d)(.3*(t.player.progression-this.progress+8));Qe[0]=Qe[1]=Qe[2]=e,W.mat4.scale(this.matrix,this.baseMatrix,Qe)}}Ze._pool=[];class $e extends we{constructor(t,e){super(t,e),this.culldistance=30}addInstanceAt(t,e){const s=Ze.get();s.bounds=this.bounds,s.progress=t;const i=s.baseMatrix;return i.set(e),i[12]+=this.positionOffset[0],i[13]+=this.positionOffset[1],i[14]+=this.positionOffset[2],$.a.isTrue(!isNaN(i[12])),this.addInstance(s),s}}class Je{constructor(t){this.game=t,this.entities=[],this.entitiesGenerator=new Ue(this),this.towerGenerator=new Ye(this)}init(){this.entities.push(this.goldenBalls=new Me(this.game,this.game.assets.getRenderable("GoldenBall"))),this.entities.push(this.blackBlocs=new Ke(this.game,this.game.assets.getRenderable("BlackBloc"),!1)),this.entities.push(this.blackBlocsWide=new Ke(this.game,this.game.assets.getRenderable("BlackBlocWide"),!0)),this.entities.push(this.lifes=new Ae(this.game,this.game.assets.getRenderable("Bottle"))),this.entities.push(this.speedups=new Oe(this.game,this.game.assets.getRenderable("SpeedArrow"))),this.towers=[];for(let t=1;t<5;t++){const e=new $e(this.game,this.game.assets.getRenderable("Tower"+t));this.towers.push(e),this.entities.push(e)}}reset(){this.entitiesGenerator.reset(this.game.mainSeed+51678),this.towerGenerator.reset(this.game.mainSeed+426441);for(const t of this.entities)t.removeAll()}updateInstances(){for(const t of this.entities)t.updateInstances();if(this.blocMinDist=Math.min(this.blackBlocs.getMinDist(),this.blackBlocsWide.getMinDist()),isNaN(this.blocMinDist))throw""}preRender(){const t=this.game.player.progression+6;this.entitiesGenerator.generateUntil(t),this.towerGenerator.generateUntil(t)}renderTrackEntities(t){const e=this.game.scene;this.goldenBalls.render(e,t,!1),this.blackBlocs.render(e,t,!1),this.blackBlocsWide.render(e,t,!1),this.lifes.render(e,t,!1),this.speedups.render(e,t,!1)}renderTowers(t){const e=this.game.scene;for(const s of this.towers)s.render(e,t,!1)}renderReflect(t){const e=this.game.scene;this.goldenBalls.render(e,t,!0),this.blackBlocs.render(e,t,!0),this.blackBlocsWide.render(e,t,!0),this.lifes.render(e,t,!0)}renderReflectTower(t){const e=this.game.scene;for(const s of this.towers)s.render(e,t,!0)}}var ts=s(389),es=s.n(ts),ss=s(390),is=s.n(ss);const ns=["NONE","EXP","EXP2","LINEAR"];class rs{constructor(){this._mode=new E.a("fogMode",ns),this._params=new S.c("uFogParams",2),this._color=new S.c("uFogColor",3)}set fogStart(t){this._params._value[0]=t}set fogEnd(t){this._params._value[1]=t}set fogDensity(t){this._params._value[2]=t}get fogStart(){return this._params._value[0]}get fogEnd(){return this._params._value[1]}get fogDensity(){return this._params._value[2]}set mode(t){this._mode.set(t)}get mode(){return this._mode.value()}set color(t){this._color._value.set(t)}get color(){return this._color._value}setup(t){t._mode.proxy(this._mode),t._paramsInput.attach(this._params),t._colorInput.attach(this._color)}}class as extends st.a{constructor(t){super(!0,!1),this._mode=new E.a("fogMode",ns),this._paramsInput=new S.d("fogParams",2,S.b.FRAGMENT),this._colorInput=new S.d("fogColor",3,S.b.FRAGMENT),this.addChild(this._mode),this.addChild(this._paramsInput),this.addChild(this._colorInput),t.setup(this)}_genCode(t){t.add("pf",is()()),t.add("postf",es()())}}var os=s(391),hs=s.n(os),ls=s(392),cs=s.n(ls);class us{constructor(){this._mode=new E.a("fogMode",ns),this._params=new S.c("uFogParams",2),this._color1=new S.c("uFogColor1",3),this._color2=new S.c("uFogColor2",3)}set fogStart(t){this._params._value[0]=t}set fogEnd(t){this._params._value[1]=t}set fogDensity(t){this._params._value[2]=t}get fogStart(){return this._params._value[0]}get fogEnd(){return this._params._value[1]}get fogDensity(){return this._params._value[2]}set mode(t){this._mode.set(t)}get mode(){return this._mode.value()}set colorTop(t){this._color1._value.set(t)}get colorTop(){return this._color1._value}set colorBottom(t){this._color2._value.set(t)}get colorBottom(){return this._color2._value}setup(t){t._mode.proxy(this._mode),t._paramsInput.attach(this._params),t._colorInput1.attach(this._color1),t._colorInput2.attach(this._color2)}}class ds extends st.a{constructor(t,e){super(!0,!0),this.game=t,this._mode=new E.a("fogMode",ns),this._paramsInput=new S.d("fogParams",2,S.b.FRAGMENT),this._colorInput1=new S.d("fogColor1",3,S.b.FRAGMENT),this._colorInput2=new S.d("fogColor2",3,S.b.FRAGMENT),this.addChild(this._mode),this.addChild(this._paramsInput),this.addChild(this._colorInput1),this.addChild(this._colorInput2),e.setup(this)}setup(t){t.uScreenHeight(this.game.scene.renderHeight)}_genCode(t){t.add("pf",cs()()),t.add("postf",hs()())}}class gs{constructor(t){this.game=t,this.params=new us,this.params.mode="LINEAR",this.params.fogStart=8,this.params.fogEnd=20,this.params.colorTop=t.theme.matteColor,this.params.colorBottom=t.theme.matteColorLight}createFog(){return new ds(this.game,this.params)}createSimpleFog(){const t=new rs;t.mode="LINEAR",t.fogStart=8,t.fogEnd=20,t.color=this.game.theme.matteColor;const e=new as(t);return e._mode.proxy(this.params._mode),e._paramsInput.attach(this.params._params),e}createBlackFog(){const t=this.createSimpleFog();return t._colorInput.attachConstant([0,0,0]),t}createWhiteFog(){const t=this.createSimpleFog();return t._colorInput.attachConstant([1,1,1]),t}}var ms=s(393),ps=s.n(ms);const fs=Math.sqrt(2*Math.PI);function vs(t,e=1,s=1){const i=2*e*e;let n=(t=Math.max(t,0))*t*t,r=t-e;return Math.sqrt(s/n)*Math.exp(-s*r*r/(i*t))/fs}const _s=W.mat4.create(),bs=W.quat.create();class xs{constructor(t){this.game=t,this.radius=.1,this.progression=1,this._speed=0,this._speedTgt=.8,this._targetPosition=0,this._realPosition=0,this._prevPosition=0,this.sensitivity=5,this.trackX=0,this.rollRotation=0,this.autoplay=!1,this._shock=0,this.lastHit=0,this.speedupTime=0,this.isSpeedUp=!1}reset(){this._smoothPosition=ps()({value:0},200),this.targetLane=0,this._prevPosition=0,this._realPosition=0,this.progression=1,this.rollRotation=0,this.speedupTime=0,this.isSpeedUp=!1,this.speedupGain=ps()({value:0},500),this.lastHit=0}set targetLane(t){var e;t=Math.max(-.5,Math.min(.5,t)),this._targetPosition=t,null===(e=this._smoothPosition)||void 0===e||e._value.set(t,1/this.sensitivity)}get targetLane(){return this._targetPosition}hit(){const t=Date.now();if(t-this.lastHit>2e3){this.lastHit=t;const e=9999*Math.random();return this.shock(e),!0}return!1}shock(t){this._shockChaosX=new q(t,.08,.3),this._shockChaosR=new q(t+1,.08,.4),this._shock=1,At.a.to(this,{_shock:0},2).start()}speedup(){var t;this.speedupTime=Date.now(),null===(t=this.speedupGain)||void 0===t||t.set({value:1}),this.isSpeedUp=!0}init(){this.renderer=this.game.assets.getRenderable("PlayerSphere"),this.shadow=this.game.assets.getRenderable("PlayerShadow"),this.rootNode=this.game.assets.getNode("Player"),this.xslideNode=this.game.assets.getNode("XSlideNode"),this.tiltNode=this.game.assets.getNode("TiltNode"),this.scoreOrigin=this.game.assets.getNode("ScoreOrigin"),this.sphereNode=this.renderer.node,this.baseLocalMatrix=W.mat4.create(),this.renderer.node.updateMatrix();const t=this.renderer.node._matrix;this.baseLocalMatrix.set(this.renderer.node._matrix),W.mat4.identity(t),this.renderer.node.setMatrix(t),this.game.track.root.add(this.rootNode),this.setupReflectionProbe()}setupReflectionProbe(){}preRender(){let t=Date.now(),e=this.game.scene.dt,s=60*e;this._speedTgt=.5+.01*this.progression,this._speedTgt=Math.min(this._speedTgt,1.5),t-this.speedupTime>3e3&&this.isSpeedUp&&(this.speedupGain._value.set(0),this.isSpeedUp=!1),this._speed+=.2*(this._speedTgt-this._speed)*s;const i=this._speed*e;this.progression+=i,this.rollRotation+=-i*et.SEG_LEN*5,this.rollRotation=Object(n.g)(this.rollRotation);let r=this._smoothPosition.value;this._realPosition+=(this._smoothPosition.value-this._realPosition)*this.game.scene.timescale;let a=this._realPosition,o=0;e>1e-5&&(o=(this._prevPosition-r)/e),this._prevPosition=r,this.trackX=a,this.game.track.getTransformAt(this.progression,_s),W.mat4.multiply(_s,_s,this.baseLocalMatrix),this.rootNode.setMatrix(_s);let h=this.tiltNode.rotation;if(W.quat.rotateY(h,bs,.5*-o),W.quat.rotateX(h,h,.35*-o),this.xslideNode.z=this.trackX,this._shock>0){const t=this._shockChaosX.next(e/.016)*this._speedTgt,s=this._shockChaosR.next(e/.016)*this._speedTgt;let i=vs(1-this._shock,2.5,.3);i-=vs(1,2.5,.3),i=Math.max(0,i),this.xslideNode.z+=t*i,W.quat.rotateX(h,h,s*i)}h=this.renderer.node.rotation,W.quat.rotateZ(h,bs,this.rollRotation),this.tiltNode.invalidate(),this.renderer.node.invalidate()}render(t){this.game.track.getTransformAt(this.progression,_s),W.mat4.multiply(_s,_s,this.baseLocalMatrix),this.rootNode.setMatrix(_s),this.rootNode.updateWorldMatrix(),this.renderer.render(this.game.scene,t.camera,t.mask,t.pass)}renderShadow(t){this.game.track.getTransformAt(this.progression,_s),W.mat4.multiply(_s,_s,this.baseLocalMatrix),this.rootNode.setMatrix(_s),this.rootNode.updateWorldMatrix(),this.shadow.render(this.game.scene,t.camera,t.mask,t.pass)}renderReflect(t){this.game.track.getTransformAt(this.progression,_s),_s[4]*=-1,_s[5]*=-1,_s[6]*=-1,W.mat4.multiply(_s,_s,this.baseLocalMatrix),this.rootNode.setMatrix(_s),this.rootNode.updateWorldMatrix(),this.renderer.render(this.game.scene,t.camera,t.mask,t.pass)}}var ws;function Cs(t,e,s){return s?t|e:t&~e}!function(t){t[t.Left=1]="Left",t[t.Right=2]="Right"}(ws||(ws={}));class Ts{constructor(t){this.game=t,this.keydowns=0,this.onKeyChange=t=>{if(t.defaultPrevented)return;const e="keydown"==t.type;switch(t.key){case"Left":case"ArrowLeft":this.keydowns=Cs(this.keydowns,ws.Left,e);break;case"Right":case"ArrowRight":this.keydowns=Cs(this.keydowns,ws.Right,e);break;default:return}},this.onTouchStart=t=>{const e=t.targetTouches[0];console.log("touchstart",e.identifier)},this.onTouchEnd=t=>{const e=t.changedTouches[0];console.log("touchend",e.identifier)},this.onMouseMove=t=>{this.setPlayerPos(t.clientX)},this.onTouchMove=t=>{const e=t.changedTouches[0];e.clientX,window.innerWidth;this.setPlayerPos(e.clientX)},window.addEventListener("keydown",this.onKeyChange),window.addEventListener("keyup",this.onKeyChange),window.addEventListener("touchstart",this.onTouchStart),window.addEventListener("touchend",this.onTouchEnd),window.addEventListener("touchmove",this.onTouchMove),window.addEventListener("mousemove",this.onMouseMove)}dispose(){this.game=null,window.removeEventListener("keydown",this.onKeyChange),window.removeEventListener("keyup",this.onKeyChange),window.removeEventListener("touchstart",this.onTouchStart),window.removeEventListener("touchend",this.onTouchEnd),window.removeEventListener("touchmove",this.onTouchMove),window.removeEventListener("mousemove",this.onMouseMove)}preRender(){if(0!=this.keydowns){const t=this.game.scene.dt/.4;0!=(this.keydowns&ws.Left)&&(this.game.player.targetLane+=t),0!=(this.keydowns&ws.Right)&&(this.game.player.targetLane-=t)}}setPlayerPos(t){const e=window.innerWidth/window.innerHeight,s=t/window.innerWidth,i=Math.max(1.2,e/.5);this.game.player.targetLane=-(s-.5)*i}}const Ps=W.vec3.create(),Ss=W.vec3.create(),Es=W.vec3.create(),ys=W.vec3.create(),Ms=W.vec3.create(),Fs=W.mat4.create(),Rs=W.vec3.fromValues(0,-.09,0);class As{constructor(t){this.game=t}reset(){this.spline=new z.a(23)}init(){this.renderable=this.game.assets.getRenderable("PlayerTrail"),this.renderable.node.position.set([0,0,0]),this.game.track.root.add(this.renderable.node),this.splineDeformer=new ot(20),this.splineDeformer.scale=1;const t=this.renderable.materials[0];t.getPass(U.a.COLOR).pass.glconfig.enableCullface(!1),t.inputs.add(this.splineDeformer)}recenter(t){const e=this.spline._anchors,s=this.spline._length;for(let i=0;i<s;i++){const s=4*i;e[s+0]+=t[0],e[s+1]+=t[1],e[s+2]+=t[2]}this.spline.computeAll()}getTrailOrigin(t,e){const s=this.game.player;W.mat4.invert(Fs,this.game.track.playerInvMatrix),W.mat4.multiply(Fs,Fs,s.tiltNode._wmatrix),W.vec3.transformMat4(t,Rs,Fs),e[0]=Fs[4],e[1]=Fs[5],e[2]=Fs[6]}graphUpdate(){this.getTrailOrigin(ys,Ms),this.updateHead(ys,Ms),this.spline.compute()}updateHead(t,e){if(this.spline.getAnchorV3(Ps,20),W.vec3.distance(t,Ps)>.1)return W.vec3.sub(Ss,t,Ps),W.vec3.normalize(Ss,Ss),W.vec3.scaleAndAdd(Ss,Ps,Ss,.1),this.setHeadPosition(Ss,e),this.addAnchor(),void this.updateHead(t,e);this.setHeadPosition(t,e)}addAnchor(){this.spline.shift(-1)}setHeadPosition(t,e){this.spline.setAnchor3(t,21),this.spline.getAnchorV3(Ps,20),this.spline.setNormal(e,20),W.vec3.sub(Ps,t,Ps),W.vec3.add(Es,t,Ps),this.spline.setAnchor3(Es,22)}render(t){this.splineDeformer.setSpline(this.spline),this.renderable.render(this.game.scene,t.camera,t.mask,t.pass)}debugDraw(){const t=W.mat4.create(),e=W.vec3.fromValues(.01,.01,.01),s=W.vec3.fromValues(.005,.005,.005);for(let i=0;i<10*this.spline._length;i++)this.spline.getTransformAt(i/10,t),W.mat4.multiply(t,this.game.track.playerInvMatrix,t),W.mat4.scale(t,t,i%10==0?e:s),ht.drawGuizmo(t)}}var Ls=s(86),Ds=s(90);class Is{constructor(t,e){this.t=t,this.gl=e}bind(t){const e=this.gl;void 0!==t&&e.activeTexture(e.TEXTURE0+(0|t)),e.bindTexture(e.TEXTURE_CUBE_MAP,this.t)}}class ks extends Ds.a{constructor(t){var e;super(),this.game=t,this._type=12,this.size=128;const s=t.scene.gl;this.gl=s,this.node=new a.a,this.fbos=[],this.depthBuffers=[],this.cameras=[];const i=Ls.a.getInstance(s),n=[i.RGB16F,i.RGBA16F,i.RGB32F,i.RGBA32F,i.RGB8];this.texFormat=i.getRenderableFormat(n),this.texFormat.internal=null!==(e=this.texFormat.internal)&&void 0!==e?e:this.texFormat.format,this.texture=s.createTexture(),this.bindable=new Is(this.texture,s),s.bindTexture(s.TEXTURE_CUBE_MAP,this.texture),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);for(let t=0;t<6;t++)this.cameras.push(this.createCamera(t)),s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,this.texFormat.internal,this.size,this.size,0,this.texFormat.format,this.texFormat.type,null);for(let t=0;t<6;t++){const e=s.createFramebuffer(),i=s.createRenderbuffer();if(s.bindFramebuffer(s.FRAMEBUFFER,e),s.bindRenderbuffer(s.RENDERBUFFER,i),s.renderbufferStorage(s.RENDERBUFFER,s.DEPTH_COMPONENT16,this.size,this.size),s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,i),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_CUBE_MAP_POSITIVE_X+t,this.texture,0),s.checkFramebufferStatus(s.FRAMEBUFFER)!=s.FRAMEBUFFER_COMPLETE){let t=s.checkFramebufferStatus(s.FRAMEBUFFER);console.error("ReflectionProbe incomplete fbo ",t)}this.fbos[t]=e,this.depthBuffers[t]=i}s.bindFramebuffer(s.FRAMEBUFFER,null),s.bindRenderbuffer(s.RENDERBUFFER,null)}setupProgram(t){t.tEnv&&t.tEnv(this.texture),t.uSHCoeffs&&t.uSHCoeffs(this.baseIbl.sh)}renderFace(t){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.fbos[t]),e.viewport(0,0,this.size,this.size),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);const s=this.cameras[t];s.updateViewProjectionMatrix(this.size,this.size),this.game.render({camera:s,mask:G.a.REFLECTED,pass:U.a.COLOR}),e.bindFramebuffer(e.FRAMEBUFFER,null)}render(){this.game.scene.iblMngr.setupLinear();for(let t=0;t<6;t++)this.renderFace(t);this.game.scene.iblMngr.setupGamma()}createCamera(t){const e=L.a.makePerspectiveCamera();return e.lens.setHorizontalFov(Math.PI/2),e.lens.near=.01,e.lens.far=50,this.node.add(e),this.configureCamTransform(e,t),e}configureCamTransform(t,e){const s=Math.PI/2;0==e?t.rotateY(-s):1==e?t.rotateY(s):2==e?t.rotateX(-s):3==e?t.rotateX(s):4==e||5==e&&t.rotateY(Math.PI)}}var Os=s(220);const Bs=W.vec3.create();class Ns{constructor(t){this.game=t,this.whiteLum=0,this.baseEmissive=Object(_t.d)(5737975),this.baseEmissiveM=6,this.shockEmissive=Object(_t.d)(16528410),this.shockEmissiveM=40,this.shockAmount=0,this._baseLumChaos=new q(321,.5,1),this._shockChaos=new q(123,1,1)}init(){this.whitePass=this.game.assets.mainGltf.getElementByName(Xt.a.MATERIAL,ae.PlayerWhite).materialPass,this.glowPass=this.game.assets.mainGltf.getElementByName(Xt.a.MATERIAL,ae.PlayerGlow).materialPass,this.trailPass=this.game.assets.mainGltf.getElementByName(Xt.a.MATERIAL,ae.PlayerTrail).materialPass,this.glowPassEmissive=this.glowPass.emissiveFactor.param,this.trailPassEmissive=this.trailPass.emissiveFactor.param,this.whiteEm=new S.c("em",3),this.whitePass.emissiveFactor.attach(this.whiteEm)}reset(){}shock(){this.shockAmount=1,At.a.to(this,{shockAmount:0},.8).start()}shine(){this.whiteLum=15,At.a.to(this,{whiteLum:0},1.5).ease(Os.easeOutQuad).start()}preRender(){const t=this.whiteEm._value;t[0]=t[1]=t[2]=this.whiteLum;const e=this.game.scene.dt/.016;Bs.set(this.baseEmissive);let s=this.baseEmissiveM+this._baseLumChaos.next(e);if(this.shockAmount>0){s=Object(n.f)(s,this.shockEmissiveM,this.shockAmount),this._shockChaos.next(e)+.5<this.shockAmount&&Bs.set(this.shockEmissive)}W.vec3.scale(Bs,Bs,s),this.glowPassEmissive._value.set(Bs),this.trailPassEmissive._value.set(Bs)}}const Gs=W.mat4.create(),Us=W.vec3.create();class zs{constructor(){this.origin=W.vec3.create()}static get(){return this._pool.length>0?this._pool.pop():new zs}static release(t){this._pool.push(t)}}zs._pool=[];class Ws{constructor(t){this.renderer=t,this.instances=[],this.baseMatrix=W.mat4.create(),t.node.updateMatrix(),this.baseMatrix.set(t.node._matrix)}popScore(t){const e=zs.get();e.progress=0,e.origin.set(t),this.instances.push(e)}preRender(t){const e=this.instances;for(let s=e.length-1;s>-1;s--){const i=e[s];i.progress+=t/.6,i.progress>1&&(e.splice(s,1),zs.release(i))}}render(t,e){if(0==this.instances.length)return;const s=t.root._wmatrix,i=t.glstate,n=this.renderer,r=e.camera,a=e.mask,o=e.pass,h=n.mesh.primitives[0],l=n.materials[0];if(!l.hasPass(o)||0==(l.mask&a))return;const c=l.getPass(o);if(0==(c.pass.mask&a))return;c.prepare(n.node,r),i.push(c.pass.glconfig),l.glconfig&&i.push(l.glconfig),n.glconfig&&i.push(n.glconfig),e.cfg&&i.push(e.cfg),i.apply();const u=c.getProgram();h.bindVao(u);for(const t of this.instances)Us[0]=Us[1]=Us[2]=1-.3*t.progress,W.mat4.scale(Gs,this.baseMatrix,Us),Us.set(t.origin),Us[1]+=.1*t.progress,W.mat4.multiply(Gs,s,Gs),Gs[12]=Us[0],Gs[13]=Us[1],Gs[14]=Us[2],Us[0]=Us[1]=Us[2]=2*(1-t.progress),u.uEmissiveFactor(Us),u.uWorldMatrix&&u.uWorldMatrix(Gs),u.uMVP&&(r.modelViewProjectionMatrix(Gs,Gs),u.uMVP(Gs)),h.render();h.unbindVao(),i.pop(),l.glconfig&&i.pop(),n.glconfig&&i.pop(),e.cfg&&i.pop()}}class Hs{constructor(t){this.game=t,this.onScoreChange=t=>{t.increment==Ce.S10?this.pop10():t.increment==Ce.S25&&this.pop25()},t.score.onChange.on(this.onScoreChange)}init(){this.preparePass(this.game.assets.getPass("Score10")),this.preparePass(this.game.assets.getPass("Score25")),this.quad10=new Ws(this.game.assets.getRenderable("Score10")),this.quad25=new Ws(this.game.assets.getRenderable("Score25"))}preparePass(t){const e=this.game.scene.gl;t.glconfig.enableBlend().blendFunc(e.ONE,e.ONE).enableDepthTest(!1).enableCullface(!1);t.baseColorFactor.attachUniform("uEmissiveFactor")}pop10(){this.quad10.popScore(this.game.player.scoreOrigin._wposition)}pop25(){this.quad25.popScore(this.game.player.scoreOrigin._wposition)}preRender(){this.quad10.preRender(this.game.scene.dt),this.quad25.preRender(this.game.scene.dt)}render(t){this.quad10.render(this.game.scene,t),this.quad25.render(this.game.scene,t)}}var Vs=s(47),Xs=s(276),qs=s(15),Ys=s(77),js=s(102);class Ks{constructor(t,e){this.gl=t,this._useMsaa=Object(qs.a)(t)&&e>1,this.renderFbo=new Ys.a(t),this.renderFbo.bind(),Object(qs.a)(t)&&this._useMsaa?(this.renderFbo.attach(t.COLOR_ATTACHMENT0,new js.a(t,t.RGBA8,e)),this.renderFbo.attach(t.DEPTH_ATTACHMENT,new js.a(t,t.DEPTH_COMPONENT16,e)),this.blitFbo=new Ys.a(t),this.blitFbo.attachColor(t.RGBA,t.UNSIGNED_BYTE)):(this.renderFbo.attach(t.COLOR_ATTACHMENT0,new y.a(t,t.RGBA,t.UNSIGNED_BYTE)),this.renderFbo.attach(t.DEPTH_ATTACHMENT,new js.a(t,t.DEPTH_COMPONENT16)),this.blitFbo=this.renderFbo)}blitMsaa(){if(this._useMsaa){const t=this.gl;t.bindFramebuffer(t.READ_FRAMEBUFFER,this.renderFbo.fbo),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.blitFbo.fbo),t.clearBufferfv(t.COLOR,0,[0,0,0,1]),t.blitFramebuffer(0,0,this.renderFbo.width,this.renderFbo.height,0,0,this.renderFbo.width,this.renderFbo.height,t.COLOR_BUFFER_BIT,t.NEAREST)}}getColorTexture(){return this.blitFbo.getColorTexture()}setSize(t,e){this.renderFbo.resize(t,e),this.blitFbo.resize(t,e)}}W.mat4.create(),W.mat4.create();const Qs=W.vec3.create();class Zs{constructor(t){this.game=t,this.enabled=!0;const e=t.scene.gl;this.viewprojCopy=W.mat4.create(),this.size=512,this.blur=new Xs.a(t.scene,this.size),this.blur.spread=1,this.globalCfg=(new Vs.c).frontFace(e.CW);const s=new Ks(e,4);s.setSize(this.size,this.size);const i=s.getColorTexture();i.bind(),i.clamp(),i.setFilter(!0,!1,!1),this.fbo=s}prepare(t,e){this.scene.gl}render(){if(!this.enabled)return;const t=this.game.scene.gl,e=this.game.scene.glstate,s=this.game.scene.camera;this.fbo.renderFbo.bind(),t.viewport(0,0,this.size,this.size),t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),this.game.scene.iblMngr.expoUniform.set(.1),this.game.scene.iblMngr.gammaUniform.set(1/2.2),this.game.fog.params.colorTop=Qs,this.game.fog.params.colorBottom=Qs,e.push(this.globalCfg),e.apply(),this.game.player.renderReflect({camera:s,mask:G.a.OPAQUE,pass:U.a.COLOR}),this.game.scene.iblMngr.expoUniform.set(.2),this.game.entities.renderReflect({camera:s,mask:G.a.REFLECTED,pass:U.a.COLOR}),this.game.scene.iblMngr.expoUniform.set(.45),this.game.entities.renderReflectTower({camera:s,mask:G.a.REFLECTED,pass:U.a.COLOR}),e.pop(),this.game.scene.iblMngr.setupGamma(),this.game.fog.params.colorTop=this.game.theme.matteColor,this.game.fog.params.colorBottom=this.game.theme.matteColorLight,e.apply(),this.fbo.blitMsaa(),this.blur.process(this.fbo.getColorTexture()),e.apply()}getOutput(){return this.blur.getBlurredTex()}getOutputFbo(){return this.blur.getBlurredFbo()}}function $s(t,e,s,i,n,r,a){return{maxDpr:t,fxaa:e,trackReflect:s,post:i,ballReflect:n,shadows:r,chroma:a}}const Js=[$s(2,!0,!0,!0,!0,!0,!0),$s(2,!0,!0,!0,!1,!0,!0),$s(1.5,!0,!0,!0,!1,!0,!0),$s(1.5,!1,!0,!0,!1,!0,!0),$s(1.5,!1,!0,!0,!1,!0,!1),$s(1.5,!1,!1,!0,!1,!0,!1),$s(1.5,!1,!1,!0,!1,!1,!1),$s(1.5,!1,!1,!1,!1,!1,!1)];function ti(t){return new Promise(e=>setTimeout(e,t))}function ei(){return performance.now()/1e3}class si{constructor(){this._running=!1,this.lastFrameTime=-1,this.startTime=-1,this.record=[],this.onRaf=()=>{if(!this._running)return;const t=ei();if(this.lastFrameTime>0&&this.record.push(t-this.lastFrameTime),this.lastFrameTime=t,t-this.startTime>this._sampleDuration)return this._defer.resolve(this.getResult()),void this._stop();requestAnimationFrame(this.onRaf)}}start(t=1){if(!this._running)return this._sampleDuration=t,this._defer=new _.a,this.startTime=ei(),this._running=!0,requestAnimationFrame(this.onRaf),this._defer.promise}stop(){this._defer.reject("stopped"),this._stop()}_stop(){this._defer=null,this._running=!1,this.record.length=0}getResult(){let t=0;const e=this.record;for(let s=0;s<e.length;s++){t+=e[s]}t/=e.length;let s=0,i=0;for(let n=0;n<e.length;n++){const r=e[n],a=r/t;a>.25&&a<4&&(s+=r,i++)}return s/=i,{meanFrame:s}}}class ii{constructor(t){this.game=t,this._currentLevel=0,this._forceQuality=!1,this._debugLevel=1,this.level=0}async startAutoLevel(t){const e=new si;for(await ti(1e3);;){let s=await e.start();if(t.signal.aborted)throw"";if(console.log("fps "+1/s.meanFrame),!(s.meanFrame>.02))return;if(!this.reduceQuality())return;await ti(200)}}set level(t){t<0||t>=Js.length||(this._currentLevel=t,this._applyLevel())}get level(){return this._currentLevel}reduceQuality(){return!(this.level>=Js.length-1)&&(this.level++,console.log("reduced quality to "+this.level),!0)}_applyLevel(){let t=Js[this._currentLevel];this.game.scene.enableFxaa=t.fxaa,this.game.scene.postProcess.enabled=t.post,this.game.enableReflectionProbe=t.ballReflect,this.game.reflect.enabled=t.trackReflect,this.game.track.renderer.enableReflect(t.trackReflect),this.game._enableShadows=t.shadows,this.game.scene.maxDpr=t.maxDpr,this.game.scene.postfx.enableChromashift=t.chroma,this.game.scene.postfx.enableGrain=t.chroma}}var ni,ri=s(38);!function(t){t.MUSIC_FULL="MUSIC_FULL",t.COLLECT_10="COLLECT_10",t.COLLECT_25="COLLECT_25",t.COLLECT_BOTTLE="COLLECT_BOTTLE",t.BALL_DEATH="BALL_DEATH",t.ARROW_BOOSTER="ARROW_BOOSTER",t.BALL_CRASH="BALL_CRASH",t.HYPE_WORDS="HYPE_WORDS"}(ni||(ni={}));class ai{constructor(t){this.game=t,this.isInLowpass=!1,this.lowPassConnected=!1,this._lowpass=0,this.onScoreChange=t=>{t.increment==Ce.S10&&this.play(ni.COLLECT_10),t.increment==Ce.S25&&this.play(ni.COLLECT_25)},this.group=this.game.scene.audioResources,this.context=this.group.audioModule.context,this.masterDest=this.group.audioModule.masterNode,this.masterGain=this.context.createGain(),this.lowpassFilter=this.context.createBiquadFilter(),this.lowpassFilter.type="lowpass",this.lowpassFilter.frequency.value=2e3,this.masterGain.connect(this.masterDest),this.lowpassMaxFreq=this.context.sampleRate/2,t.score.onChange.on(this.onScoreChange)}setLowPassActve(t){this.lowPassConnected!=t&&(this.lowPassConnected=t,this.masterGain.disconnect(),this.lowpassFilter.disconnect(),t?(this.masterGain.connect(this.lowpassFilter),this.lowpassFilter.connect(this.masterDest)):this.masterGain.connect(this.masterDest))}set lowpass(t){this._lowpass=Object(n.d)(t),this.setLowPassActve(t>0);const e=Math.pow(this._lowpass,.2);this.lowpassFilter.frequency.value=this.lowpassMaxFreq*(1-.96*e),this.masterGain.gain.value=1-.6*this._lowpass}get lowpass(){return this._lowpass}async load(){const t=await Promise.all([new ri.a(ni.MUSIC_FULL,"game-1/G1_MUSIC_FULL",this.group).response(),new ri.a(ni.COLLECT_10,"game-1/G1_COLLECT_10",this.group).response(),new ri.a(ni.COLLECT_25,"game-1/G1_COLLECT_25",this.group).response(),new ri.a(ni.COLLECT_BOTTLE,"game-1/G1_COLLECT_BOTTLE",this.group).response(),new ri.a(ni.BALL_DEATH,"game-1/G1_BALL_DEATH",this.group).response(),new ri.a(ni.ARROW_BOOSTER,"game-1/G1_ARROW_BOOSTER",this.group).response(),new ri.a(ni.BALL_CRASH,"game-1/G1_BALL_CRASH",this.group).response(),new ri.a(ni.HYPE_WORDS,"game-1/G1_HYPE_WORDS",this.group).response()]);for(const e of t)e.output=this.masterGain}update(){const t=!this.game.scene.isRendering||this.game.data.gameState.ended;this.isInLowpass!=t&&(this.isInLowpass=t,At.a.stopByTarget(this),At.a.to(this,{lowpass:t?1:0},.4).start())}playMainTrack(){null==this.soundtrack&&(this.soundtrack=this.group.get("MUSIC_FULL").play(1,!0),this.soundtrack.node.loopStart=14.017,this.soundtrack.node.loopEnd=84.097)}play(t,e=1){this.group.get(t).play(e,!1)}dispose(){var t;this.game.score.onChange.off(this.onScoreChange),null===(t=this.soundtrack)||void 0===t||t.dispose(),this.soundtrack=null,this.masterGain.disconnect(),this.lowpassFilter.disconnect()}}const oi=W.mat4.create(),hi=W.mat4.create(),li=W.vec3.create();class ci{constructor(t){this.fx=t,this.node=new a.a,this.progress=0}release(){this.fx.releaseInstance(this)}reset(){var t;this.progress=0,null===(t=this.node._parent)||void 0===t||t.remove(this.node)}}class ui{constructor(t){this.game=t,this._pool=[],this._instances=[]}createInstance(){let t=this._pool.length>0?this._pool.pop():new ci(this);return this._instances.push(t),t}releaseInstance(t){t.reset();const e=this._instances.indexOf(t);if(-1===e)throw"";this._instances.splice(e,1),this._pool.push(t)}init(){this.renderable=this.game.assets.getRenderable("DotRing"),this.primitive=this.renderable.mesh.primitives[0],this.material=this.renderable.materials[0],this.passInstance=this.material.getPass(U.a.COLOR),this.pass=this.passInstance.pass}reset(){for(;this._instances.length>0;)this.releaseInstance(this._instances[0])}preRender(){const t=this.game.scene.dt/.7;for(let e=this._instances.length-1;e>-1;e--){this._instances[e].progress+=t}}render(t){if(0==this._instances.length)return;if(t.pass!==U.a.COLOR)return;const e=this.material,s=this.game.scene.glstate;if(0==(this.material.mask&t.mask))return;if(0==(this.pass.mask&t.mask))return;this.passInstance.prepare(this._instances[0].node,t.camera),s.push(this.pass.glconfig),e.glconfig&&s.push(e.glconfig),this.renderable.glconfig&&s.push(this.renderable.glconfig),t.cfg&&s.push(t.cfg),s.apply();const i=this.passInstance.getProgram();this.primitive.bindVao(i);for(const e of this._instances){const s=Math.pow(e.progress,.5);li[0]=li[1]=li[2]=.8+.3*s,W.mat4.scale(oi,e.node._wmatrix,li),i.uMVP&&(t.camera.modelViewProjectionMatrix(hi,oi),i.uMVP(hi)),i.uWorldMatrix&&i.uWorldMatrix(oi),i.uDotRingProgress(1-s),this.primitive.render()}this.primitive.unbindVao(),s.pop(),e.glconfig&&s.pop(),this.renderable.glconfig&&s.pop(),t.cfg&&s.pop()}}class di{constructor(){this.top=W.vec3.create(),this.bottom=W.vec3.create()}}var gi=s(394),mi=s.n(gi),pi=s(395),fi=s.n(pi);class vi{constructor(t){this.game=t,this.gradient=new di;const e=t.scene.gl;this.prg=new h.a(e,fi()(),mi()()),this.glcfg=t.scene.glstate.config().enableDepthTest().depthFunc(e.LEQUAL),this.gradient.top.set(this.game.theme.matteColor),this.gradient.bottom.set(this.game.theme.matteColorLight)}render(){this.glcfg.apply(),this.prg.use(),this.prg.uColor1(this.gradient.top),this.prg.uColor2(this.gradient.bottom),this.game.scene.quad.attribPointer(this.prg),this.game.scene.quad.render()}}var _i=s(91),bi=s(41),xi=s(396),wi=s.n(xi),Ci=s(397),Ti=s.n(Ci);const Pi=W.mat4.create(),Si=new Float32Array(Pi.buffer,48,3),Ei=W.mat4.create(),yi=W.vec3.create(),Mi=W.vec3.create(),Fi=W.vec3.fromValues(0,1,0);W.vec3.fromValues(1,0,0);class Ri{constructor(t){this.dir=W.vec3.create(),W.vec3.normalize(this.dir,t)}}class Ai{constructor(t){this.game=t,this.instances=[];const e=t.scene.gl;for(let t=0;t<8;t++)Mi[0]=1&t?-1:1,Mi[1]=2&t?-1:1,Mi[2]=4&t?-1:1,W.vec3.rotateY(Mi,Mi,yi,-.3),W.vec3.rotateX(Mi,Mi,yi,.6),this.instances.push(new Ri(Mi));this.prg=new h.a(e,wi()(),Ti()()),this.glcfg=this.game.scene.glstate.config(),this.glcfg.enableBlend().blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA).enableDepthTest(),this.tex=new y.a(e,e.LUMINANCE,e.UNSIGNED_BYTE);const s=new Uint8Array(256);for(let t=0;t<16;t++)for(let e=0;e<16;e++){const i=1-t/15,r=1-e/15,a=Math.sqrt(i*i+r*r);s[16*t+e]=255*Object(n.d)(10*(1-a))}this.tex.fromData(16,16,s),this.tex.setFilter(!0,!1,!1),this.tex.mirror()}async load(){const t=this.game.scene.mainCTS,e=Object(_i.b)(t.signal),s=await Object(C.c)(T.a.asset_url("game-1/HexGrid.bin"),this.game.scene.resources,{signal:e});if(t.signal.aborted)return;const i=new Float32Array(s),n=i.length,r=new Float32Array(3*n);for(let t=0;t<n;t++)r[3*t+0]=i[2*t+0],r[3*t+1]=i[2*t+1],r[3*t+2]=Math.random()*Math.PI*2;const a=this.game.scene.gl;this.vBuffer=new bi.a(a,r),this.vBuffer.attrib("aData",3,a.FLOAT)}render(t){const e=t.camera,s=Date.now()/3e3%1;this.prg.use(),this.prg.uTex(this.tex),this.prg.uTime(s*Math.PI*2),this.vBuffer.attribPointer(this.prg),this.glcfg.apply(),Ei.set(this.game.track.playerInvMatrix),Ei[12]=0,Ei[13]=0,Ei[14]=0;for(const t of this.instances)Rt(Pi,yi,t.dir,Fi),W.vec3.scaleAndAdd(Si,e._wposition,t.dir,30),W.mat4.mul(Pi,Ei,Pi),e.modelViewProjectionMatrix(Pi,Pi),this.prg.uMVP(Pi),this.vBuffer.drawPoints()}}class Li{constructor(t){this.mainSeed=123456789,this._enableReflectionProbe=!0,this._enableShadows=!0,this.scene=t,this.data=t.data,Li._instance=this,this.theme=new Ht,this.score=new Pe(this),this.audio=new ai(this),this.fog=new gs(this),this.assets=new ue(this),this.track=new Ct(this),this.camCtrl=new Wt(this),this.entities=new Je(this),this.player=new xs(this),this.controls=new Ts(this),this.ptrail=new As(this),this.peffects=new Ns(this),this.rprobe=new ks(this),this.scorequad=new Hs(this),this.reflect=new Zs(this),this.quality=new ii(this),this.dotRings=new ui(this),this.background=new vi(this),this.hexgrids=new Ai(this),this.camera.add(t.devCamera)}static get scene(){return Li._instance.scene}static get resources(){return Li._instance.scene.resources}static get glResources(){return Li._instance.scene.gltfs}static get inputs(){return Li._instance.scene.inputs}get camera(){return this.camCtrl.camera}set enableReflectionProbe(t){this._enableReflectionProbe!=t&&(this._enableReflectionProbe=t,this.assets.enableReflectionProbeChanged())}get enableReflectionProbe(){return this._enableReflectionProbe}async init(){await Promise.all([this.assets.load(),this.audio.load(),this.hexgrids.load()]),this.rprobe.baseIbl=this.scene.iblMngr.ibl,this.scene.sroot.add(this.rprobe.node),this.rprobe.node.y=.1,this.track.renderer.init(),this.entities.init(),this.player.init(),this.ptrail.init(),this.peffects.init(),this.scorequad.init(),this.dotRings.init()}reset(){this.scene.data.gameState.ended=!1,this.scene.data.gameState.health=4,this.scene.data.gameState.score=0,this.scene.timescale=1,this.scene.postfx.saturation.amount=1,this.score.reset(),this.track.reset(),this.entities.reset(),this.player.reset(),this.camCtrl.reset(),this.ptrail.reset(),this.peffects.reset(),this.dotRings.reset(),this.quality.startAutoLevel(this.scene.mainCTS),this.playIntro()}playIntro(){this.camCtrl.introProgress=0,At.a.to(this.camCtrl,{introProgress:1},3.5).ease(Os.easeOutQuad).start(),this.fog.params.fogStart=0,this.fog.params.fogEnd=0,At.a.to(this.fog.params,{fogStart:8,fogEnd:20},3).start(),setTimeout(()=>this.audio.playMainTrack(),800)}gameOver(){this.audio.play(ni.BALL_DEATH),At.a.to(this.scene,{timescale:0},1).start(),At.a.to(this.scene.postfx.saturation,{amount:0},1).start().onComplete(()=>{this.scene.data.gameState.ended=!0})}restart(){this.reset()}preRender(){this.track.preRender(),this.camCtrl.preRender(),this.entities.preRender(),this.controls.preRender(),this.player.preRender(),this.peffects.preRender(),this.scorequad.preRender(),this.dotRings.preRender()}rtt(){this.reflect.render(),this.enableReflectionProbe&&this.rprobe.render()}graphUpdated(){this.track.graphUpdate(),this.entities.updateInstances(),this.ptrail.graphUpdate(),this.rprobe.node.position.set(this.player.sphereNode._wposition),this.rprobe.node.invalidate()}render(t){this.track.renderer.render(t),this.player.render(t),this.entities.renderTrackEntities(t),this.entities.renderTowers(t),this.ptrail.render(t),this.scorequad.render(t)}renderAll(t){const e={camera:t,mask:G.a.OPAQUE,pass:U.a.COLOR},s={camera:t,mask:G.a.BLENDED,pass:U.a.COLOR},i={camera:t,mask:G.a.SHADOWS,pass:U.a.COLOR};this.track.render(e),this._enableShadows&&(this.entities.renderTrackEntities(i),this.player.renderShadow(i)),this.entities.renderTowers(e),this.background.render(),this.hexgrids.render(s),this.track.render(s),this.entities.renderTrackEntities(e),this.player.render(e),this.ptrail.render(e),this.scorequad.render(e),this.entities.renderTrackEntities(s),this.dotRings.render(s)}loseLife(){this.player.hit()&&(this.audio.play(ni.BALL_CRASH),this.peffects.shock(),this.camCtrl.shake(),this.data.gameState.health--,0==this.data.gameState.health&&this.gameOver())}gainLife(){this.audio.play(ni.COLLECT_BOTTLE),this.peffects.shine(),this.data.gameState.health=Math.min(this.data.gameState.health+1,this.data.gameState.maxhealth)}speedup(){this.peffects.shine(),this.audio.play(ni.ARROW_BOOSTER),this.player.speedup()}dispose(){this.controls.dispose(),this.score.dispose(),this.audio.dispose()}}var Di=s(241),Ii=s(246),ki=s(514),Oi=s(6),Bi=s(243),Ni=s(279),Gi=s(222),Ui=s(400),zi=s.n(Ui),Wi=s(401),Hi=s.n(Wi);const Vi=new Uint8Array(9);Vi[0]=255,Vi[4]=255,Vi[8]=255;class Xi extends Gi.b{constructor(){super(),this.adjust=.42,this._flags|=Gi.a.LINEAR,this._code=zi()(),this._preCode=Hi()(),this._rgbTex=null,this.amount=.015}init(){var t=this.post.gl;this._rgbTex=new y.a(t,t.RGB),this._rgbTex.fromData(3,1,Vi),this._rgbTex.clamp(),this._rgbTex.setFilter(!0,!1,!1)}release(){this._rgbTex.dispose(),this._rgbTex=null}preRender(){}genCode(t,e){t.push(this._preCode),e.push(this._code)}setupProgram(t){t.tChromaShiftTex&&t.tChromaShiftTex(this._rgbTex),t.uAmount(this.amount)}resize(){}}var qi=s(402),Yi=s.n(qi),ji=s(403),Ki=s.n(ji),Qi=s(17);class Zi extends Qi.b{constructor(t,e,s,i){super(t,e,s,i),this.textureType=3553,this._target=3553,t.bindTexture(3553,this.id),this.setFilter(!0)}fromImage(t){const e=this.gl;this.width=t.width,this.height=t.height,e.bindTexture(3553,this.id),e.texImage2D(3553,0,this.internal,this.format,this.type,t)}fromData(t,e,s=null){const i=this.gl;this.width=t,this.height=e,s=s||null,i.bindTexture(3553,this.id),i.texImage2D(3553,0,this.internal,t,e,0,this.format,this.type,s)}}let $i;class Ji extends Gi.b{constructor(t,e){super(),this.amount=t,this.sharpness=e,this._noiseTex=null,this._preCode=Yi()(),this._code=Ki()()}genCode(t,e){t.push(this._preCode),e.push(this._code)}init(){var t=this.post.gl;this._noiseTex=new Zi(t,t.LUMINANCE),this._noiseTex.fromData(128,128,function(){if(void 0===$i){$i=new Uint8Array(16384);for(var t=0;16384>t;t++)$i[t]=128*(Math.random()+Math.random())}return $i}())}release(){null!==this._noiseTex&&this._noiseTex.dispose(),this._noiseTex=null}setupProgram(t){const e=this.amount,s=1/128,i=this.post.bufferWidth,n=this.post.bufferHeight,r=1-this.sharpness;t.uGrainCoord(s*i,s*n,.5*r*s,.5*r*s),t.uGrainScaleBias(2*e,-e),t.tGrain(this._noiseTex)}preRender(){}resize(t,e){}}class tn{constructor(t){this.postProcess=t,this.prgCache={},this._stackInvalid=!0,this._enableChromashift=!0,this._enableGrain=!0,this.postProcess.enabled=!0;const e=new Bi.a;e.scatter=.75,e.clamp=20,e.threshold=1.2;e.color.set([10,10,10]),this.bloom=e,this.saturation=new Ni.a(0),this.chromaShift=new Xi,this.chromaShift.amount=.015,this.grain=new Ji(.25,0),this.buildCache()}cacheStore(){const t=this.postProcess.scene.gl,e=`${this.enableGrain}-${this.enableChromashift}`;this.postProcess.post.prg=new h.a(t),this.postProcess.post.buildProgram(),this.prgCache[e]=this.postProcess.post.prg,console.log("set",e,this.prgCache[e])}cacheGet(){const t=`${this.enableGrain}-${this.enableChromashift}`;console.log("get",t,this.prgCache[t]),this.postProcess.post.prg=this.prgCache[t],this.postProcess.post._shaderInvalid=!1}set enableChromashift(t){this._enableChromashift!==t&&(this._enableChromashift=t,this._stackInvalid=!0)}get enableChromashift(){return this._enableChromashift}set enableGrain(t){this._enableGrain!==t&&(this._enableGrain=t,this._stackInvalid=!0)}get enableGrain(){return this._enableGrain}buildCache(){for(let t=0;t<4;t++)this.enableChromashift=0!=(1&t),this.enableGrain=0!=(2&t),this._updateStack(),this.cacheStore()}preRender(){this._stackInvalid&&(this._updateStack(),this.cacheGet())}_updateStack(){this.postProcess.post.remove(this.grain),this.postProcess.post.remove(this.bloom),this.postProcess.post.remove(this.chromaShift),this.postProcess.post.remove(this.saturation);const t=this.enableChromashift?10:4.5;this.bloom.color.set([t,t,t]);const e=this.enableChromashift?.32:.1;this.grain.amount=e,this.enableGrain&&this.postProcess.post.add(this.grain),this.postProcess.post.add(this.bloom),this.enableChromashift&&this.postProcess.post.add(this.chromaShift),this.postProcess.post.add(this.saturation),this._stackInvalid=!1}}class en{constructor(t,e,s){this.enableFxaa=!0,this.timescale=1,this.maxDpr=2,this._isRendering=!1,this.onRenderingChange=new Te.a,this.preCompileMats=()=>(this.iblMngr.lights.setup.prepare(this.gl),this.matlib.compileAllAsync()),this.onLoaded=()=>{this.loaded=!0},this.data=t,this.resources=e,this.audioResources=s,this.dt=0,this.time=0,this.ratio=1,this.ilayer=null,this.loaded=!1,this.paused=!1,this.entered=!1}attachResources(t){}enter(){this.game.reset(),this.entered=!0}leave(){this.entered=!1}init(t){this.mainCTS=new ki.a,this.loaddefer=new _.a,this.glview=t,this.gl=this.glview.gl,this.devCamera=this.makeDevCamera(),this.cmnTexs=new b.a("cmn",this.gl,this.resources),this.gltfs=new Di.a("gltfs",this.gl,this.resources),this.sroot=new a.a,this.root=new a.a,this.glstate=new r.a(this.gl),this.quad=new o.a(this.gl),this.inputs=new O.a(this.ilayer),this.postProcess=new N.a(this,"games"),this.postfx=new tn(this.postProcess),this.postProcess.enabled=!1,this.matlib=new x.a(this),this.iblMngr=new A(this),this.raycaster=new B.a(this),this.fxaa=new Ii.a(this.gl),this.programs=new v(this),this.envRotation=0,this.camCtrl=new I.a(this,this.devCamera),this.maxcam=new k.a(this.glview.canvas),this.maxcam.orbitRadius=-1,this.root.add(this.devCamera),this.sroot.add(this.root),this.game=new Li(this),this.inputs.start(),this.game.init(),this.iblMngr.load("envs/Game1_HDRI")}get camera(){return this.useDebugCam?this.devCamera:this.game.camera}handleResize(){}get shouldRender(){return this.loaded&&!this.paused&&!Oi.c.store.menuOpen&&this.entered}get isRendering(){return this._isRendering}render(t){const e=this.shouldRender;this._isRendering!=e&&(this.onRenderingChange.emit(e),this._isRendering=e),this.game.audio.update(),e&&(t*=this.timescale,this.dt=t,this.time+=t,this.drawScene(this.camera))}drawScene(t,e=null,s=!1){const i=Math.min(this.maxDpr,window.devicePixelRatio),n=this.gl,r=e?e.width:this.glview.width,a=e?e.height:this.glview.height;let o,h;this.postProcess.enabled?(o=e?e.width:this.glview.canvasWidth*i,h=e?e.height:this.glview.canvasHeight*i):(o=r,h=a),this.renderWidth=o,this.renderHeight=h,this.ratio=o/h,this.game.preRender(),this.camCtrl.preRender(),this.iblMngr.preRender(),this.postfx.preRender(),this.root.rotation.set([0,0,0,1]),this.root.rotateY(this.envRotation),this.sroot.updateWorldMatrix(),this.game.graphUpdated(),t.updateViewProjectionMatrix(o,h),this.iblMngr.lights.setup.prepare(n),this.renderLightmaps(),this.game.rtt();const l=this.game.theme.matteColor;n.clearColor(l[0],l[1],l[2],1),this.fxaa.resize(o,h),this.postProcess.preRender(o,h),this.postProcess.bindColor(),this.game.renderAll(t),this.glstate.apply(),this.enableFxaa?(this.postProcess.render(this.fxaa.fbo),n.bindFramebuffer(n.FRAMEBUFFER,null),n.viewport(0,0,r,a),this.fxaa.render()):(n.viewport(0,0,r,a),this.postProcess.render(void 0,r,a))}renderLightmaps(){this.glstate.apply()}async load(){}makeDevCamera(){const t=new L.a(new D.a);return t.lens.setAutoFov(45*n.a),t.lens.near=.1,t.lens.far=100,t.setMatrix(new Float32Array([.9912574887275696,3.6239293788042914e-9,.1319413185119629,0,.05478726327419281,.9097120761871338,-.4116094410419464,0,-.12002861499786377,.4152396321296692,.9017588496208191,0,-.014462031424045563,.4048766493797302,-1.272156834602356,1])),t}async dispose(){var t,e,s,i,n,r,a;null===(t=this.mainCTS)||void 0===t||t.abort(),this.mainCTS=null,null===(e=this.programs)||void 0===e||e.dispose(),null===(s=this.camCtrl)||void 0===s||s.setControler(null),null===(i=this.inputs)||void 0===i||i.release(),null===(n=this.raycaster)||void 0===n||n.dispose(),null===(r=this.matlib)||void 0===r||r.dispose(),null===(a=this.game)||void 0===a||a.dispose(),this.game=null,this.root._children=null}}var sn=s(83),nn=s(18),rn=s(249),an=s(16),on=s(14),hn=s(103);class ln extends sn.a{constructor(){super(),this.sceneAutoEnter=!1,this.ghostloadedResources=new on.a(this.name+"-ghostload",null),this.data.gameState=Object(rn.d)(new rn.e,new rn.c,new rn.a,{maxhealth:4}),this.data.gameState.gameId=Oi.a.GAME_1,this.name="Game 1"}init(t){super.init(t),this._scene=new en(this.data,this.resources,this.audioResources);let e=window.innerWidth>=768?"desktop":"mobile";new nn.a("game-preview",s(125)("./bg-stars-"+e+".jpg"),this.preloadedResources),new nn.a("game-logo",s(404),this.preloadedResources),new nn.a("poster-rule1",s(405),this.preloadedResources),new nn.a("poster-rule2",s(406),this.preloadedResources),new nn.a("poster-rule3",s(407),this.preloadedResources),new nn.a("share-push",s(126),this.resources),new nn.a("share-product",s(250),this.resources),new nn.a("share-game",s(408)("./share-challenge-game-1-"+e+".png"),this.resources),new nn.a("share-game-canvas",s(411),this.resources),new nn.a("game-thumbnail-1",s(121),this.resources),new nn.a("game-thumbnail-2",s(122),this.resources),new nn.a("game-thumbnail-3",s(123),this.resources),new nn.a("game-thumbnail-4",s(124),this.resources),new ri.a("INSIDE_PORTAL_MAIN_LOOP","main/INSIDE_PORTAL_MAIN_LOOP",this.audioResources),this.loadPraise()}async loadPraise(){const t=await Object(hn.a)()?"webp":"png";let e=1;for(let s=1;s<4;s++){for(let i=1;i<38;i++){let n="000000"+e;n=n.slice(n.length-3,n.length),new nn.a(`praise-${s}-${i}`,`/assets/img/game-1/C${s}/${n}.${t}`,this.ghostloadedResources),e++}e++}}restart(){this._scene.game.restart()}onLoaded(){this.ghostloadedResources.load(),this.ghostloadedResources.whenAllLoadables().then(()=>this.onGhostloadComplete()),this.playIntroGameLoop()}onGhostloadComplete(){this._vm.onGhostloadComplete()}playIntroGameLoop(){this.gameMusicLoop=this.audioResources.get("INSIDE_PORTAL_MAIN_LOOP").play(1,!0),this.gameMusicLoop.node.loopStart=1,this.gameMusicLoop.node.loopEnd=11}stopIntroGameLoop(){an.a.to(this.gameMusicLoop.gain.gain,{duration:1,value:0,onComplete:()=>{this.gameMusicLoop.dispose(),this.gameMusicLoop=null}})}async leave(){let t=null;return this.gameMusicLoop&&(t=new Promise(t=>{an.a.to(this.gameMusicLoop.gain.gain,{duration:1,value:0,onComplete:()=>{t()}})})),Promise.all([t,super.leave()]).then(()=>{this.dispose()})}dispose(){var t;null===(t=this.gameMusicLoop)||void 0===t||t.dispose(),this.gameMusicLoop=null}}var cn=s(39),un=s(84),dn=s(251),gn=s(252),mn=s(254),pn=s(253),fn=s(255);const vn=Object(un.a)(ln);var _n={_module:vn,mixins:[vn,cn.a,dn.a],components:{Scoreboard:gn.a,ScoreUi:mn.a,InstructionsPanel:pn.a,PraiseCvs:fn.a},data:()=>({isGhostLoaded:!1,isLoaded:!1,isStarted:!1,instructionActive:!1,finalScore:0,praise:{step:1e3,audioDelay:0}}),watch:{"$data.gameState.ended":"onEnded"},methods:{onGhostloadComplete(){const t=this.getModule().ghostloadedResources;for(let e=1;e<4;e++){const s=[];for(let i=1;i<38;i++)s.push(t.get(`praise-${e}-${i}`));this.$refs.praise.addSprites(s)}this.isGhostLoaded=!0},onPraiseRequest(){this.isGhostLoaded&&this.$refs.praise.play()},onPraiseAudioRequest(){this.getModule().getScene().game.audio.play(ni.HYPE_WORDS)}}},bn=s(5),xn=Object(bn.a)(_n,i,[],!1,null,null,null);xn.options.__file="src/modules/game1/Game1.vue";e.default=xn.exports}}]);